---
title: "Evacuation Risks in Vermont"
author: "Marcos Luna and Neenah Estrella-Luna"
date: "4/3/2020"
output: 
  bookdown::pdf_document2:
    toc: true
    toc_depth: 3
    number_sections: true
    fig_caption: yes        
    includes:  
      in_header: my_header.tex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
\pagebreak
# Analysis of evacuation-related risks in Vermont

This is an analysis of flood evacuation risks for populations of concern in Vermont. In the event of significant inland flooding, evacuation may be required. For individuals and households with limited mobility, either due to inadequate access to transportation options or because of physical limitations, evacuation presents heightened risk. Evacuation may also prove especially difficult for individuals and households due to limited economic resources, difficulty understanding or accessing information, or low trust in official sources of information. 

## Analysis of Flood Hazard Exposure in Vermont

```{r NFHZAdata, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
# Analysis of flooding and hurricane evacuation risks for populations of concern in Vermont
library(tidyverse)
library(sf)
library(tmap)
library(tmaptools)
library(lwgeom)
library(tigris)
options(tigris_use_cache = TRUE, tigris_class = "sf")

load("DATA/ne_layers.rds")

# Extract state census units and convert to projected local CRS EPSG:2852: NAD83(HARN) / Vermont See https://spatialreference.org/ref/epsg/2852/
vt_blkgrp_2852 <- ne_blkgrp_sf %>% 
  filter(STATE == "Vermont") %>% 
  st_transform(., crs = 2852)

vt_tracts_2852 <- ne_tracts_sf %>% 
  filter(STATE == "Vermont") %>% 
  st_transform(., crs = 2852)

# Get rid of empty geometries
empty_geo <- st_is_empty(vt_blkgrp_2852)
vt_blkgrp_2852 <- vt_blkgrp_2852[!empty_geo,]
empty_geo <- st_is_empty(vt_tracts_2852)
vt_tracts_2852 <- vt_tracts_2852[!empty_geo,]

# Extract state boundary
vt_state_sf <- ne_states_sf_cb %>% 
  filter(NAME == "Vermont") %>% 
  st_transform(., crs = 2852)

#### Processing in ArcGIS #####
# # Write out block groups for processing in ArcGIS
# vt_blkgrp_2852 %>%
#   dplyr::select(GEOID) %>%
#   st_write(., "DATA/FEMA/VT/vt_blkgrp_2852.shp", delete_layer = TRUE)
# #
# # repeat for tracts
# vt_tracts_2852 %>%
#   dplyr::select(GEOID) %>%
#   st_write(., "DATA/FEMA/VT/vt_tracts_2852.shp", delete_layer = TRUE)
# 
# # repeat for state boundary
# vt_state_sf %>%
#   st_write(., "DATA/FEMA/VT/vt_state_2852.shp", delete_layer = TRUE)

# Use dasymetric mapping to calculate populations within flood zones. Approach follows method used by Qiang (2019) to eliminate unpopulated areas of census polygons and then reallocate populations to developed areas as identified in National Land Cover Dataset (NLCD). 
# Perform NLCD raster-to-vector conversion, vector erase/difference, and vector intersections in ArcMap because it takes too long in R. 
# In ArcMap:
# Convert NLCD raster to shapefile. Clip to state.
# Isolate undeveloped areas (gridcode NOT 22 - 24). 
# Erase areas of vt_blkgrp_2852 and vt_tracts_2852 that overlap with undeveloped areas in NLCD shapefiles. Compute OldArea of erased polygons in sqm to identify area of developed polygons remaining. 
# Intersect erased vt_blkgrps and erased vt_tracts with NFHZA and Hurricane evacuation zones. Read back into R.

##### Return to working in R ######
# # read in processed vt_blkgrps and vt_tracts
# st_layers(dsn = "DATA/FEMA/VT")

vt_blkgrps_developed <- st_read(dsn = "DATA/FEMA/VT",
                                layer = "vt_blkgrps_developed") %>% 
  left_join(., as.data.frame(vt_blkgrp_2852), by = "GEOID") %>% 
  st_transform(., crs = 2852) %>% 
  mutate(NewArea = st_area(.)) %>%
  st_make_valid() %>% 
  mutate(Proportion = as.numeric(NewArea/OldArea),
         NewPop = totalpopE*Proportion,
         NewMinority = minorityE*Proportion,
         NewUnder5 = under5E*Proportion,
         NewOver64 = over64E*Proportion,
         NewUnder18 = under18E*Proportion,
         NewEng_limit = eng_limitE*Proportion,
         NewPov = num2povE*Proportion,
         NewLths = lthsE*Proportion)

vt_blkgrps_nfhza <- st_read(dsn = "DATA/FEMA/VT", 
                            layer = "vt_blkgrps_nfhza") %>% 
  left_join(., as.data.frame(vt_blkgrp_2852), by = "GEOID") %>% 
  st_transform(., crs = 2852) %>% 
  mutate(NewArea = st_area(.)) %>%
  st_make_valid()

vt_tracts_nfhza <- st_read(dsn = "DATA/FEMA/VT", 
                           layer = "vt_tracts_nfhza") %>% 
  left_join(., as.data.frame(vt_tracts_2852), by = "GEOID") %>% 
  st_transform(., crs = 2852) %>% 
  mutate(NewArea = st_area(.)) %>%
  st_make_valid()

# get rid of empty geometries
empty_geo <- st_is_empty(vt_blkgrps_nfhza)
vt_blkgrps_nfhza <- vt_blkgrps_nfhza[!empty_geo,]
empty_geo <- st_is_empty(vt_tracts_nfhza)
vt_tracts_nfhza <- vt_tracts_nfhza[!empty_geo,]

# Apportion populations based on geographic proportion of intersect
vt_blkgrps_nfhza <- vt_blkgrps_nfhza %>%
  mutate(Proportion = as.numeric(NewArea/OldArea),
         NewPop = totalpopE*Proportion,
         NewMinority = minorityE*Proportion,
         NewUnder5 = under5E*Proportion,
         NewOver64 = over64E*Proportion,
         NewUnder18 = under18E*Proportion,
         NewEng_limit = eng_limitE*Proportion,
         NewPov = num2povE*Proportion,
         NewLths = lthsE*Proportion)

vt_tracts_nfhza <- vt_tracts_nfhza %>%
  mutate(Proportion = as.numeric(NewArea/OldArea),
         NewDisabled = disabledOver18E*Proportion,
         NewNoCar = HHnoCarE*Proportion)

# Compute total block group populations within flood zones
vt_flood_blkgrp_df <- vt_blkgrps_nfhza %>%
  as.data.frame() %>%
  summarize(`Total Pop` = as.integer(sum(NewPop)),
            Minority = as.integer(sum(NewMinority)),
            `Under 5` = as.integer(sum(NewUnder5)),
            `Over 64` = as.integer(sum(NewOver64)),
            `Under 18` = as.integer(sum(NewUnder18)),
            `Limited English HH` = as.integer(sum(NewEng_limit)),
            `Low Income` = as.integer(sum(NewPov)),
            `No HS Dip` = as.integer(sum(NewLths))) %>%
  gather(key = Group, value = FloodPop)

vt_flood_tracts_df <- vt_tracts_nfhza %>%
  as.data.frame() %>%
  summarize(`Disabled` = as.integer(sum(NewDisabled)),
            `No Car HH` = as.integer(sum(NewNoCar))) %>%
  gather(key = Group, value = FloodPop)

# Compute total tract populations within the state for same groups
vt_tract_flood_pops_df <- vt_tracts_2852 %>%
  as.data.frame() %>%
  summarize(`Disabled` = sum(disabledOver18E),
            `No Car HH` = sum(HHnoCarE)) %>%
  gather(key = Group, value = VTPop) %>%
  left_join(.,vt_flood_tracts_df, by = "Group")

# Compute populations for state,and join with flood pops
vt_FloodPops_df <- vt_blkgrp_2852 %>%
  as.data.frame() %>%
  summarize(`Total Pop` = sum(totalpopE),
            Minority = sum(minorityE),
            `Under 5` = sum(under5E),
            `Over 64` = sum(over64E),
            `Under 18` = sum(under18E),
            `Limited English HH` = sum(eng_limitE),
            `Low Income` = sum(num2povE),
            `No HS Dip` = sum(lthsE)) %>%
  gather(key = Group, value = VTPop) %>%
  left_join(., vt_flood_blkgrp_df, by = "Group") %>%
  rbind(.,vt_tract_flood_pops_df) %>%
  mutate(PctFlood = FloodPop/VTPop*100)
```

In comparison to other part's of New England, relatively little of Vermont's land area is within flood zones. However, a significant proportion of the population are nevertheless exposed to the risk of flooding from overbanking of inland water bodies (e.g., ponds and rivers). 

The analysis of flood exposure presented here is based on the Federal Emergency Management Agency's (FEMA) National Flood Hazard Layer (NFHL), a digital version of FEMA's most recent flood maps.  FEMA identifies areas subject to varying levels of flood risk through its Flood Insurance Rate Maps (FIRMs), which are produced for most parts of the country to identify areas subject to flooding. FEMA's FIRMs are a national standard used by all federal agencies for the purposes of requiring and rating the purchase of flood insurance and regulating new development.  Population data comes from the American Community Survey (ACS) 2017 5-year estimates at the census tract and block group levels. 

A significant proportion of Vermont's population lives near inland water bodies. As a result, a significant proportion of the population lives near or within known flood zones. Figure \@ref(fig:mapNFHZAPop) below shows the population distribution and areas subject to floods with an Annual Exceedance Probability (AEP) of 1% (also known as a '100-year' flood) and areas subject to 0.2% AEP (also known as a '500-year' flood). Areas within the 1% AEP flood zone are designated by FEMA as Special Flood Hazard Areas, and development within those zones must be covered by flood insurance. Areas within the 0.2% AEP are not currently regulated, but these areas are nevertheless subject to flood risk under more extreme, albeit less frequent, flooding circumstances. Coastal areas within the 0.2% AEP zone are a reasonable proxy measure for the risks of sea level rise. Note that portions of northwest and northeast Vermont are not currently mapped for flooding risk by FEMA. 
```{r mapNFHZAdata, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
# Process data for mapping 
# Create point layer of major cities for context
# Note cb=FALSE is necessary for extracting centroids from town polygons. Otherwise, if cb=TRUE, cannot extract centroids from multipolygon features.
# Read in NFHL for VT. Data comes from FEMA. 
# List available layers in geodatabase
# st_layers("DATA/FEMA/VT/NFHL_50_20161207.gdb")
# Read in flood hazard areas
vt_nfhza_2852 <- st_read(dsn = "DATA/FEMA/VT/NFHL_50_20161207.gdb", layer = "S_Fld_Haz_Ar", quiet = TRUE) %>%
  filter(!FLD_ZONE %in% c("OPEN WATER","AREA NOT INCLUDED","D") &
           !ZONE_SUBTY %in% c("AREA OF MINIMAL FLOOD HAZARD",
                              "AREA WITH REDUCED FLOOD RISK DUE TO LEVEE")) %>%
  mutate(FLD_ZONE = as.character(FLD_ZONE)) %>% # omit unused factor levels
  st_transform(., crs = 2852) %>%
  st_make_valid() %>%
  group_by(FLD_ZONE) %>% # aggregate flood zone polygons
  summarize(count = n()) %>%
  mutate(Area = st_area(.),
         Interval = case_when(
           FLD_ZONE  == "A" ~ "100-year",
           FLD_ZONE  == "AE" ~ "100-year",
           FLD_ZONE  == "AH" ~ "100-year",
           FLD_ZONE  == "AO" ~ "100-year",
           FLD_ZONE  == "VE" ~ "100-year",
           FLD_ZONE == "X" ~ "500-year"))

# get rid of empty geometries
empty_geo <- st_is_empty(vt_nfhza_2852)
vt_nfhza_2852 <- vt_nfhza_2852[!empty_geo,]

# # save this layer to save time
# saveRDS(vt_nfhza_2852,"DATA/FEMA/VT/vt_nfhza_2852.Rds")
# # load previously process flood layer
# vt_nfhza_2852 <- readRDS("DATA/FEMA/VT/vt_nfhza_2852.Rds")


# download Census TIGERLine hydrography for VT
# # First, extract list of county names to use with tigris::water
# vt_counties <- counties("VT") %>%
#   pull(NAME)
# # Next, download water features for each county and rbind to one layer
# vt_awater_sf <- rbind_tigris(
#   lapply(
#     vt_counties, function(x) area_water(state = "VT", county = x)
#   )
# ) %>%
#   st_union() %>%
#   st_as_sf() %>%
#   st_transform(., crs = 2852)
# 
# # save time by loading file
# saveRDS(vt_awater_sf, "DATA/FEMA/VT/vt_awater_sf.Rds")
# load water features
vt_awater_sf <- readRDS("DATA/FEMA/VT/vt_awater_sf.Rds")

# # crop flood zones to land areas only
# start_time <- Sys.time()
# vt_nfhza_2852_land <- vt_nfhza_2852 %>%
#   crop_shape(., vt_state_sf, polygon = TRUE) %>%
#   st_difference(., vt_awater_sf) %>%
#   mutate(Area = st_area(.)) %>%
#   st_make_valid() # takes about 1.5 hours
# end_time <- Sys.time()
# end_time - start_time
# # save time by just loading file
# saveRDS(vt_nfhza_2852_land, file = "DATA/FEMA/VT/vt_nfhza_2852_land.Rds")
# load cropped flood zones
vt_nfhza_2852_land <- readRDS("DATA/FEMA/VT/vt_nfhza_2852_land.Rds")

# Create a dot density map of total populations and overlay on flood zones
# Create point layer of major cities for context
# Note cb=FALSE is necessary for extracting centroids from town polygons. Otherwise, if cb=TRUE, cannot extract centroids from multipolygon features.
vt_towns_sf_pts <- county_subdivisions(state = "VT", cb = TRUE) %>% 
  filter(NAME %in% c("Brattleboro",
                     "Manchester",
                     "Rutland",
                     "Middlebury",
                     "Montpelier",
                     "Burlington",
                     "Stowe",
                     "Greensboro"),
         GEOID != "5002161225") %>% # remove duplicate Rutland point
  st_transform(., crs = 2852) %>% 
  st_centroid(of_largest_polygon = TRUE)

# Create road layer for context
vt_highways <- primary_roads() %>% 
  filter(FULLNAME %in% c("I- 89","I- 91","I- 93")) %>%
  tmaptools::crop_shape(., ne_states_sf_cb) %>% 
  st_transform(., crs = 2852)

vt_highways2nd <- primary_secondary_roads("VT") %>% 
  filter(FULLNAME %in% c("US Hwy 2","US Hwy 4","US Hwy 5","US Hwy 7")) %>%
  st_transform(., crs = 2852)

# Extract highway segments for labeling
I89roadSegment <- vt_highways %>% 
  filter(LINEARID == "110492460319")

I91roadSegment <- vt_highways %>% 
  filter(LINEARID == "110344465713")

I91roadSegment2 <- vt_highways %>% 
  filter(LINEARID == "1103059124170")

I93roadSegment <- vt_highways %>% 
  filter(LINEARID == "1105281295268")

USHwy2Segment <- vt_highways %>% 
  filter(LINEARID == "1105317260813")

USHwy4Segment <- vt_highways %>% 
  filter(LINEARID == "1104258038927")

USHwy7Segment <- vt_highways %>% 
  filter(LINEARID == "1106087319624")

# Create custom icons of highway shields
I89 <- tmap_icons(file = "https://upload.wikimedia.org/wikipedia/commons/thumb/f/f4/I-89.svg/200px-I-89.svg.png")
I91 <- tmap_icons("https://upload.wikimedia.org/wikipedia/commons/thumb/9/90/I-91.svg/200px-I-91.svg.png")
I93 <- tmap_icons("https://upload.wikimedia.org/wikipedia/commons/thumb/0/0d/I-93.svg/200px-I-93.svg.png")
Hwy2 <- tmap_icons("https://upload.wikimedia.org/wikipedia/commons/thumb/2/27/US_2.svg/200px-US_2.svg.png")
Hwy4 <- tmap_icons("https://upload.wikimedia.org/wikipedia/commons/thumb/7/71/US_4.svg/200px-US_4.svg.png")
Hwy7 <- tmap_icons("https://upload.wikimedia.org/wikipedia/commons/thumb/9/95/US_7.svg/200px-US_7.svg.png")

# Bring in outline of New York for western boundary
ny_state_sf <- tigris::states(cb = TRUE) %>% 
  filter(NAME == "New York")

# # Create polygons to show where there are no FEMA maps
# start_time <- Sys.time()
# nofemapolys <- st_read(dsn = "DATA/FEMA/VT/NFHL_50_20161207.gdb",
#                        layer = "S_FLD_HAZ_AR", quiet = TRUE) %>%
#   filter(FLD_ZONE != "AREA NOT INCLUDED") %>%
#   group_by() %>%
#   summarize() %>% # aggregate all flood zone polygons into one
#   st_transform(., crs = st_crs(vt_state_sf)) %>%
#   st_make_valid() %>%
#   st_difference(vt_state_sf,.) %>% # extract areas with no flood coverage
#   st_cast(., "POLYGON") %>% # disaggregate multipolygon feature
#   mutate(Area = st_area(.),
#          LABEL = "No FEMA\nFlood Data") %>% # calc area of each polygon
#   filter(as.numeric(Area)/10^6 > 1000) # remove polygons < 1000km2
# end_time <- Sys.time()
# end_time - start_time #takes about 9.2mins
# 
# # save time by loading previously processed file
# saveRDS(nofemapolys,"DATA/FEMA/VT/nofemapolys.Rds")
# load data
nofemapolys <- readRDS("DATA/FEMA/VT/nofemapolys.Rds")

# Create random points, with 1 point for every 100 people
vt_totalpop_pts <- vt_blkgrps_developed %>% 
  select(NewPop) %>% 
  filter(NewPop >= 100) %>% 
  st_sample(., size = round(.$NewPop/100)) %>% # create 1 random point for every 100 people
  st_sf(.) %>% 
  group_by() %>% 
  summarize() # reduce to one multipoint object

# Create a simplified version of NFHZA polygons to speed up mapping
# start_time <- Sys.time()
vt_nfhza_2852_land_simple <- vt_nfhza_2852_land %>% 
  select(Interval) %>% 
  st_cast(., "MULTIPOLYGON") %>% # homogenize type
  st_cast(., "POLYGON") %>% 
  st_simplify(., dTolerance = 100) %>% # reduce vertices
  st_make_valid() %>%
  group_by(Interval) %>% 
  summarize() %>% 
  mutate(Area = st_area(.))
# end_time <- Sys.time()
# end_time - start_time

# Create a simplified version of vt_awater_sf to speed up mapping
vt_awater_sf_simple <- vt_awater_sf %>% 
  st_cast(., "MULTIPOLYGON") %>% # homogenize type
  st_cast(., "POLYGON") %>% 
  st_simplify(., dTolerance = 100) %>% # reduce vertices
  st_make_valid() %>%
  group_by() %>% 
  summarize()
```

```{r mapNFHZAPop, echo=FALSE, message=FALSE, warning=FALSE, fig.align = "center", fig.cap="FEMA flood zones and population distribution across Vermont at Census Block Group level."}
# Create a dot density map of total populations and overlay on flood zones
# Map totalpop and flood zones
# tm_layout(bg.color = "#e6f3f7") +
m1 <- tm_shape(vt_blkgrp_2852, unit = "mi") + tm_fill(col = "white") +
  tm_shape(ne_states_sf_cb) + tm_fill(col="white") +
  tm_shape(ny_state_sf) + tm_fill(col="white") +
  tm_shape(vt_awater_sf_simple) + tm_fill(col = "#e6f3f7") + 
  # tm_shape(ne_states_sf_cb) + tm_borders() +
  # tm_shape(ny_state_sf) + tm_borders() +
  tm_shape(vt_totalpop_pts) + tm_dots(col = "darkgoldenrod3",
                                      labels = "1 dot = 100 people",
                                      alpha = 0.6) +
  tm_shape(vt_nfhza_2852_land_simple) + 
  tm_fill(col = "Interval", 
          palette = c("dodgerblue", "blueviolet"), 
          labels = c("1% AEP (100-year)", "0.2% AEP (500-year)"), 
          title = "FEMA Flood Zones",
          alpha = 0.6,
          border.alpha = 0) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) +
  tm_shape(ny_state_sf) + tm_borders(lwd = 0.2, alpha = 0.8) +
  tm_shape(vt_highways) + tm_lines(col = "seashell4", lwd = 1.5) +
  tm_shape(vt_highways2nd) + tm_lines(col = "seashell4", lwd = 1.5) +
  tm_shape(I89roadSegment) + 
  tm_symbols(shape = I89, border.lwd = NA, size = 0.2) +
  tm_shape(I91roadSegment) + 
  tm_symbols(shape = I91, border.lwd = NA, size = 0.2) +
  tm_shape(I91roadSegment2) + 
  tm_symbols(shape = I91, border.lwd = NA, size = 0.2) +
  tm_shape(I93roadSegment) + 
  tm_symbols(shape = I93, border.lwd = NA, size = 0.2) +
  # tm_shape(USHwy2Segment) +
  # tm_symbols(shape = Hwy2, border.lwd = NA, size = 0.2) +
  # tm_shape(USHwy4Segment) +
  # tm_symbols(shape = Hwy4, border.lwd = NA, size = 0.2) +
  # tm_shape(USHwy7Segment) +
  # tm_symbols(shape = Hwy7, border.lwd = NA, size = 0.2) +
  tm_shape(vt_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_shape(nofemapolys) + tm_fill(col = "gray", alpha = 0.4) +
  # tm_text("LABEL", alpha = 0.5) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  tm_add_legend(type = "fill", col = "darkgoldenrod3",
                alpha = 0.6,
                border.col = "white", border.alpha = 0,
                labels = "1 dot = 100 people",
                title = "Total Population") +
  tm_add_legend(type = "fill", col = "gray",
                alpha = 0.4,
                border.col = "white", border.alpha = 0,
                labels = "No FEMA Data",
                title = "FEMA Coverage") +
  tm_layout(title = "Population Distribution \nand Flood Zones", 
            frame = TRUE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m1, "DATA/FEMA/VT/vt_flood.png",
          height = 7, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/FEMA/VT/vt_flood.png")
```

Approximately 1.9% of Vermont's land area falls within FEMA flood zones. The breakdown by type of flood zone is presented in Table \@ref(tab:tabNFHZAarea) below. 

```{r tabNFHZAarea, echo=FALSE, message=FALSE, warning=FALSE, fig.align = "center", fig.cap="Vermont Land Area within Flood Zones."}
# Total land in VT
vt_area <- as.numeric(vt_state_sf$ALAND)

# Total and percentage of land area of RI within flood zones
vt_nfhza_2852_land %>% 
  as.data.frame() %>% 
  group_by(Interval) %>% 
  summarize(SqKm = round(as.numeric(sum(Area)/10^6),1), 
            SqMi = round(as.numeric(SqKm/2.59),1),
            PctArea = paste0(as.character(round(as.numeric(sum(Area)/vt_area*100),1)),"%")) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','),
                    caption = "Vermont Land Area within Flood Zones",
                    digits = 0, align = "r") %>% 
  kableExtra::kable_styling(latex_options = c("repeat_header"))
```

The proportion of the total state population within flood zones exceeds the percentage of the state area within flood zones. Moreover, exposure varies by population subgroup. Table \@ref(tab:tabNFHZApop) below shows the total and percentages of the general population and various subgroups within flood zones. Aside from the total population, the largest absolute numbers of subpopulations within a flood zone are low income persons followed by those under 18 and over 64. The latter groups are populations of concern who may have limited mobility in the event of an evacuation. 

```{r tabNFHZApop, echo=FALSE, message=FALSE, warning=FALSE, fig.align = "center", fig.cap="Vermont Populations within Flood Zones."}
# Show table of pops within flood zones
vt_FloodPops_df %>% 
  mutate(PctFlood = paste0(as.character(round(PctFlood,1)),"%")) %>% 
  arrange(-FloodPop) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','),
                    caption = "Vermont Populations within Flood Zones",
                    digits = 0, align = "r") %>% 
  kableExtra::kable_styling(latex_options = c("repeat_header"))
```

Some groups are disproportionately exposed to these flood hazards. While approximately 5.7% of the general population are within flood zones, limited English speaking households, households without access to a car, people in low income households, and other populations of concern, exceed the population average within flood zones. These populations of concern are overrepresented in terms of flood exposure (see Figure \@ref(fig:chartNFHZApop) below).

```{r chartNFHZApop, echo=FALSE, message=FALSE, warning=FALSE, fig.align = "center", fig.cap="Vermont Populations within Flood Zones."}
# Create lollipop plot of pops within flood zones
vt_FloodPops_df %>% 
  ggplot(aes(x = reorder(Group,PctFlood), 
             y = PctFlood)) +
  geom_segment(aes(x = reorder(Group,PctFlood), 
                   xend = reorder(Group,PctFlood),
                   y = vt_FloodPops_df[1,4], yend = PctFlood), 
               color = "skyblue") +
  geom_point(color = "blue", size = 4, alpha = 0.8) +
  coord_flip() + xlab("") + ylab("") + 
  ggtitle("Vermont Populations within Flood Zones") + theme_light() +
  theme(panel.grid.major.y = element_blank(),
        panel.border = element_blank(),
        axis.ticks.y = element_blank()) +
  geom_text(aes(x = Group, y = PctFlood + 0.2 * sign(PctFlood), 
                label = paste0(round(PctFlood,1),"%")), 
            hjust = 1.8, vjust = -1, size = 3,
            color=rgb(100,100,100, maxColorValue=255)) +
  scale_y_continuous(labels = function(x) paste0(x, "%")) +
  geom_hline(yintercept = vt_FloodPops_df[1,4], linetype = "dashed") +
  geom_text(aes(x = "No HS Dip", y = 6.3, label = "Above state avg"),
            color = "gray48") +
  geom_segment(aes(x = "Total Pop", xend = "Total Pop", y = 5.8, yend = 6.6), 
               arrow = arrow(length = unit(0.3,"cm")))
```

The maps below (Figure \@ref(fig:mapNFHZAPopConcern)) show those overrepresented populations within the flood zones.

```{r mapNFHZAPopConcern, echo=FALSE, message=FALSE, warning=FALSE, fig.align = "center", fig.cap="Vermont Populations within Flood Zones."}
# Create a dot density map of transit-dependent populations in flood zone

# create a function to select variable, filter records, and create sample points
# pop2points <- function(sf, x, group){
#   x <- enquo(x)
#   sf %>%
#     select(!!x) %>%
#     filter(!!x >= 10) %>%
#     st_sample(., size = round(.[[as_label(x)]]/10)) %>%
#     st_sf(.) %>%
#     mutate(Group = group)
# }
# 
# NoCarHH_nfhza_pts <- pop2points(vt_tracts_nfhza,NewNoCar,"No Car HH")
# 
# NoHSdip_nfhza_pts <- pop2points(vt_blkgrps_nfhza,NewLths,"No HS Dip")
# 
# LowInc_nfhza_pts <- pop2points(vt_blkgrps_nfhza,NewPov,"Low Income")
# 
# Disabled_nfhza_pts <- pop2points(vt_tracts_nfhza,NewDisabled,"Disabled")
# 
# Minor_nfhza_pts <- pop2points(vt_blkgrps_nfhza,NewMinority,"Minority")
# 
# Over64_nfhza_pts <- pop2points(vt_blkgrps_nfhza,NewOver64,"Over 64")
# 
# # Bring them together
# vt_nfhza_vulnerable <- rbind(NoCarHH_nfhza_pts,
#                              Disabled_nfhza_pts,
#                              LowInc_nfhza_pts,
#                              Minor_nfhza_pts,
#                              Over64_nfhza_pts,
#                              NoHSdip_nfhza_pts) %>%
#   # slice(sample(1:n())) %>% # randomise order to avoid bias in plotting order
#   group_by(Group) %>%
#   summarize()
# 
# # clean up pts layers
# rm(list = ls(pattern = "_nfhza_pts"))
# 
# # save time by just loading file
# saveRDS(vt_nfhza_vulnerable, file = "DATA/FEMA/VT/vt_nfhza_vulnerable.Rds")
# # load vulnerable point file
# vt_nfhza_vulnerable <- readRDS("DATA/FEMA/VT/vt_nfhza_vulnerable.Rds")
# 
# # Map over-represented pops and flood zones
# m <- tm_layout(bg.color = "#e6f3f7") +
#   tm_shape(vt_blkgrp_2852, unit = "mi") + tm_fill(col = "white") +
#   tm_shape(ne_states_sf_cb) + tm_fill(col="white") +
#   tm_shape(ny_state_sf) + tm_fill(col="white") +
#   tm_shape(vt_awater_sf_simple) + tm_fill(col = "#e6f3f7") +
#   tm_shape(vt_nfhza_vulnerable) +
#   tm_dots(col = "darkgoldenrod3",
#           labels = "1 dot = 10 people",
#           alpha = 0.6) +
#   tm_facets(by = "Group",
#             ncol = 2,
#             free.coords = FALSE) +
#   tm_shape(vt_nfhza_2852_land_simple) +
#   tm_fill(col = "Interval",
#           palette = c("dodgerblue", "blueviolet"),
#           labels = c("1% AEP (100-year)", "0.2% AEP (500-year)"),
#           title = "FEMA Flood Zones",
#           alpha = 0.6,
#           border.alpha = 0) +
#   tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.6) +
#   tm_shape(ny_state_sf) + tm_borders(lwd = 0.6) +
#   tm_shape(vt_highways) + tm_lines(col = "seashell4", lwd = 1) +
#   tm_shape(vt_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
#   tm_shape(I89roadSegment) + 
#   tm_symbols(shape = I89, border.lwd = NA, size = 0.1) +
#   tm_shape(I91roadSegment) + 
#   tm_symbols(shape = I91, border.lwd = NA, size = 0.1) +
#   tm_shape(I91roadSegment2) + 
#   tm_symbols(shape = I91, border.lwd = NA, size = 0.1) +
#   tm_shape(I93roadSegment) + 
#   tm_symbols(shape = I93, border.lwd = NA, size = 0.1) +
#   tm_shape(vt_towns_sf_pts) + tm_dots() +
#   tm_text("NAME", size = 0.5, col = "black",
#           xmod = 0.7, ymod = 0.2, shadow = TRUE) +
#   tm_shape(nofemapolys) +
#   tm_fill(col = "gray", alpha = 0.4) +
#   # tm_text("LABEL", alpha = 0.5, size = 0.6) +
#   tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5,
#                position = c(0.6,0.005)) +
#   tm_add_legend(type = "fill", col = "darkgoldenrod3",
#                 alpha = 0.6,
#                 border.col = "white", border.alpha = 0,
#                 labels = "1 dot = 10 people",
#                 title = "Population Group") +
#   tm_add_legend(type = "fill", col = "gray",
#                 alpha = 0.4,
#                 border.col = "white", border.alpha = 0,
#                 labels = "No FEMA Data",
#                 title = "FEMA Coverage") +
#   tm_layout(title = "Over-represented\nPopulations\nwithin\nFlood Zones",
#             frame = TRUE, main.title.size = 0.8,
#             legend.outside = TRUE,
#             legend.title.size = 0.8,
#             legend.outside.position = c("right", "top"),
#             # legend.outside.position = "bottom",
#             legend.outside.size = 0.15,
#             asp = 10/15)
# 
# tmap_save(m, "DATA/FEMA/VT/VT_nhfza_vulnerable.png",
#           height = 9, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/FEMA/VT/VT_nhfza_vulnerable.png")
```

