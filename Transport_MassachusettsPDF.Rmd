---
title: "Transportation Options in Massachusetts"
author: "Marcos Luna and Neenah Estrella-Luna"
date: "`r Sys.Date()`"
output: 
  bookdown::pdf_document2:
    toc: true
    toc_depth: 3
    number_sections: true
    fig_caption: yes        
    includes:  
      in_header: my_header.tex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE)

library(tidyverse)
library(sf)
library(tmap)
library(tidytransit)
library(sp)
library(tigris)
options(tigris_use_cache = TRUE, tigris_class = "sf")
library(lubridate)
library(maptools)
library(spdep)
library(lwgeom)
```

\pagebreak

# Analysis of adequacy of public transit, walkability, and transportation cost burden in Massachusetts

This is an analysis of access to public transit and walkability in Massachusetts.

```{r data, include=FALSE}
### Analysis of Massachusetts transportation options
load("DATA/ne_layers.rds")

rm(ne_blkgrp_sf90)

### Read in MA transit data from MassGIS and MassDOT and merge. See https://docs.digital.mass.gov/dataset/massgis-data-mbta-bus-routes-and-stops
# read in MBTA bus routes
mbta_busRoutes_sf <- st_read(dsn = "DATA/transport/MA/mbtabus",
                           layer = "MBTABUSROUTES_ARC") %>% 
  transmute(ROUTE = MBTA_ROUTE,
            ROUTE_DESC = ROUTE_DESC,
            AGENCY = "MBTA",
            TYPE = "Bus")

# read in MBTA bus stops
mbta_busStops_sf <- st_read(dsn = "DATA/transport/MA/mbtabus",
                          layer = "MBTABUSSTOPS_PT") %>% 
  transmute(STOP_NAME = STOP_NAME,
            AGENCY = "MBTA",
            TYPE = "Bus")

# read in MBTA rapid transit routes
mbta_rtRoutes_sf <- st_read(dsn = "DATA/transport/MA/mbta_rapid_transit",
                           layer = "MBTA_ARC")

# read in MBTA rapid transit stops
mbta_rtStops_sf <- st_read(dsn = "DATA/transport/MA/mbta_rapid_transit",
                           layer = "MBTA_NODE") %>% 
  transmute(STOP_NAME = STATION,
            AGENCY = LINE,
            TYPE = "Rapid Transit") # standardize to rbind with other stops

# read in MBTA trains and commuter rail routes
mbta_trainRoutes_sf <- st_read("DATA/transport/MA/mbta_trains",
                             layer = "TRAINS_ARC") %>% 
  filter(COMMRAIL == "Y") %>%  # limit to commuter rail
  group_by(LINE_BRNCH) %>% 
  summarize()

# read in MBTA trains and commuter rail stops
mbta_trainStops_sf <- st_read("DATA/transport/MA/mbta_trains",
                             layer = "TRAINS_NODE") %>% 
  filter(C_RAILSTAT == "Y") %>%  # limit to commuter rail
  transmute(STOP_NAME = STATION,
            AGENCY = LINE_BRNCH,
            TYPE = "Commuter Rail") # standardize to rbind with other stops

# read in MA regional transit authorities beyond MBTA
ma_busRoutes_sf <- st_read("DATA/transport/MA/MA_Regional_Transit_Authorities_Routes-shp", layer = "Regional_Transit_Authorities") %>% 
  st_transform(., crs = st_crs(mbta_busRoutes_sf)) %>% 
  transmute(ROUTE = route_shor,
            ROUTE_DESC = route_long,
            AGENCY = Agency,
            TYPE = route_ty_1)

# read in MA regional transit authority bus stops beyond MBTA
ma_busStops_sf <- st_read("DATA/transport/MA/MA_Regional_Transit_Authorities_Stops-shp", layer = "Regional_Transit_Authorities") %>% 
  st_transform(., crs = st_crs(mbta_busRoutes_sf)) %>% 
  transmute(STOP_NAME = stop_name,
            AGENCY = Agency,
            TYPE = "Bus")

# # read in MA ferry routes
# ma_ferryRoutes_sf <- st_read("DATA/transport/MA/MA_Ferry_Routes-shp",
#                              layer = "Ferry_Routes") %>% 
#   filter(TYPE == "pass" & SERVICE == "year round") %>% 
#   st_transform(., crs = st_crs(mbta_busRoutes_sf))
# 
# # read in MA seaports
# ma_seaports_sf <- st_read("DATA/transport/MA/MA_Seaports-shp", 
#                           layer = "Seaports") %>% 
#   filter(PASSENGER == "Yes" & SERVICE == "year round") %>% 
#   st_transform(., crs = st_crs(mbta_busRoutes_sf))

# read in MA park-in-ride lots and limit to those that are operational and serving either bus or rail
ma_parknride_sf <- st_read(dsn = "DATA/transport/MA/MA_Park_and_Ride_Lots-shp",
                           layer = "Park_and_Ride_Lots") %>% 
  filter(STATUS == "Operational" & 
           (BUS_SERVIC != "N" | RAIL_SERVI != "N")) %>% 
  st_transform(., crs = st_crs(mbta_busRoutes_sf)) %>% 
  transmute(STOP_NAME = LOCATION,
            AGENCY = BUS_SERVIC,
            TYPE = "Park-in-Ride")


# merge bus routes into one statewide layer
ma_busRoutesAll_sf <- mbta_busRoutes_sf %>% 
  st_zm() %>% # remove M dimension to allow rbind
  rbind(ma_busRoutes_sf,.)

# # create simplified version of bus routes to speed up mapping
# ma_busRoutesAll_sf_simple <- ma_busRoutesAll_sf %>% 
#   st_simplify(., dTolerance = 50) %>%
#   st_set_precision(10^6) %>% 
#   st_make_valid() %>% 
#   group_by(AGENCY) %>% 
#   summarize()

# create a simplified version of bus routes with overlapping lines removed to speed up mapping
ma_busRoutesAll_sf_simple <- unique(ma_busRoutesAll_sf) %>% 
  st_simplify(., dTolerance = 100) %>% 
  st_make_valid() 

# merge bus stops into one statewide layer
ma_busStopsAll_sf <- rbind(ma_busStops_sf,mbta_busStops_sf)

# merge all transit stops for cumulative analysis of all transit accessibility
ma_transitStopsAll_sf <- rbind(ma_busStopsAll_sf, 
                               mbta_trainStops_sf, 
                               mbta_rtStops_sf,
                               ma_parknride_sf) %>% 
  mutate(Dist = case_when(
    TYPE == "Bus" ~ 400,
    TYPE == "Rapid Transit" ~ 800,
    TYPE %in% c("Commuter Rail","Park-in-Ride") ~ 4800
  ))


# extract census units for state
ma_blkgrps_sf <- ne_blkgrp_sf %>% 
  filter(STATE == "Massachusetts") %>% 
  select(GEOID, NAME,STATE, bg_area_m2, totalpopE, minorityE, under5E, under18E, over64E, householdsE, eng_hhE, eng_limitE, age25upE, lthsE, povknownE, num2povE, MA_MINORITY, MA_INCOME, MA_ENGLISH) %>% 
  st_transform(., crs = 26986) %>% 
  filter(!st_is_empty(.)) %>% 
  mutate(PopAcre = totalpopE/(bg_area_m2*0.000247105))

ma_tracts_sf <- ne_tracts_sf %>% 
  filter(STATE == "Massachusetts") %>% 
  select(GEOID, NAME, totalpopE, STATE, Over18E, disabledOver18E, totalHHE, HHnoCarE) %>% 
  st_transform(., crs = 26986) %>% 
  filter(!st_is_empty(.))

# clean up
rm(ne_blkgrp_sf,ne_tracts_sf)

# # Get rid of empty geometries
# empty_geo <- st_is_empty(ma_blkgrps_sf)
# ma_blkgrps_sf <- ma_blkgrps_sf[!empty_geo,]
# empty_geo <- st_is_empty(ma_tracts_sf)
# ma_tracts_sf <- ma_tracts_sf[!empty_geo,]

# Use dasymetric mapping to calculate populations with access to transit. Approach follows method used by Qiang (2019) to eliminate unpopulated areas of census polygons and then reallocate populations to developed areas as identified in National Land Cover Dataset (NLCD). 
# Perform NLCD raster-to-vector conversion, vector erase/difference, and vector intersections in ArcMap because it takes too long in R. 
# In ArcMap:
# Convert NLCD raster to shapefile. Clip to state.
# Isolate undeveloped areas (gridcode NOT 22 - 24). 
# Erase areas of block groups and tracts that overlap with undeveloped areas in NLCD shapefiles. Compute OldArea of erased polygons in sqm to identify area of developed polygons remaining. 

##### Return to working in R ######
# # read in processed ma_blkgrps and ma_tracts
# st_layers(dsn = "DATA/FEMA/MA")
ma_blkgrps_developed <- st_read(dsn = "DATA/FEMA/MA",
                                layer = "ma_blkgrps_developed") 

ma_blkgrps_developed <- ma_blkgrps_sf %>% 
  mutate(MA_LOWINC = if_else(MA_INCOME == "I", totalpopE, 0)) %>% 
  mutate(MA_LOWINC = replace_na(MA_LOWINC,0)) %>% 
  mutate(MA_MINORITY = if_else(MA_MINORITY == "M", totalpopE,0)) %>%
  mutate(MA_MINORITY = replace_na(MA_MINORITY,0)) %>% 
  mutate(MA_ENGLISH = if_else(MA_ENGLISH == "E", totalpopE,0)) %>%
  mutate(MA_ENGLISH = replace_na(MA_ENGLISH,0)) %>% 
  as.data.frame() %>% 
  dplyr::select(-geometry) %>%
  left_join(ma_blkgrps_developed, ., by = "GEOID") %>% 
  st_transform(., crs = 26986) %>% 
  mutate(NewArea = st_area(.)) %>%
  st_make_valid() %>% 
  mutate(Proportion = as.numeric(NewArea/OldArea),
         NewPop = totalpopE*Proportion,
         NewMinority = minorityE*Proportion,
         NewUnder5 = under5E*Proportion,
         NewOver64 = over64E*Proportion,
         NewUnder18 = under18E*Proportion,
         NewEng_limit = eng_limitE*Proportion,
         NewPov = num2povE*Proportion,
         NewLths = lthsE*Proportion,
         NewMA_LOWINC = MA_LOWINC*Proportion,
         NewMA_MINORITY = MA_MINORITY*Proportion,
         NewMA_ENGLISH = MA_ENGLISH*Proportion,
         NewPopAcre = NewPop/(NewArea*0.000247105))

ma_tracts_developed <- st_read(dsn = "DATA/FEMA/MA",
                                layer = "ma_tracts_developed") %>% 
  left_join(., as.data.frame(ma_tracts_sf), by = "GEOID") %>% 
  st_transform(., crs = 26986) %>% 
  mutate(NewArea = st_area(.)) %>%
  st_make_valid() %>% 
  mutate(Proportion = as.numeric(NewArea/OldArea),
         NewDisabled = disabledOver18E*Proportion,
         NewOver18 = Over18E*Proportion,
         NewHHNoCar = HHnoCarE*Proportion)

# create a simplified version for faster mapping
ma_blkgrps_developed_simple <- st_simplify(ma_blkgrps_developed,
                                           dTolerance = 100) %>% 
  filter(!st_is_empty(.))
# repeat for tracts
ma_tracts_developed_simple <- st_simplify(ma_tracts_developed, 
                                          dTolerance = 100) %>% 
  filter(!st_is_empty(.))


# # clean up
# rm(list = ls(pattern = "ne_"))

# Create a 400m buffer around bus stops
ma_busBuff400m <- st_buffer(ma_busStopsAll_sf,dist = 400) %>% 
  st_union() %>% 
  st_as_sf()

# Create variable buffers around bus (400m), rapid transit (800m), and commuter rail and park-n-ride stops (4800m)
mbta_rtBuff800m <- st_buffer(mbta_rtStops_sf, dist = 800) %>% 
  st_union() %>% 
  st_as_sf()

ma_crBuff4800m <- st_buffer(mbta_trainStops_sf, dist = 4800) %>% 
  st_union() %>% 
  st_as_sf()

ma_prBuff4800m <- st_buffer(ma_parknride_sf, dist = 4800) %>% 
  st_union() %>% 
  st_as_sf()

ma_crprBuff4800m <- rbind(ma_crBuff4800m,ma_prBuff4800m) %>% 
  st_union() %>% 
  st_as_sf()

ma_transitAllBuff <- rbind(ma_busBuff400m,
                           mbta_rtBuff800m,
                           ma_crBuff4800m,
                           ma_prBuff4800m) %>% 
  st_union() %>% 
  st_as_sf() %>% 
  mutate(Sqm = st_area(.))

# Use areal interpolation to calculate populations of concern within buffer of accessibility
ma_busBuff400m_sf <- ma_blkgrps_developed %>% 
  select(GEOID,NewArea:NewMA_ENGLISH) %>% 
  mutate(OldArea = NewArea) %>% 
  st_intersection(ma_busBuff400m,.) %>% 
  mutate(NewArea = st_area(.),
         Proportion = NewArea/OldArea,
         NewPop = as.integer(NewPop*Proportion),
         NewMinority = as.integer(NewMinority*Proportion),
         NewUnder5 = as.integer(NewUnder5*Proportion),
         NewOver64 = as.integer(NewOver64*Proportion),
         NewUnder18 = as.integer(NewUnder18*Proportion),
         NewEng_limit = as.integer(NewEng_limit*Proportion),
         NewPov = as.integer(NewPov*Proportion),
         NewLths = as.integer(NewLths*Proportion),
         NewMA_LOWINC = as.integer(NewMA_LOWINC*Proportion),
         NewMA_MINORITY = as.integer(NewMA_MINORITY*Proportion),
         NewMA_ENGLISH = as.integer(NewMA_ENGLISH*Proportion))

ma_rtBuff800m_sf <- ma_blkgrps_developed %>% 
  select(GEOID,NewArea:NewMA_ENGLISH) %>% 
  mutate(OldArea = NewArea) %>% 
  st_intersection(mbta_rtBuff800m,.) %>% 
  mutate(NewArea = st_area(.),
         Proportion = NewArea/OldArea,
         NewPop = as.integer(NewPop*Proportion),
         NewMinority = as.integer(NewMinority*Proportion),
         NewUnder5 = as.integer(NewUnder5*Proportion),
         NewOver64 = as.integer(NewOver64*Proportion),
         NewUnder18 = as.integer(NewUnder18*Proportion),
         NewEng_limit = as.integer(NewEng_limit*Proportion),
         NewPov = as.integer(NewPov*Proportion),
         NewLths = as.integer(NewLths*Proportion),
         NewMA_LOWINC = as.integer(NewMA_LOWINC*Proportion),
         NewMA_MINORITY = as.integer(NewMA_MINORITY*Proportion),
         NewMA_ENGLISH = as.integer(NewMA_ENGLISH*Proportion))

ma_crprBuff4800m_sf <- ma_blkgrps_developed %>% 
  select(GEOID,NewArea:NewMA_ENGLISH) %>% 
  mutate(OldArea = NewArea) %>% 
  st_intersection(ma_crprBuff4800m,.) %>% 
  mutate(NewArea = st_area(.),
         Proportion = NewArea/OldArea,
         NewPop = as.integer(NewPop*Proportion),
         NewMinority = as.integer(NewMinority*Proportion),
         NewUnder5 = as.integer(NewUnder5*Proportion),
         NewOver64 = as.integer(NewOver64*Proportion),
         NewUnder18 = as.integer(NewUnder18*Proportion),
         NewEng_limit = as.integer(NewEng_limit*Proportion),
         NewPov = as.integer(NewPov*Proportion),
         NewLths = as.integer(NewLths*Proportion),
         NewMA_LOWINC = as.integer(NewMA_LOWINC*Proportion),
         NewMA_MINORITY = as.integer(NewMA_MINORITY*Proportion),
         NewMA_ENGLISH = as.integer(NewMA_ENGLISH*Proportion))

ma_TransitAllBuff_sf <- ma_blkgrps_developed %>% 
  select(GEOID,NewArea:NewMA_ENGLISH) %>% 
  mutate(OldArea = NewArea) %>% 
  st_intersection(ma_transitAllBuff,.) %>% 
  mutate(NewArea = st_area(.),
         Proportion = NewArea/OldArea,
         NewPop = as.integer(NewPop*Proportion),
         NewMinority = as.integer(NewMinority*Proportion),
         NewUnder5 = as.integer(NewUnder5*Proportion),
         NewOver64 = as.integer(NewOver64*Proportion),
         NewUnder18 = as.integer(NewUnder18*Proportion),
         NewEng_limit = as.integer(NewEng_limit*Proportion),
         NewPov = as.integer(NewPov*Proportion),
         NewLths = as.integer(NewLths*Proportion),
         NewMA_LOWINC = as.integer(NewMA_LOWINC*Proportion),
         NewMA_MINORITY = as.integer(NewMA_MINORITY*Proportion),
         NewMA_ENGLISH = as.integer(NewMA_ENGLISH*Proportion))

# Repeat for tracts
ma_busBuff400mTracts_sf <- ma_tracts_developed %>% 
  select(GEOID,NewDisabled:NewHHNoCar) %>% 
  mutate(OldArea = st_area(.)) %>% 
  st_intersection(ma_busBuff400m,.) %>% 
  mutate(NewArea = st_area(.),
         Proportion = NewArea/OldArea,
         NewDisabled = as.integer(NewDisabled*Proportion),
         NewNoCar = as.integer(NewHHNoCar*Proportion))

ma_rtBuff800mTracts_sf <- ma_tracts_developed %>% 
  select(GEOID,NewDisabled:NewHHNoCar) %>% 
  mutate(OldArea = st_area(.)) %>% 
  st_intersection(mbta_rtBuff800m,.) %>% 
  mutate(NewArea = st_area(.),
         Proportion = NewArea/OldArea,
         NewDisabled = as.integer(NewDisabled*Proportion),
         NewNoCar = as.integer(NewHHNoCar*Proportion))

ma_crprBuff4800mTracts_sf <- ma_tracts_developed %>% 
  select(GEOID,NewDisabled:NewHHNoCar) %>% 
  mutate(OldArea = st_area(.)) %>% 
  st_intersection(ma_crprBuff4800m,.) %>% 
  mutate(NewArea = st_area(.),
         Proportion = NewArea/OldArea,
         NewDisabled = as.integer(NewDisabled*Proportion),
         NewNoCar = as.integer(NewHHNoCar*Proportion))

ma_TransitAllBuffTracts_sf <- ma_tracts_developed %>% 
  select(GEOID,NewDisabled:NewHHNoCar) %>% 
  mutate(OldArea = st_area(.)) %>% 
  st_intersection(ma_transitAllBuff,.) %>% 
  mutate(NewArea = st_area(.),
         Proportion = NewArea/OldArea,
         NewDisabled = as.integer(NewDisabled*Proportion),
         NewNoCar = as.integer(NewHHNoCar*Proportion))

# # Use areal interpolation to calculate populations of concern within buffer of accessibility
# ma_busBuff400m_sf <- ma_blkgrps_sf %>% 
#   mutate(MA_LOWINC = if_else(MA_INCOME == "I",totalpopE,0)) %>% 
#   mutate(MA_LOWINC = replace_na(MA_LOWINC,0)) %>% 
#   mutate(MA_MINORITY = if_else(MA_MINORITY == "M",totalpopE,0)) %>% 
#   mutate(MA_MINORITY = replace_na(MA_MINORITY,0)) %>% 
#   select(GEOID,
#          totalpopE,
#          minorityE,
#          under5E,
#          over64E,
#          under18E,
#          eng_limitE,
#          num2povE,
#          lthsE,
#          MA_LOWINC,
#          MA_MINORITY) %>% 
#   mutate(OldArea = st_area(.)) %>% 
#   st_intersection(ma_busBuff400m,.) %>% 
#   mutate(NewArea = st_area(.),
#          Proportion = NewArea/OldArea,
#          NewPop = as.integer(totalpopE*Proportion),
#          NewMinority = as.integer(minorityE*Proportion),
#          NewUnder5 = as.integer(under5E*Proportion),
#          NewOver64 = as.integer(over64E*Proportion),
#          NewUnder18 = as.integer(under18E*Proportion),
#          NewEng_limit = as.integer(eng_limitE*Proportion),
#          NewPov = as.integer(num2povE*Proportion),
#          NewLths = as.integer(lthsE*Proportion),
#          NewMA_LOWINC = as.integer(MA_LOWINC*Proportion),
#          NewMA_MINORITY = as.integer(MA_MINORITY*Proportion))
# 
# # Repeat for tracts
# ma_busBuff400mTracts_sf <- ma_tracts_sf %>% 
#   select(GEOID,
#          disabledOver18E,
#          HHnoCarE) %>% 
#   mutate(OldArea = st_area(.)) %>% 
#   st_intersection(ma_busBuff400m,.) %>% 
#   mutate(NewArea = st_area(.),
#          Proportion = NewArea/OldArea,
#          NewDisabled = as.integer(disabledOver18E*Proportion),
#          NewNoCar = as.integer(HHnoCarE*Proportion))

# Compute total block group populations within transit stop buffers
ma_busBuff400m_df <- ma_busBuff400m_sf %>% 
  as.data.frame() %>% 
  summarize(`Total Pop` = sum(NewPop),
            Minority = sum(NewMinority),
            `Under 5` = sum(NewUnder5),
            `Over 64` = sum(NewOver64),
            `Under 18` = sum(NewUnder18),
            `Limited English HH` = sum(NewEng_limit),
            `Low Income` = sum(NewPov),
            `No HS Dip` = sum(NewLths),
            `MA Low Income` = sum(NewMA_LOWINC),
            `MA Minority` = sum(NewMA_MINORITY),
            `MA Limited English HH` = sum(NewMA_ENGLISH)) %>% 
  gather(key = Group, value = BusPop)

ma_rtBuff800m_df <- ma_rtBuff800m_sf %>% 
  as.data.frame() %>% 
  summarize(`Total Pop` = sum(NewPop),
            Minority = sum(NewMinority),
            `Under 5` = sum(NewUnder5),
            `Over 64` = sum(NewOver64),
            `Under 18` = sum(NewUnder18),
            `Limited English HH` = sum(NewEng_limit),
            `Low Income` = sum(NewPov),
            `No HS Dip` = sum(NewLths),
            `MA Low Income` = sum(NewMA_LOWINC),
            `MA Minority` = sum(NewMA_MINORITY),
            `MA Limited English HH` = sum(NewMA_ENGLISH)) %>% 
  gather(key = Group, value = RapidTransitPop)

ma_crprBuff4800m_df <- ma_crprBuff4800m_sf  %>% 
  as.data.frame() %>% 
  summarize(`Total Pop` = sum(NewPop),
            Minority = sum(NewMinority),
            `Under 5` = sum(NewUnder5),
            `Over 64` = sum(NewOver64),
            `Under 18` = sum(NewUnder18),
            `Limited English HH` = sum(NewEng_limit),
            `Low Income` = sum(NewPov),
            `No HS Dip` = sum(NewLths),
            `MA Low Income` = sum(NewMA_LOWINC),
            `MA Minority` = sum(NewMA_MINORITY),
            `MA Limited English HH` = sum(NewMA_ENGLISH)) %>% 
  gather(key = Group, value = CommuterPop)

ma_TransitAllBuff_df <- ma_TransitAllBuff_sf %>% 
  as.data.frame() %>% 
  summarize(`Total Pop` = sum(NewPop),
            Minority = sum(NewMinority),
            `Under 5` = sum(NewUnder5),
            `Over 64` = sum(NewOver64),
            `Under 18` = sum(NewUnder18),
            `Limited English HH` = sum(NewEng_limit),
            `Low Income` = sum(NewPov),
            `No HS Dip` = sum(NewLths),
            `MA Low Income` = sum(NewMA_LOWINC),
            `MA Minority` = sum(NewMA_MINORITY),
            `MA Limited English HH` = sum(NewMA_ENGLISH)) %>% 
  gather(key = Group, value = TransitPop)

# Compute total tract populations within bus stop buffer
ma_busBuff400mTracts_df <- ma_busBuff400mTracts_sf %>% 
  as.data.frame() %>% 
  summarize(`Disabled` = sum(NewDisabled),
            `No Car HH` = sum(NewNoCar)) %>% 
  gather(key = Group, value = BusPop)

ma_rtBuff800mTracts_df <- ma_rtBuff800mTracts_sf %>% 
  as.data.frame() %>% 
  summarize(`Disabled` = sum(NewDisabled),
            `No Car HH` = sum(NewNoCar)) %>% 
  gather(key = Group, value = RapidTransitPop)

ma_crprBuff4800mTracts_df <- ma_crprBuff4800mTracts_sf %>% 
  as.data.frame() %>% 
  summarize(`Disabled` = sum(NewDisabled),
            `No Car HH` = sum(NewNoCar)) %>% 
  gather(key = Group, value = CommuterPop)

ma_TransitAllBuffTracts_df <- ma_TransitAllBuffTracts_sf %>% 
  as.data.frame() %>% 
  summarize(`Disabled` = sum(NewDisabled),
            `No Car HH` = sum(NewNoCar)) %>% 
  gather(key = Group, value = TransitPop)

# Compute total tract populations within the state for same groups
ma_tract_pops_df <- ma_tracts_sf %>% 
  as.data.frame() %>% 
  summarize(`Disabled` = sum(disabledOver18E),
            `No Car HH` = sum(HHnoCarE)) %>% 
  gather(key = Group, value = MAPop) %>% 
  left_join(.,ma_busBuff400mTracts_df, by = "Group") %>% 
  left_join(.,ma_rtBuff800mTracts_df, by = "Group") %>% 
  left_join(.,ma_crprBuff4800mTracts_df, by = "Group") %>% 
  left_join(.,ma_TransitAllBuffTracts_df, by = "Group")

# Compute populations for state, join with buffer pops
ma_transitAccessPops_df <- ma_blkgrps_sf %>% 
  as.data.frame() %>% 
  mutate(MA_LOWINC = if_else(MA_INCOME == "I", totalpopE, 0)) %>% 
  mutate(MA_LOWINC = replace_na(MA_LOWINC,0)) %>% 
  mutate(MA_MINORITY = if_else(MA_MINORITY == "M", totalpopE,0)) %>%
  mutate(MA_MINORITY = replace_na(MA_MINORITY,0)) %>% 
  mutate(MA_ENGLISH = if_else(MA_ENGLISH == "E", totalpopE,0)) %>%
  mutate(MA_ENGLISH = replace_na(MA_ENGLISH,0)) %>%
  summarize(`Total Pop` = sum(totalpopE),
            Minority = sum(minorityE),
            `Under 5` = sum(under5E),
            `Over 64` = sum(over64E),
            `Under 18` = sum(under18E),
            `Limited English HH` = sum(eng_limitE),
            `Low Income` = sum(num2povE),
            `No HS Dip` = sum(lthsE),
            `MA Low Income` = sum(MA_LOWINC, na.rm = TRUE),
            `MA Minority` = sum(MA_MINORITY, na.rm = TRUE),
            `MA Limited English HH` = sum(MA_ENGLISH, na.rm = TRUE)) %>% 
  gather(key = Group, value = MAPop) %>% 
  left_join(., ma_busBuff400m_df, by = "Group") %>% 
  left_join(., ma_rtBuff800m_df, by = "Group") %>% 
  left_join(., ma_crprBuff4800m_df, by = "Group") %>% 
  left_join(., ma_TransitAllBuff_df, by = "Group") %>% 
  rbind(.,ma_tract_pops_df) %>% 
  mutate(PctBus = BusPop/MAPop*100,
         PctRapidTransit = RapidTransitPop/MAPop*100,
         PctCommuter = CommuterPop/MAPop*100,
         PctAllTransit = TransitPop/MAPop*100)

# create point layer of towns for context
ma_towns_sf_pts <- county_subdivisions(state = "MA", cb = TRUE) %>% 
  filter(NAME %in% c("Boston",
                     "Salem",
                     "Lawrence",
                     "Lowell",
                     "Newburyport",
                     "Rockport",
                     "Brockton",
                     "New Bedford",
                     "Plymouth",
                     "Worcester",
                     "Springfield",
                     "Pittsfield",
                     "Fitchburg",
                     "Franklin Town",
                     "Deerfield",
                     "Wrentham,",
                     "Great Barrington",
                     "Holyoke",
                     "Barnstable Town")) %>% 
  st_transform(., crs = 26986) %>% 
  st_centroid(of_largest_polygon = TRUE)

# Create road layer for context
ma_highways <- primary_roads() %>% 
  filter(FULLNAME %in% c("I- 84","I- 90","I- 91","I- 95","I- 190","I- 195","I- 290","I- 395","I- 495","US Hwy 6","US Hwy 202","Mohawk Trl","George W Stanton Hwy","State Rte 2","Mass State Hwy","Concord Tpke","State Rte 25")) %>% 
  tmaptools::crop_shape(., ne_states_sf_cb) %>% 
  st_transform(., crs = 2805)

ma_highways2nd <- primary_secondary_roads("MA") %>% 
  filter(FULLNAME %in% c("US Hwy 6","Mohawk Trl","State Rte 2","Cambridge Tpke")) %>% 
  st_transform(., crs = 2805)

# Extract highway segments for labeling
I90roadSegment <- ma_highways %>% 
  filter(LINEARID == "1103745154991")

I90roadSegment2 <- ma_highways %>% 
  filter(LINEARID == "110340769311")

I91roadSegment <- ma_highways %>% 
  filter(LINEARID == "1104748241453")

I95roadSegment <- ma_highways %>% 
  filter(LINEARID == "1105569136116")

I95roadSegment2 <- ma_highways %>% 
  filter(LINEARID == "1103737956638")

I195roadSegment2 <- ma_highways %>% 
  filter(LINEARID == "1101922014382")

I395roadSegment <- ma_highways %>% 
  filter(LINEARID == "1104259933162")

I495roadSegment <- ma_highways %>% 
  filter(LINEARID == "1103745404033")

I495roadSegment2 <- ma_highways %>% 
  filter(LINEARID == "1105589457557")

I495roadSegment3 <- ma_highways %>% 
  filter(LINEARID == "1101922014436")

StRt2Segment <- ma_highways2nd %>% 
  filter(LINEARID == "1106087431756")

USHwy6Segment <- ma_highways %>% 
  filter(LINEARID == "1109096413415")

# Create custom icons of highway shields
I90 <- tmap_icons(file = "https://upload.wikimedia.org/wikipedia/commons/thumb/c/ca/I-90.svg/200px-I-90.svg.png")
I95 <- tmap_icons(file = "https://upload.wikimedia.org/wikipedia/commons/thumb/6/61/I-95.svg/200px-I-95.svg.png")
I395 <- tmap_icons("https://upload.wikimedia.org/wikipedia/commons/thumb/1/16/I-395.svg/200px-I-395.svg.png")
I91 <- tmap_icons("https://upload.wikimedia.org/wikipedia/commons/thumb/9/90/I-91.svg/200px-I-91.svg.png")
I495 <- tmap_icons("https://upload.wikimedia.org/wikipedia/commons/thumb/8/8c/I-495.svg/200px-I-495.svg.png")
Hwy2 <- tmap_icons("https://upload.wikimedia.org/wikipedia/commons/thumb/5/54/MA_Route_2.svg/240px-MA_Route_2.svg.png")
Hwy6 <- tmap_icons("https://upload.wikimedia.org/wikipedia/commons/thumb/e/ef/US_6.svg/200px-US_6.svg.png")

# # recode routes to match MAPTA categories
# ma_busroutes_sf <- ma_busroutes_sf %>% 
#   mutate(type = case_when(
#     ROUTE %in% c(3,4,6,13,17,18,19,21,22,29,30,32,33,34,35,40,49,51,55,57,58,63,64,67,72,73,75,76,78,80,87) ~ "Urban Service",
#     ROUTE == 11 ~ "Rapid Line",
#     ROUTE %in% c(8,9,10,12,14,54,59,60,61,62,65,66,95) ~ "Express Service",
#     ROUTE %in% c(1,20,27,28,31,50,56,71,92) ~ "Key Corridor",
#     ROUTE %in% c(16,203,204,210,231,242,281,282,301) ~ "Flex Service"))

# Calculate totals of populations of concern for use in computing percentages in later tables
# Calculate tract populations by state
statepopsdf_tracts <- ma_tracts_sf %>% 
  as.data.frame() %>% 
  group_by(STATE) %>% 
  summarize(TotalDisabled = sum(disabledOver18E, na.rm = TRUE),
            TotalOver18 = sum(Over18E, na.rm = TRUE),
            TotalNoCar = sum(HHnoCarE, na.rm = TRUE))

statepopsdf <- ma_blkgrps_sf %>% 
  as.data.frame() %>% 
  mutate(MA_LOWINC = if_else(MA_INCOME == "I", totalpopE, 0)) %>% 
  mutate(MA_LOWINC = replace_na(MA_LOWINC,0)) %>% 
  mutate(MA_MINORITY = if_else(MA_MINORITY == "M", totalpopE,0)) %>%
  mutate(MA_MINORITY = replace_na(MA_MINORITY,0)) %>% 
  mutate(MA_ENGLISH = if_else(MA_ENGLISH == "E", totalpopE,0)) %>%
  mutate(MA_ENGLISH = replace_na(MA_ENGLISH,0)) %>%
  group_by(STATE) %>% 
  summarize(TotalPop = sum(totalpopE, na.rm = TRUE),
            TotalHH = sum(householdsE, na.rm = TRUE),
            TotalLEH = sum(eng_limitE, na.rm = TRUE),
            TotalMin = sum(minorityE, na.rm = TRUE),
            TotalLowInc = sum(num2povE, na.rm = TRUE),
            TotalNoHS = sum(lthsE, na.rm = TRUE),
            TotalOver64 = sum(over64E, na.rm = TRUE),
            TotalUnder5 = sum(under5E, na.rm = TRUE),
            TotalUnder18 = sum(under18E, na.rm = TRUE),
            TotalMA_LOWINC = sum(MA_LOWINC, na.rm = TRUE),
            TotalMA_MINORITY = sum(MA_MINORITY, na.rm = TRUE),
            TotalMA_ENGLISH = sum(MA_ENGLISH, na.rm = TRUE)) %>% 
  left_join(., statepopsdf_tracts,by="STATE")

# ma_towns_sf <- ne_towns_sf %>% 
#   dplyr::select(GEOID,NAME) %>% 
#   st_transform(., crs = 26986)

ma_towns_sf <- county_subdivisions(state = "MA", cb = TRUE) %>% 
  st_transform(., crs = 26986)

townpopsdf_tracts <- ma_tracts_sf %>% 
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  group_by(NAME) %>% 
  summarize(TotalDisabled = sum(disabledOver18E, na.rm = TRUE),
            TotalOver18 = sum(Over18E, na.rm = TRUE),
            TotalNoCar = sum(HHnoCarE, na.rm = TRUE))

townpopsdf <- ma_blkgrps_sf %>% 
  dplyr::select(-GEOID) %>% 
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  mutate(MA_LOWINC = if_else(MA_INCOME == "I", totalpopE, 0)) %>% 
  mutate(MA_LOWINC = replace_na(MA_LOWINC,0)) %>% 
  mutate(MA_MINORITY = if_else(MA_MINORITY == "M", totalpopE,0)) %>%
  mutate(MA_MINORITY = replace_na(MA_MINORITY,0)) %>% 
  mutate(MA_ENGLISH = if_else(MA_ENGLISH == "E", totalpopE,0)) %>%
  mutate(MA_ENGLISH = replace_na(MA_ENGLISH,0)) %>%
  group_by(NAME) %>% 
  summarize(GEOID = unique(GEOID),
            TotalPop = sum(totalpopE, na.rm = TRUE),
            TotalHH = sum(householdsE, na.rm = TRUE),
            TotalLEH = sum(eng_limitE, na.rm = TRUE),
            TotalMin = sum(minorityE, na.rm = TRUE),
            TotalLowInc = sum(num2povE, na.rm = TRUE),
            TotalNoHS = sum(lthsE, na.rm = TRUE),
            TotalOver64 = sum(over64E, na.rm = TRUE),
            TotalUnder5 = sum(under5E, na.rm = TRUE),
            TotalUnder18 = sum(under18E, na.rm = TRUE),
            TotalMA_LOWINC = sum(MA_LOWINC, na.rm = TRUE),
            TotalMA_MINORITY = sum(MA_MINORITY, na.rm = TRUE),
            TotalMA_ENGLISH = sum(MA_ENGLISH, na.rm = TRUE)) %>% 
  left_join(.,townpopsdf_tracts,by="NAME")

ma_state_sf_cb <- ne_states_sf_cb %>% 
  filter(NAME == "Massachusetts") %>% 
  st_transform(., crs = st_crs(ma_blkgrps_sf))

# Identify areas >= 1 mile from bus stops
# Create a 1 mile buffer around bus stops
ma_busBuff1mile <- st_buffer(ma_busStopsAll_sf,dist = 1609.34) %>% 
  st_union() %>% 
  st_as_sf()
# identify block groups that do not intersect with 1 mile from bus stop
ma_blkgrps_sf_noBus <- ma_blkgrps_developed %>% 
  filter(st_disjoint(.,ma_busBuff1mile,sparse = FALSE))
# Identify tracts that do not intersect with buffer
ma_tracts_sf_noBus <- ma_tracts_developed %>% 
  filter(st_disjoint(.,ma_busBuff1mile,sparse = FALSE))
# create simplified versions for faster mapping
ma_blkgrps_sf_noBus_simple <- ma_blkgrps_sf_noBus %>% 
  st_simplify(., dTolerance = 100) %>% 
  filter(!st_is_empty(.)) %>% 
  st_make_valid()
ma_tracts_sf_noBus_simple <- ma_tracts_sf_noBus %>% 
  st_simplify(., dTolerance = 100) %>% 
  filter(!st_is_empty(.)) %>% 
  st_make_valid()

# Identify areas >= 1 mile from rapid transit stops
# Create a 1 mile buffer around rapid transit stops
ma_rtBuff1mile <- st_buffer(mbta_rtStops_sf,dist = 1609.34) %>% 
  st_union() %>% 
  st_as_sf()
# identify block groups that do not intersect with 1 mile buffer
ma_blkgrps_sf_noRT <- ma_blkgrps_developed %>% 
  filter(st_disjoint(.,ma_rtBuff1mile,sparse = FALSE))
# create simplified version of block groups for faster mapping
ma_blkgrps_sf_noRT_simple <- ma_blkgrps_sf_noRT %>% 
  select(NewPop:NewMA_ENGLISH) %>% 
  st_simplify(., dTolerance = 100) %>% 
  filter(!st_is_empty(.)) %>% 
  st_make_valid()
# identify tracts that do not intersect with 1 mile buffer
ma_tracts_sf_noRT <- ma_tracts_developed %>% 
  filter(st_disjoint(.,ma_rtBuff1mile,sparse = FALSE))
# create simplified version of tracts for faster mapping
ma_tracts_sf_noRT_simple <- ma_tracts_sf_noRT %>% 
  select(NewDisabled:NewHHNoCar) %>% 
  st_simplify(., dTolerance = 100) %>% 
  filter(!st_is_empty(.)) %>% 
  st_make_valid()


# Identify areas >= 10 miles from commuter rail or park-n-ride stops
ma_crprBuff10mile <- ma_transitStopsAll_sf %>% 
  filter(TYPE %in% c("Park-in-Ride","Commuter Rail")) %>% 
  st_buffer(., dist = (10*1609.34)) %>% 
  st_union() %>% 
  st_as_sf()
# identify block groups that do not intersect with 10 mile buffer
ma_blkgrps_sf_noCRPR <- ma_blkgrps_developed %>% 
  filter(st_disjoint(.,ma_crprBuff10mile,sparse = FALSE))
# create simplified version of block groups for faster mapping
ma_blkgrps_sf_noCRPR_simple <- ma_blkgrps_sf_noCRPR %>% 
  select(NewPop:NewMA_ENGLISH) %>% 
  st_simplify(., dTolerance = 100) %>% 
  filter(!st_is_empty(.)) %>% 
  st_make_valid()

# identify tracts that do not intersect with 10 mile buffer
ma_tracts_sf_noCRPR <- ma_tracts_developed %>% 
  filter(st_disjoint(.,ma_crprBuff10mile,sparse = FALSE))
# create simplified version of tracts for faster mapping
ma_tracts_sf_noCRPR_simple <- ma_tracts_sf_noCRPR %>% 
  select(NewDisabled:NewHHNoCar) %>% 
  st_simplify(., dTolerance = 100) %>% 
  filter(!st_is_empty(.)) %>% 
  st_make_valid()

# Identify areas with no access to any type of transit stop. Union all buffers to create one buffer and clip to state boundary. 
ma_transitBuffAll <- rbind(ma_busBuff1mile,
                             ma_rtBuff1mile,
                             ma_crprBuff10mile) %>% 
  st_union() %>% 
  st_as_sf() %>% 
  tmaptools::crop_shape(.,ma_state_sf_cb,polygon = TRUE)

# identify block groups that do not intersect with any transit buffer
ma_blkgrps_sf_noTransit <- ma_blkgrps_developed %>% 
  filter(st_disjoint(.,ma_transitBuffAll,sparse = FALSE))
# identify tracts that do not intersect with 5 mile buffer
ma_tracts_sf_noTransit <- ma_tracts_developed %>% 
  filter(st_disjoint(.,ma_transitBuffAll,sparse = FALSE))
# create simplified versions for faster mapping
ma_blkgrps_sf_noTransit_simple <- ma_blkgrps_sf_noTransit %>% 
  st_simplify(., dTolerance = 100) %>% 
  filter(!st_is_empty(.)) %>% 
  st_make_valid()
ma_tracts_sf_noTransit_simple <- ma_tracts_sf_noTransit %>% 
  st_simplify(., dTolerance = 100) %>% 
  filter(!st_is_empty(.)) %>% 
  st_make_valid()

# # write out to file for later analysis
# save(ma_blkgrps_sf_noTransit, ma_tracts_sf_noTransit, 
#      file = "DATA/transport/MA/noTransit.Rds")
```

## Access to Public Transit

This analysis seeks to identify communities that are underserved by access to public transit. Access to transit is measured in terms of distance to transit boarding stops and in terms of frequency of service. 

Massachusetts is served by `r length(unique(ma_busRoutesAll_sf$AGENCY))`
regional public transit agencies, as well as a number of private operators. These transit services include buses, rapid transit (i.e., subway or light rail), commuter rail, and park-in-ride lots served by public and private buses or shuttles. Amtrak train service passes through Massachusetts as well, but it is not included in this analysis. Ferry services, water taxis, and other seasonal transportation services are not considered in this analysis. The analysis below evaluates access to bus, rapid transit, and commuter rail separately, as well as access to any mode of transit. Figure \@ref(fig:transitMap) shows `r formatC(nrow(ma_busRoutesAll_sf),big.mark = ",")` fixed public transit routes across the state along with population density.

```{r transitMap, fig.align = "center", fig.cap="Transit service and population density in Massachusetts."}
# bbox_new <- st_bbox(ma_blkgrps_sf) # current bounding box
# 
# xrange <- bbox_new$xmax - bbox_new$xmin # range of x values
# yrange <- bbox_new$ymax - bbox_new$ymin # range of y values
# 
# # bbox_new[1] <- bbox_new[1] - (2.2 * xrange) # xmin - left
# # bbox_new[3] <- bbox_new[3] + (2 * xrange) # xmax - right
# bbox_new[2] <- bbox_new[2] - (0.2 * yrange) # ymin - bottom
# # bbox_new[4] <- bbox_new[4] + (2 * yrange) # ymax - top
# 
# bbox_new <- bbox_new %>%  # take the bounding box ...
#   st_as_sfc() # ... and make it a sf polygon

# # create simplified version to speed up mapping
# ma_blkgrps_developed_simple <- st_simplify(ma_blkgrps_developed, dTolerance = 100)
# 
# m <- tm_shape(ma_towns_sf, unit = "mi") +
#   tm_borders(col = "gray", lwd = 0.2) +
#   tm_shape(ma_blkgrps_developed_simple) +
#   tm_fill(col = "NewPopAcre", style = "quantile",
#           colorNA = "white", colorNULL = "gray", title = "Pop per Acre",
#           legend.format = list(fun = function(x) formatC(x, digits = 1, format = "f")), palette = "YlGn") +
#   tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) +
#   tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
#   tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
#   tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
#   tm_shape(ma_busRoutesAll_sf_simple) +
#   tm_lines(col = "coral", alpha = 0.5, lwd = 1) +
#   tm_shape(mbta_rtRoutes_sf) +
#   tm_lines(col = "darkblue", alpha = 0.5, lwd = 1) +
#   tm_shape(mbta_trainRoutes_sf) +
#   tm_lines(col = "red", alpha = 0.5, lwd = 1) +
#   tm_shape(ma_parknride_sf) + tm_dots(col = "red") +
#   tm_shape(I95roadSegment) +
#   tm_symbols(shape = I95, border.lwd = NA, size = .1) +
#   tm_shape(I95roadSegment2) +
#   tm_symbols(shape = I95, border.lwd = NA, size = .1) +
#   tm_shape(I395roadSegment) +
#   tm_symbols(shape = I395, border.lwd = NA, size = .1) +
#   tm_shape(I91roadSegment) +
#   tm_symbols(shape = I91, border.lwd = NA, size = .1) +
#   tm_shape(I495roadSegment) +
#   tm_symbols(shape = I495, border.lwd = NA, size = .1) +
#   tm_shape(I495roadSegment2) +
#   tm_symbols(shape = I495, border.lwd = NA, size = .1) +
#   tm_shape(I495roadSegment3) +
#   tm_symbols(shape = I495, border.lwd = NA, size = .1) +
#   tm_shape(I90roadSegment) +
#   tm_symbols(shape = I90, border.lwd = NA, size = .1) +
#   tm_shape(I90roadSegment2) +
#   tm_symbols(shape = I90, border.lwd = NA, size = .1) +
#   tm_shape(ma_towns_sf_pts) + tm_dots() +
#   tm_text("NAME", size = 0.5, col = "black",
#           xmod = 0.7, ymod = 0.2, shadow = TRUE) +
#   tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5,
#                position = c(0.6,0.005)) +
#   tm_add_legend(type = "line", labels = "Bus Routes", col = "coral") +
#   tm_add_legend(type = "line", labels = "Rapid Transit", col = "darkblue") +
#   tm_add_legend(type = "line", labels = "Commuter Rail", col = "red") +
#   tm_add_legend(type = "symbol", labels = "Park-in-Ride Lots", col = "red", size = 0.2) +
#   tm_layout(title = "Massachusetts\nTransit Routes\nand Population\nDensity",
#             frame = FALSE, main.title.size = 0.8,
#             legend.outside = TRUE,
#             legend.title.size = 0.8,
#             legend.outside.position = c("right", "top"))
# 
# tmap_save(m, "DATA/transport/MA/figures/ma_transit.png",
#           height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_transit.png")
```

Approximately `r paste0(round(ma_transitAccessPops_df %>% filter(Group == "Total Pop") %>% dplyr::select(PctBus) %>% pull(),1),"%")` of the state population lives within reasonable walking distance of a bus stop (defined as approximately 400 meters or 1/4 mile), 
 `r paste0(round(ma_transitAccessPops_df %>% filter(Group == "Total Pop") %>% dplyr::select(PctRapidTransit) %>% pull(),1),"%")` live within 1/2 mile of a rapid transit stop, `r paste0(round(ma_transitAccessPops_df %>% filter(Group == "Total Pop") %>% dplyr::select(PctCommuter) %>% pull(),1),"%")` live within 3 miles of a commuter rail stop, and `r paste0(round(ma_transitAccessPops_df %>% filter(Group == "Total Pop") %>% dplyr::select(PctAllTransit) %>% pull(),1),"%")` live within reasonable distance of any transit. 

However, this access varies by population group and by mode of transit. Figures \@ref(fig:loliBusDist) to \@ref(fig:loliAllTransitDist) below compare the percentages of different population groups living within reasonable walking distance of bus stops (1/4 mile), rapid transit (1/2 mile), and commuter rail or park-in-ride stops (3 miles) across the state, respectively. Most populations of concern, including transit-dependent groups, have access similar to or better than the general population. However, note that people over age 64 and under 18 have consistently less access to transit on average compared to the general population.

```{r loliBusDist, echo=FALSE, message=FALSE, warning=FALSE, fig.align = "center", fig.cap="Percentage of population groups within 1/4 mile (400 meters) of a bus stop across Massachusetts."}
ma_transitAccessPops_df %>% 
  ggplot(aes(x = reorder(Group,-PctBus), 
             y = PctBus)) +
  geom_segment(aes(x = reorder(Group,-PctBus), xend = reorder(Group,-PctBus),
                   y = ma_transitAccessPops_df[1,7], yend = PctBus), 
               color = "skyblue") +
  geom_point(color = "blue", size = 4, alpha = 0.8) +
  coord_flip() + xlab("") + ylab("") + ggtitle("Massachusetts Populations within Walking Distance\n(400m) of Bus Stops") + theme_light() +
  theme(panel.grid.major.y = element_blank(),
        panel.border = element_blank(),
        axis.ticks.y = element_blank()) +
  geom_text(aes(x = Group, y = PctBus + 0.2 * sign(PctBus), 
                label = paste0(round(PctBus,0),"%")), 
            hjust = -0.2, vjust = -.4, size = 3,
            color=rgb(100,100,100, maxColorValue=255)) +
  scale_y_continuous(labels = function(x) paste0(x, "%")) +
  geom_hline(yintercept = ma_transitAccessPops_df[1,7], linetype = "dashed") +
  geom_text(aes(x = "Total Pop", y = 69, label = "Above state\naverage"),
            color = "gray48") +
  geom_text(aes(x = "Total Pop", y = 35, label = "Below state\naverage"),
            color = "gray48") +
  expand_limits(y = c(30,96))
```

```{r loliRTDist, echo=FALSE, message=FALSE, warning=FALSE, fig.align = "center", fig.cap="Percentage of population groups within 1/2 mile (800 meters) of a rapid transit stop across Massachusetts."}
ma_transitAccessPops_df %>% 
  ggplot(aes(x = reorder(Group,-PctRapidTransit), 
             y = PctRapidTransit)) +
  geom_segment(aes(x = reorder(Group,-PctRapidTransit), xend = reorder(Group,-PctRapidTransit),
                   y = ma_transitAccessPops_df[1,8], yend = PctRapidTransit), 
               color = "skyblue") +
  geom_point(color = "blue", size = 4, alpha = 0.8) +
  coord_flip() + xlab("") + ylab("") + ggtitle("Massachusetts Populations within 1/2 mile\n(800m) of Rapid Transit Stops") + theme_light() +
  theme(panel.grid.major.y = element_blank(),
        panel.border = element_blank(),
        axis.ticks.y = element_blank()) +
  geom_text(aes(x = Group, y = PctRapidTransit + 0.2 * sign(PctRapidTransit), 
                label = paste0(round(PctRapidTransit,0),"%")), 
            hjust = -0.2, vjust = -.4, size = 3,
            color=rgb(100,100,100, maxColorValue=255)) +
  scale_y_continuous(labels = function(x) paste0(x, "%")) +
  geom_hline(yintercept = ma_transitAccessPops_df[1,8], linetype = "dashed") +
  geom_text(aes(x = "Total Pop", y = 18, label = "Above state\naverage"),
            color = "gray48") +
  geom_text(aes(x = "Total Pop", y = 5, label = "Below state\naverage"),
            color = "gray48") +
  expand_limits(y = c(0,35))
```

```{r loliCRDist, echo=FALSE, message=FALSE, warning=FALSE, fig.align = "center", fig.cap="Percentage of population groups within 3 miles (4800 meters) of a commuter rail stop or park-in-ride lot across Massachusetts."}
ma_transitAccessPops_df %>% 
  ggplot(aes(x = reorder(Group,-PctCommuter), 
             y = PctCommuter)) +
  geom_segment(aes(x = reorder(Group,-PctCommuter), xend = reorder(Group,-PctCommuter),
                   y = ma_transitAccessPops_df[1,9], yend = PctCommuter), 
               color = "skyblue") +
  geom_point(color = "blue", size = 4, alpha = 0.8) +
  coord_flip() + xlab("") + ylab("") + ggtitle("Massachusetts Populations within 3 miles (4800m)\nof Commuter Rail Stops or Park-in-Ride Lots") + theme_light() +
  theme(panel.grid.major.y = element_blank(),
        panel.border = element_blank(),
        axis.ticks.y = element_blank()) +
  geom_text(aes(x = Group, y = PctCommuter + 0.2 * sign(PctCommuter), 
                label = paste0(round(PctCommuter,0),"%")), 
            hjust = -0.2, vjust = -.4, size = 3,
            color=rgb(100,100,100, maxColorValue=255)) +
  scale_y_continuous(labels = function(x) paste0(x, "%")) +
  geom_hline(yintercept = ma_transitAccessPops_df[1,9], linetype = "dashed") +
  geom_text(aes(x = "Total Pop", y = 75, label = "Above state\naverage"),
            color = "gray48") +
  geom_text(aes(x = "Total Pop", y = 58, label = "Below state\naverage"),
            color = "gray48") +
  expand_limits(y = c(55,90))
```

```{r loliAllTransitDist, echo=FALSE, message=FALSE, warning=FALSE, fig.align = "center", fig.cap="Percentage of population groups with access to any transit stops across Massachusetts, based on reasonable distances for each mode."}
ma_transitAccessPops_df %>% 
  ggplot(aes(x = reorder(Group,-PctAllTransit), 
             y = PctAllTransit)) +
  geom_segment(aes(x = reorder(Group,-PctAllTransit), xend = reorder(Group,-PctAllTransit),
                   y = ma_transitAccessPops_df[1,10], yend = PctAllTransit), 
               color = "skyblue") +
  geom_point(color = "blue", size = 4, alpha = 0.8) +
  coord_flip() + xlab("") + ylab("") + ggtitle("Massachusetts Populations with Access to\nany Transit Stops") + theme_light() +
  theme(panel.grid.major.y = element_blank(),
        panel.border = element_blank(),
        axis.ticks.y = element_blank()) +
  geom_text(aes(x = Group, y = PctAllTransit + 0.2 * sign(PctAllTransit), 
                label = paste0(round(PctAllTransit,0),"%")), 
            hjust = -0.2, vjust = -.4, size = 3,
            color=rgb(100,100,100, maxColorValue=255)) +
  scale_y_continuous(labels = function(x) paste0(x, "%")) +
  geom_hline(yintercept = ma_transitAccessPops_df[1,10], linetype = "dashed") +
  geom_text(aes(x = "Total Pop", y = 85, label = "Above state\naverage"),
            color = "gray48") +
  geom_text(aes(x = "Total Pop", y = 68, label = "Below state\naverage"),
            color = "gray48") +
  expand_limits(y = c(65,100))
```

Specific values of the same can be seen in Table \@ref(tab:statsTransitDist) below.

```{r statsTransitDist, echo=FALSE, message=FALSE, warning=FALSE, fig.align = "center", fig.cap="Massachusetts populations living within 1/4 mile (400 meters) of a bus stop. Based on ACS 2018 Block Group data."}
# See table of distance by group
ma_transitAccessPops_df %>% 
  mutate(PctBus = paste0(round(PctBus,1),"%"),
         PctRapidTransit = paste0(round(PctRapidTransit,1),"%"),
         PctCommuter = paste0(round(PctCommuter,1),"%"),
         PctAllTransit = paste0(round(PctAllTransit,1),"%")) %>% 
  kableExtra::kable(longtable = T, booktabs = T, 
                    format.args = list(big.mark = ','), align = "r",
                    caption = "Populations with Access to Transit", 
                    col.names = c("Group","MA Pop","Bus","Rapid Transit","Comm Rail*","Any Transit","Bus","Rapid Transit","Comm Rail*","Any Transit")) %>% 
  kableExtra::column_spec(1:3, width = "1.7cm") %>%
  kableExtra::column_spec(4:10, width = "1.2cm") %>%
  kableExtra::add_header_above(c(" " = 2, "Total Pop with Access" = 4, "Pct Pop with Access" = 4)) %>% 
  kableExtra::footnote(general = "Access is 400m from bus stop, 800m from rapid transit stop, or 4800m from commuter rail stop.", symbol = "Commuter Rail includes Park-in-Ride lots") %>% 
  kableExtra::kable_styling(latex_options = c("repeat_header","striped"))
```

The population percentages above provide a glimpse of average access to public transit across the state for different population groups. However, access also varies for specific communities. Indeed, it is important to consider vulnerable populations or transportation-limited populations that do not have reasonable access to transit. 

```{r TransitNoAccess, include=FALSE}
BusNoAccess1 <- ma_blkgrps_sf_noBus %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Over 64` = sum(NewOver64,na.rm = TRUE),
            `Pct of Over 64` = round(sum(NewOver64)/max(TotalOver64)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  mutate(`Pct of Over 64` = paste0(`Pct of Over 64`,"%")) %>% 
  arrange(desc(`Over 64`))

BusNoAccess2 <- ma_blkgrps_sf_noBus %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Under 18` = sum(NewUnder18,na.rm = TRUE),
            `Pct of Under 18` = round(sum(NewUnder18)/max(TotalUnder18)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  mutate(`Pct of Under 18` = paste0(`Pct of Under 18`,"%")) %>% 
  arrange(desc(`Under 18`))

RapidTransitNoAccess1 <- ma_blkgrps_sf_noRT %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Over 64` = sum(NewOver64,na.rm = TRUE),
            `Pct of Over 64` = round(sum(NewOver64)/max(TotalOver64)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  mutate(`Pct of Over 64` = paste0(`Pct of Over 64`,"%")) %>% 
  arrange(desc(`Over 64`))

RapidTransitNoAccess2 <- ma_blkgrps_sf_noRT %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Under 18` = sum(NewUnder18,na.rm = TRUE),
            `Pct of Under 18` = round(sum(NewUnder18)/max(TotalUnder18)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  mutate(`Pct of Under 18` = paste0(`Pct of Under 18`,"%")) %>% 
  arrange(desc(`Under 18`))

CommuterNoAccess1 <- ma_blkgrps_sf_noCRPR %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Over 64` = sum(NewOver64,na.rm = TRUE),
            `Pct of Over 64` = round(sum(NewOver64)/max(TotalOver64)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  mutate(`Pct of Over 64` = paste0(`Pct of Over 64`,"%")) %>% 
  arrange(desc(`Over 64`))

CommuterNoAccess2 <- ma_tracts_sf_noCRPR %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Tracts` = n(),
            Disabled = sum(NewDisabled,na.rm = TRUE),
            `Pct of Disabled` = round(sum(NewDisabled)/max(TotalDisabled)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  mutate(`Pct of Disabled` = paste0(`Pct of Disabled`,"%")) %>% 
  arrange(desc(Disabled))

TransitNoAccess1 <- ma_blkgrps_sf_noTransit %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Over 64` = sum(NewOver64,na.rm = TRUE),
            `Pct of Over 64` = round(sum(NewOver64)/max(TotalOver64)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  mutate(`Pct of Over 64` = paste0(`Pct of Over 64`,"%")) %>% 
  arrange(desc(`Over 64`))

TransitNoAccess2 <- ma_blkgrps_sf_noTransit %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Under 18` = sum(NewUnder18,na.rm = TRUE),
            `Pct of Under 18` = round(sum(NewUnder18)/max(TotalUnder18)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  mutate(`Pct of Under 18` = paste0(`Pct of Under 18`,"%")) %>% 
  arrange(desc(`Under 18`))
```
Figures \@ref(fig:mapBusAccessO64) to \@ref(fig:mapTransitAccessO64) below highlight developed portions of Census Block Groups across Massachusetts without reasonable access to bus, rapid transit, commuter rail and park-in-ride lots, or any mode of transit, respectively, and the numbers of persons over 64 who live there. Tables \@ref(tab:tabBusAccessO64) to \@ref(tab:tabTransitAccessO64) show breakdowns of the same by municipality. For example, Table \@ref(tab:tabBusAccessO64) shows that `r formatC(as.numeric(BusNoAccess1[1,3]),big.mark=",")` people over 64 across `r BusNoAccess1[1,2]` Block Groups in `r BusNoAccess1[1,1]` resided one or more miles from the nearest bust stop. These people represented `r BusNoAccess1[1,4]` of people over 64 in `r BusNoAccess1[1,1]`. Similarly, Table \@ref(tab:tabTransitAccessO64) shows that `r formatC(as.numeric(TransitNoAccess1[1,3]),big.mark=",")` people over 64 across `r TransitNoAccess1[1,2]` Block Groups in `r TransitNoAccess1[1,1]` resided one or more miles from the nearest transit stop for any mode. These people represented `r TransitNoAccess1[1,4]` of people over 64 in `r TransitNoAccess1[1,1]`.
Maps and tables of other populations of concern without access to the various modes of transit can be found in Appendix B.

```{r mapBusAccessO64, fig.align = "center", fig.cap="Persons over 64 who are one or more miles from the nearest bus stop by Census Block Group."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") +
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_blkgrps_sf_noBus_simple, unit = "mi") +
  tm_fill(col = "NewOver64", style = "quantile",
          colorNA = "white", colorNULL = "gray", title = "Number of\nPersons Over 64",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) +
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_busRoutesAll_sf_simple) +
  # tm_lines(lwd = 2, alpha = 0.3, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black",
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5,
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.7, labels = "Bus Route", col = "darkblue") +
  tm_layout(title = "Persons Over 64\n1+ Miles from\nNearest Bus\nStop",
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_busO64access.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_busO64access.png")
```

```{r tabBusAccessO64, fig.align = "center", fig.cap="Persons over 64 in Census Block Groups one or more miles from the nearest bus stop."}
ma_blkgrps_sf_noBus %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Over 64` = sum(NewOver64,na.rm = TRUE),
            `Pct of Over 64` = round(sum(NewOver64)/max(TotalOver64)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Over 64` > 0) %>% 
  mutate(`Pct of Over 64` = if_else(`Pct of Over 64` > 100, 100, `Pct of Over 64`)) %>% 
  mutate(`Pct of Over 64` = paste0(`Pct of Over 64`,"%")) %>% 
  arrange(desc(`Over 64`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Persons Over 64 One or More Miles from Nearest Bus Stop", align = "r", 
                    col.names = c(names(.)[1:2],"Number of Over 64 in Block Groups","Pct of Over 64 in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapRTAccessO64, fig.align = "center", fig.cap="Persons over 64 who are one or more miles from the nearest rapid transit stop by Census Block Group."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") +
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_blkgrps_sf_noRT_simple, unit = "mi") +
  tm_fill(col = "NewOver64", style = "quantile",
          colorNA = "white", colorNULL = "gray", title = "Number of\nPersons Over 64",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_tracts_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) +
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(mbta_rtRoutes_sf) +
  # tm_lines(lwd = 2, alpha = 0.5, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black",
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5,
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Rapid Transit Route", col = "darkblue") +
  tm_layout(title = "Persons Over 64\n1+ Miles from\nNearest Rapid\nTransit Stop",
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_RTO64access.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_RTO64access.png")
```

```{r tabRTAccessO64, fig.align = "center", fig.cap="Persons over 64 in Census Block Groups one or more miles from the nearest rapid transit stop."}
ma_blkgrps_sf_noRT %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Over 64` = sum(NewOver64,na.rm = TRUE),
            `Pct of Over 64` = round(sum(NewOver64)/max(TotalOver64)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Over 64` > 0) %>% 
  mutate(`Pct of Over 64` = if_else(`Pct of Over 64` > 100, 100, `Pct of Over 64`)) %>%
  mutate(`Pct of Over 64` = paste0(`Pct of Over 64`,"%")) %>% 
  arrange(desc(`Over 64`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Persons Over 64 One or More Miles from Nearest Rapid Transit Stop", align = "r", col.names = c(names(.)[1:2],"Number of Over 64 in Census Block Groups","Pct of Over 64 in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapCRPRAccessO64, fig.align = "center", fig.cap="Persons over 64 who are ten or more miles from the nearest commuter rail stop or park-in-ride lot by Census Block Group."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") +
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_blkgrps_sf_noCRPR_simple, unit = "mi") +
  tm_fill(col = "NewOver64", style = "quantile",
          colorNA = "white", colorNULL = "gray", title = "Number of\nPersons Over 64",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_tracts_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) +
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(mbta_trainRoutes_sf) +
  tm_lines(lwd = 2, alpha = 0.5, col = "darkblue") +
  tm_shape(ma_parknride_sf) + tm_dots(col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black",
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5,
               position = c(0.6,0.005)) +
  tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Commuter Rail Route", col = "darkblue") +
  tm_add_legend(type = "symbol", size=0.2, alpha = 0.5, labels = "Park-in-Ride Lot", col = "darkblue") +
  tm_layout(title = "Persons Over 64\n10+ Miles from\nNearest Commuter\nRail Stop\nor Park-in-Ride Lot",
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_CRPRO64access.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_CRPRO64access.png")
```

```{r tabCRPRAccessO64, fig.align = "center", fig.cap="Persons over 64 in Census Block Groups ten or more miles from the nearest commuter rail stop or park-in-ride lot."}
ma_blkgrps_sf_noCRPR %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Over 64` = sum(NewOver64,na.rm = TRUE),
            `Pct of Over 64` = round(sum(NewOver64)/max(TotalOver64)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Over 64` > 0) %>% 
  mutate(`Pct of Over 64` = if_else(`Pct of Over 64` > 100, 100, `Pct of Over 64`)) %>%
  mutate(`Pct of Over 64` = paste0(`Pct of Over 64`,"%")) %>% 
  arrange(desc(`Over 64`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Persons Over 64 Ten or More Miles from Nearest Commuter Rail Stop or Park-in-Ride Lot", align = "r", col.names = c(names(.)[1:2],"Number of Over 64 in Census Block Groups","Pct of Over 64 in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapTransitAccessO64, fig.align = "center", fig.cap="Persons over 64 without reasonable access to any form of transit by Census Block Group based on reasonable distances for each mode."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") +
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_blkgrps_sf_noTransit_simple, unit = "mi") +
  tm_fill(col = "NewOver64", style = "quantile",
          colorNA = "white", colorNULL = "gray", title = "Number of\nPersons Over 64",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_tracts_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) +
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_busRoutesAll_sf_simple) + tm_lines(col = "black") +
  # tm_shape(mbta_rtRoutes_sf) + tm_lines(col = "black") +
  # tm_shape(mbta_trainRoutes_sf) +
  # tm_lines(lwd = 2, alpha = 0.5, col = "darkblue") +
  # tm_shape(ma_parknride_sf) + tm_dots(col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black",
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5,
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Bus/Rapid Transit Route", col = "black") +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Commuter Rail Route", col = "darkblue") +
  # tm_add_legend(type = "symbol", size=0.2, alpha = 0.5, labels = "Park-in-Ride Lot", col = "darkblue") +
  tm_layout(title = "Persons Over 64\nwithout Reasonable\nAccess to any\nMode of Transit",
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_transitO64access.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_transitO64access.png")
```

```{r tabTransitAccessO64, fig.align = "center", fig.cap="Persons over 64 in Census Block Groups without reasonable access to any mode of transit."}
ma_blkgrps_sf_noTransit %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Over 64` = sum(NewOver64,na.rm = TRUE),
            `Pct of Over 64` = round(sum(NewOver64)/max(TotalOver64)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Over 64` > 0) %>% 
  mutate(`Pct of Over 64` = if_else(`Pct of Over 64` > 100,100,`Pct of Over 64`)) %>% 
  mutate(`Pct of Over 64` = paste0(`Pct of Over 64`,"%")) %>% 
  arrange(desc(`Over 64`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Persons Over 64 without Access to any Mode of Transit", align = "r", col.names = c(names(.)[1:2],"Number of Over 64 in Census Block Groups","Pct of Over 64 in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```


## Frequency of Transit Service
The quality of access to public transit can also be assessed by the level or frequency of service, which is measured by "headway." Headway describes the time between transit vehicle arrivals at a transit stop. For example, a bus route with a 15 minute headway would mean that the bus arrives at a given stop four times an hour (it's frequency), or once every 15 minutes. Transit headways are affected by the scheduled frequency of service, the number of vehicles on a given route, traffic delays, and dispatch management of vehicle spacing.[^mindGap] Headways are significant because they affect the desirability and useability of transit service.[^headways] Headways can affect:

* average wait times
* the amount of planning and preparation needed to use transit and stay on schedule
* the amount of time lost when transit schedules do not directly conform to work, school, or activity schedules
* the time penalty for missing a train or bus
* public use or support of transit

Headways are significant for transit dependent populations and can affect the quality of life and economic opportunities of transit riders. Figure \@ref(fig:mapGTFSbus) below shows average scheduled headways for bus routes throughout Massachusetts.[^headwayReal] Headways vary significantly by route and by type of service across the state. 

```{r GTFS, include=FALSE}
# Read in MA GTFS data
# Need to read in GTFS separately for each regional transit authority
# acquire URL for each GTFS archive feed from https://www.mass.gov/lists/mbta-and-transit-data-for-developers

# mbtaGTFSurl <- read_csv("https://cdn.mbta.com/archive/archived_feeds.txt") %>% 
#   filter(feed_start_date == 20190607) %>% 
#   select(archive_url) %>% 
#   pull()
# 
# download.file(mbtaGTFSurl,"DATA/transport/MA/MA_gtfs_files/mbta_transit.zip")
# download.file(url = "http://data.trilliumtransit.com/gtfs/berkshire-ma-us/berkshire-ma-us.zip", "DATA/transport/MA/MA_gtfs_files/berkshireRTA.zip")
# download.file(url = "http://data.trilliumtransit.com/gtfs/brockton-ma-us/brockton-ma-us.zip", "DATA/transport/MA/MA_gtfs_files/brocktonRTA.zip")
# download.file(url = "http://data.trilliumtransit.com/gtfs/capeann-ma-us/capeann-ma-us.zip", "DATA/transport/MA/MA_gtfs_files/capeannRTA.zip")
# download.file(url = "http://data.trilliumtransit.com/gtfs/capecod-ma-us/capecod-ma-us.zip", "DATA/transport/MA/MA_gtfs_files/capecodRTA.zip")
# download.file(url = "http://data.trilliumtransit.com/gtfs/gatra-ma-us/gatra-ma-us.zip", "DATA/transport/MA/MA_gtfs_files/tauntonattleboroRTA.zip")
# download.file(url = "http://data.trilliumtransit.com/gtfs/lowell-ma-us/lowell-ma-us.zip", "DATA/transport/MA/MA_gtfs_files/lowellRTA.zip")
# download.file(url = "http://data.trilliumtransit.com/gtfs/merrimackvalley-ma-us/merrimackvalley-ma-us.zip", "DATA/transport/MA/MA_gtfs_files/merrimackvalleyRTA.zip")
# download.file(url = "http://vc.mwrta.com/gtfs/google_transit.zip", "DATA/transport/MA/MA_gtfs_files/metrowestRTA.zip")
# download.file(url = "http://data.trilliumtransit.com/gtfs/montachusett-ma-us/montachusett-ma-us.zip", "DATA/transport/MA/MA_gtfs_files/montachusettRTA.zip")
# download.file(url = "http://data.trilliumtransit.com/gtfs/nantucket-ma-us/nantucket-ma-us.zip", "DATA/transport/MA/MA_gtfs_files/nantucketRTA.zip")
# download.file(url = "http://www.pvta.com/g_trans/google_transit.zip", "DATA/transport/MA/MA_gtfs_files/pioneervalleyRTA.zip")
# download.file(url = "http://data.trilliumtransit.com/gtfs/srta-ma-us/srta-ma-us.zip", "DATA/transport/MA/MA_gtfs_files/southeasternRTA.zip")
# download.file(url = "http://data.trilliumtransit.com/gtfs/marthasvineyard-ma-us/marthasvineyard-ma-us.zip", "DATA/transport/MA/MA_gtfs_files/vineyardTA.zip")
# download.file(url = "http://data.trilliumtransit.com/gtfs/wrta-ma-us/wrta-ma-us.zip", "DATA/transport/MA/MA_gtfs_files/worcesterRTA.zip")

# Process MBTA GTFS separately because it errors out
mbta_transit <- read_gtfs("DATA/transport/MA/MA_gtfs_files/mbta_transit.zip")

# filter out stops with missing coordinates, otherwise tidytransit errors
transit_stops <- mbta_transit$stops %>% 
  filter(stop_lat > 0)

# replace stops list item with filtered df
mbta_transit$stops <- transit_stops

# create sf object from gtfs
mbta_transit <- gtfs_as_sf(mbta_transit)

# create list of downloaded GTFS files
fileList <- as.list(list.files("DATA/transport/MA/MA_gtfs_files/", pattern = ".zip", full.names = TRUE))

# extract just file names without extension
fileListNames <- lapply(fileList, 
                        function(x) fs::path_ext_remove(fs::path_file(x)))

# name items in fileList
fileList <- setNames(fileList,fileListNames)

# read in each file to gtfs, skipping mbta since it had to be processed separately
RTA_gtfs_list <- lapply(fileList[-7], 
                         function(x) read_gtfs(x) %>% 
                           gtfs_as_sf(.))

# add mbta_transit back to list
RTA_gtfs_list$mbta_transit <- mbta_transit

# sort list items back into alphabetical order
RTA_gtfs_list <- RTA_gtfs_list[order(names(RTA_gtfs_list))]

# # create a list of gtfs objects for batch processing
# RTA_gtfs_list <- mget(ls(pattern = "TA|mbta_transit"))

# add a table to the feed that indicates which service_id runs on which date. This is later useful for linking dates and trips via service_id.
# mbta_transit <- set_date_service_table(mbta_transit)
RTA_gtfs_list <- lapply(RTA_gtfs_list, set_date_service_table)

# To understand service patterns better we need information on weekdays and holidays. With a calendar table we know the weekday and possible holidays for each date.
# holidays = tribble(~date, ~holiday,
#                    ymd("2019-07-04"), "Independence Day",
#                    ymd("2019-09-02"), "Labor Day",
#                    ymd("2019-12-25"), "Christmas")
# 
# calendar = tibble(date = unique(mbta_transit$.$date_service_table$date)) %>% 
#   mutate(
#     weekday = (function(date) {
#       c("Sunday", "Monday", "Tuesday", 
#         "Wednesday", "Thursday", "Friday", 
#         "Saturday")[as.POSIXlt(date)$wday + 1]
#     })(date)
#   )
# 
# calendar <- calendar %>% left_join(holidays, by = "date")

# create a function to generate calendar and join to date_servicepattern_table
calendarFunction <- function(thing) {
  tibble(date = unique(thing$.$date_service_table$date)) %>% 
  mutate(
    weekday = (function(date) {
      c("Sunday", "Monday", "Tuesday", 
        "Wednesday", "Thursday", "Friday", 
        "Saturday")[as.POSIXlt(date)$wday + 1]
    })(date)
  ) %>% 
    left_join(x = thing$.$date_servicepattern_table,y = ., by = "date", copy=TRUE)
}

# To analyse on which dates trips run and to group similar services we use service patterns. Such a pattern simply lists all dates a trip runs on. To handle these patterns we create a servicepattern_id using a hash function. 
# ma_transit <- set_servicepattern(ma_transit)
# iterate over list
RTA_gtfs_list <- lapply(RTA_gtfs_list, set_servicepattern)

# Our gtfs feed now contains the data frame service_pattern which links each servicepattern_id to an existing service_id (and by extension trip_id).
# Understand patterns of service by visualising the data.
# date_servicepattern_table <- ma_transit$.$date_servicepattern_table %>%
#   left_join(calendar, by = "date")
# Iterate over list to generate service pattern tables
date_servicepattern_table_list <- lapply(X = RTA_gtfs_list, calendarFunction)
# 
# ggplot(date_servicepattern_table) + theme_bw() +
#   geom_point(aes(x = date, y = servicepattern_id, color = weekday), size = 1) +
#   scale_x_date(breaks = scales::date_breaks("1 month")) +
#   theme(legend.position = "bottom")

# This part has to be done manually for each item. sigh.
# create function to generate service pattern graph for each item
ggplotPatterns <- function (x) {
  ggplot(x) + theme_bw() +
  geom_point(aes(x = date, y = servicepattern_id, color = weekday), size = 1) +
  scale_x_date(breaks = scales::date_breaks("1 month")) +
  theme(legend.position = "bottom")
}
# iterate through list and create plot for each
ggplotServicePatterns <- lapply(date_servicepattern_table_list, ggplotPatterns)


# Use service pattern id for daily M-F service selected based on graphic. CHECK GGPLOT ABOVE TO GET CORRECT SERVICE PATTERN ID!
# create a vector of service pattern ids for each RTA
berkshireRTAspids <- c("s_578a240","s_0667cb3")
brocktonRTAspids <- c("s_c5b4449","s_0e5f5e4")
capeannRTAspids <- "s_f9674a5"
capecodRTAspids <- c("s_92f939c","s_559362d")
franklinRTAspids <- "s_6a977fe"
lowellRTAspids <- "s_da1bdfe"
mbta_transitspids <- c("s_f0a3545","s_efe46c3","s_c7d3f58","s_624a498",
                       "s_4aa14cc","s_08d9796","s_0a35a14")
merrimackvalleyRTAspids <- "s_b9dae72"
metrowestRTAspids <- "s_1df5c10"
montachusettRTAspids <- c("s_f9560c9","s_e7f8954","s_1ccc3b3")
nantucketRTAspids <- c("s_95e2831","s_8f4f1a8","s_2baf5ab","s_0eca321")
pioneervalleyRTAspids <- "s_7d17666"
southeasternRTAspids <- c("s_bcba0a1","s_b73ce61")
tauntonattleboroRTAspids <- c("s_e52891a","s_da1bdfe")
vineyardTAspids <- "s_17a5cd4"
worcesterRTAspids <- c("s_9506cfc","s_3ef40a2")
# create the list. make sure to remove spids_list before running, otherwise it gets included in the list!
spids_list <- mget(ls(pattern = "spids"))

# service_ids <- ma_transit$.$service_pattern %>% 
#   filter(servicepattern_id %in% c("s_f0a3545","s_624a498","s_0a35a14")) %>% 
#   pull(service_id)

# # create a function to extract service ids
# service_ids_map <- function(x, y) {
#   x$.$service_pattern %>% 
#     filter(servicepattern_id %in% y) %>% 
#     pull(service_id)
# }
# iterate over list items
service_ids_list <- map2(RTA_gtfs_list,spids_list, 
                         function(x,y) x$.$service_pattern %>%
                           filter(servicepattern_id %in% y) %>% 
                           pull(service_id))

# now that weve identified the set of service_ids that refer to all weekday trips, we can summarize service between 6 am and 9 pm for bus service on weekdays.
# daily_stop_freq <- get_stop_frequency(ma_transit, start_hour = 6, end_hour = 21,
#                                       service_ids = service_ids)

# # create a function to summarize service for desired time period
# daily_stop_freq_map <- function(x,y) {
#   get_stop_frequency(x, start_hour = 6, end_hour = 21, service_ids = y)
# }

# iterate over list items
daily_stop_freq_list <- map2(RTA_gtfs_list,service_ids_list,
                              function(x,y) get_stop_frequency(x, start_hour = 6, end_hour = 21, service_ids = y))

# # Convert stops to points for mapping
# ma_transit_stops_sf <- stops_as_sf(ma_transit$stops)
# Convert stops to points for mapping for each item in list
ma_transit_stops_sf_list <- lapply(X = RTA_gtfs_list, function(x) stops_as_sf(x$stops))

# Join headway frequencies to stops and route descriptions
# ma_transit_stops_sf <- ma_transit_stops_sf %>% 
#   inner_join(daily_stop_freq, by = "stop_id") %>% 
#   inner_join(ma_transit$routes, by = "route_id")
# first, join headway frequencies
ma_transit_stops_sf_list <- map2(ma_transit_stops_sf_list,daily_stop_freq_list,
                                 function(x,y) x %>% 
                                   inner_join(y, by = "stop_id"))
# next, join route descriptions
ma_transit_stops_sf_list <- map2(ma_transit_stops_sf_list,RTA_gtfs_list,
                                 function(x,y) x %>% 
                                   inner_join(y$routes, by = "route_id"))

# map it out
# tmap_mode("view")
# tm_shape(ma_transit_stops_sf) + tm_dots(col = "headway", alpha = 0.6)

# use the get_route_frequency function to summarize transit service by route, for the same time period.
# daily_route_freq <- get_route_frequency(ma_transit, service_ids = service_ids,
#                                         start_hour = 6, end_hour = 21)
# iterate over list items
daily_route_freq_list <- map2(RTA_gtfs_list,service_ids_list, 
                              function(x,y) 
                                get_route_frequency(x, service_ids = y))

# Join the route frequencies to geometry for mapping
# get_route_geometry needs a gtfs object that includes shapes as simple feature data frames
# ma_routes_sf <- get_route_geometry(ma_transit, service_ids = service_ids)

# iterate over list to extract route geometry
# need to skip franklinRTA because it's missing route shapes
ma_routes_sf_list <- map2(RTA_gtfs_list[-5],service_ids_list[-5], 
                          function(x,y) get_route_geometry(x, service_ids = y))

# join calculated frequencies to geometry and route descriptions
# ma_routes_sf <- ma_routes_sf %>% 
#   inner_join(daily_route_freq, by = "route_id") %>% 
#   inner_join(ma_transit$routes, by = "route_id")
# first, join calculated frequencies to geometry. Again, skip franklinRTA
ma_routes_sf_list <- map2(ma_routes_sf_list, daily_route_freq_list[-5],
                          function(x,y) inner_join(x,y, by = "route_id"))
# next, join route descriptions to allow filtering
ma_routes_sf_list <- map2(ma_routes_sf_list,RTA_gtfs_list[-5], 
                          function(x,y) 
                            inner_join(x,y$routes, by = "route_id"))

# separate bus and rapid transit routes and stops
# ma_routes_sf_RT <- ma_routes_sf %>% 
#   filter(route_desc == "Rapid Transit")
# 
# ma_routes_sf_Bus <- ma_routes_sf %>% 
#   filter(route_desc != "Rapid Transit")

# Extract bus stops and routes and common set of variables and combine into one layer
ma_routes_sf_Bus <- lapply(ma_routes_sf_list, function(x) 
  filter(x, route_type == 3) %>%
    select(route_id:mean_headways,route_short_name,route_long_name)) %>% 
  do.call(rbind, .)

ma_stops_sf_Bus <- lapply(ma_transit_stops_sf_list, function(x)
  filter(x, route_type == 3) %>% 
    select(stop_id,headway)) %>% 
  do.call(rbind, .)

# Extract mbta rapid transit
ma_routes_sf_RT <- ma_routes_sf_list$mbta_transit %>% 
  filter(route_desc == "Rapid Transit")

ma_stops_sf_RT <- ma_transit_stops_sf_list$mbta_transit %>% 
  filter(route_desc == "Rapid Transit")

# Extract mbta commuter rail
ma_routes_sf_CR <- ma_routes_sf_list$mbta_transit %>% 
  filter(route_desc == "Commuter Rail")

ma_stops_sf_CR <- ma_transit_stops_sf_list$mbta_transit %>% 
  filter(route_desc == "Commuter Rail")

# Calculate average headway for block groups within walking distance of bus stops and then compute weighted average headway by population group
ma_bus_stopHeadway_df <- ma_stops_sf_Bus %>% 
  st_transform(., crs = 26986) %>% 
  st_join(., ma_busBuff400m_sf) %>% 
  as.data.frame() %>% 
  group_by(GEOID) %>% 
  summarize(AvgStopHeadway = mean(headway,na.rm = TRUE))
# Create same for tracts
ma_bus_stopHeadwayTracts_df <- ma_stops_sf_Bus %>% 
  st_transform(., crs = 26986) %>% 
  st_join(., ma_busBuff400mTracts_sf) %>% 
  as.data.frame() %>% 
  group_by(GEOID) %>% 
  summarize(AvgStopHeadway = mean(headway,na.rm = TRUE))
# Create version of ma_bus_stopHeadwayTracts_df for rbind
ma_bus_stopHeadwayTracts <- ma_bus_stopHeadwayTracts_df %>% 
  as.data.frame() %>% 
  left_join(ma_busBuff400mTracts_sf,.,by="GEOID") %>% 
  as.data.frame() %>% 
  transmute(Disabled = NewDisabled,
            `No Car HH` = NewNoCar,
            AvgStopHeadway) %>% 
  gather(key = Group, value = Pop, Disabled:`No Car HH`) %>% 
  group_by(Group) %>% 
  summarize(AvgWHeadway = weighted.mean(x = AvgStopHeadway, 
                                        w = Pop, na.rm = TRUE))

# Join stop average headway to block groups within buffer
ma_busHeadwayPops_df <- ma_busBuff400m_sf %>% 
  as.data.frame() %>% 
  left_join(.,ma_bus_stopHeadway_df, by = "GEOID") %>% 
  transmute(`Total Pop` = NewPop,
            Minority = NewMinority,
            `Under 5` = NewUnder5,
            `Over 64` = NewOver64,
            `Under 18` = NewUnder18,
            `English Limited HH` = NewEng_limit,
            `Low Income` = NewPov,
            `No HS Dip` = NewLths,
            `MA Low Income` = NewMA_LOWINC,
            `MA Minority` = NewMA_MINORITY,
            `MA Limited English HH` = NewMA_ENGLISH,
            AvgStopHeadway) %>% 
  gather(key = Group, value = Pop, `Total Pop`:`MA Limited English HH`) %>% 
  group_by(Group) %>% 
  summarize(AvgWHeadway = weighted.mean(x = AvgStopHeadway, 
                                        w = Pop, na.rm = TRUE)) %>% 
  rbind(.,ma_bus_stopHeadwayTracts)



# Calculate average headway for block groups with access to rapid transit stops and then compute weighted average headway by population group
ma_RT_stopHeadway_df <- ma_stops_sf_RT %>% 
  st_transform(., crs = 26986) %>% 
  st_join(., ma_rtBuff800m_sf) %>% 
  as.data.frame() %>% 
  group_by(GEOID) %>% 
  summarize(AvgStopHeadway = mean(headway,na.rm = TRUE))
# Create same for tracts
ma_RT_stopHeadwayTracts_df <- ma_stops_sf_RT %>% 
  st_transform(., crs = 26986) %>% 
  st_join(., ma_rtBuff800mTracts_sf) %>% 
  as.data.frame() %>% 
  group_by(GEOID) %>% 
  summarize(AvgStopHeadway = mean(headway,na.rm = TRUE))
# Create version of ma_bus_stopHeadwayTracts_df for rbind
ma_RT_stopHeadwayTracts <- ma_RT_stopHeadwayTracts_df %>% 
  as.data.frame() %>% 
  left_join(ma_rtBuff800mTracts_sf,.,by="GEOID") %>% 
  as.data.frame() %>% 
  transmute(Disabled = NewDisabled,
            `No Car HH` = NewNoCar,
            AvgStopHeadway) %>% 
  gather(key = Group, value = Pop, Disabled:`No Car HH`) %>% 
  group_by(Group) %>% 
  summarize(AvgWHeadway = weighted.mean(x = AvgStopHeadway, 
                                        w = Pop, na.rm = TRUE))

# Join stop average headway to block groups within buffer
ma_RTHeadwayPops_df <- ma_rtBuff800m_sf %>% 
  as.data.frame() %>% 
  left_join(.,ma_RT_stopHeadway_df, by = "GEOID") %>% 
  transmute(`Total Pop` = NewPop,
            Minority = NewMinority,
            `Under 5` = NewUnder5,
            `Over 64` = NewOver64,
            `Under 18` = NewUnder18,
            `English Limited HH` = NewEng_limit,
            `Low Income` = NewPov,
            `No HS Dip` = NewLths,
            `MA Low Income` = NewMA_LOWINC,
            `MA Minority` = NewMA_MINORITY,
            `MA Limited English HH` = NewMA_ENGLISH,
            AvgStopHeadway) %>% 
  gather(key = Group, value = Pop, `Total Pop`:`MA Limited English HH`) %>% 
  group_by(Group) %>% 
  summarize(AvgWHeadway = weighted.mean(x = AvgStopHeadway, 
                                        w = Pop, na.rm = TRUE)) %>% 
  rbind(.,ma_RT_stopHeadwayTracts)




# Calculate average headway for block groups with access to commuter rail stops and then compute weighted average headway by population group
ma_CR_stopHeadway_df <- ma_stops_sf_CR %>% 
  st_transform(., crs = 26986) %>% 
  st_join(., ma_crprBuff4800m_sf) %>% 
  as.data.frame() %>% 
  group_by(GEOID) %>% 
  summarize(AvgStopHeadway = mean(headway,na.rm = TRUE))
# Create same for tracts
ma_CR_stopHeadwayTracts_df <- ma_stops_sf_CR %>% 
  st_transform(., crs = 26986) %>% 
  st_join(., ma_crprBuff4800mTracts_sf) %>% 
  as.data.frame() %>% 
  group_by(GEOID) %>% 
  summarize(AvgStopHeadway = mean(headway,na.rm = TRUE))
# Create version of ma_bus_stopHeadwayTracts_df for rbind
ma_CR_stopHeadwayTracts <- ma_CR_stopHeadwayTracts_df %>% 
  as.data.frame() %>% 
  left_join(ma_crprBuff4800mTracts_sf,.,by="GEOID") %>% 
  as.data.frame() %>% 
  transmute(Disabled = NewDisabled,
            `No Car HH` = NewNoCar,
            AvgStopHeadway) %>% 
  gather(key = Group, value = Pop, Disabled:`No Car HH`) %>% 
  group_by(Group) %>% 
  summarize(AvgWHeadway = weighted.mean(x = AvgStopHeadway, 
                                        w = Pop, na.rm = TRUE))

# Join stop average headway to block groups within buffer
ma_CRHeadwayPops_df <- ma_crprBuff4800m_sf %>% 
  as.data.frame() %>% 
  left_join(.,ma_CR_stopHeadway_df, by = "GEOID") %>% 
  transmute(`Total Pop` = NewPop,
            Minority = NewMinority,
            `Under 5` = NewUnder5,
            `Over 64` = NewOver64,
            `Under 18` = NewUnder18,
            `English Limited HH` = NewEng_limit,
            `Low Income` = NewPov,
            `No HS Dip` = NewLths,
            `MA Low Income` = NewMA_LOWINC,
            `MA Minority` = NewMA_MINORITY,
            `MA Limited English HH` = NewMA_ENGLISH,
            AvgStopHeadway) %>% 
  gather(key = Group, value = Pop, `Total Pop`:`MA Limited English HH`) %>% 
  group_by(Group) %>% 
  summarize(AvgWHeadway = weighted.mean(x = AvgStopHeadway, 
                                        w = Pop, na.rm = TRUE)) %>% 
  rbind(.,ma_CR_stopHeadwayTracts)
```

```{r mapGTFSbus, fig.align = "center", fig.cap="Mean headways by bus route for Massachusetts routes running Monday through Friday, from 6am - 9pm."}
# arrange row order descending so that higher frequency lines are on top
ma_routes_sf_Bus <- ma_routes_sf_Bus %>% 
  arrange(desc(mean_headways)) %>% 
  # st_simplify(., dTolerance = 100) %>% 
  st_make_valid()

# m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
#   tm_fill(col = "gray",alpha = 0.2) +
#   tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
#   tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
#   tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
#   tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
#   tm_shape(ma_routes_sf_Bus) + 
#   tm_lines(col = "mean_headways", style = "quantile", lwd = 2, 
#            title.col = "Minutes", legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), 
#            palette = c("#1a9641","#a6d96a","#ffff00","#fdae61","#d7191c")) +
#   tm_shape(I95roadSegment) +
#   tm_symbols(shape = I95, border.lwd = NA, size = .1) +
#   tm_shape(I95roadSegment2) +
#   tm_symbols(shape = I95, border.lwd = NA, size = .1) +
#   tm_shape(I395roadSegment) +
#   tm_symbols(shape = I395, border.lwd = NA, size = .1) +
#   tm_shape(I91roadSegment) +
#   tm_symbols(shape = I91, border.lwd = NA, size = .1) +
#   tm_shape(I495roadSegment) +
#   tm_symbols(shape = I495, border.lwd = NA, size = .1) +
#   tm_shape(I495roadSegment2) +
#   tm_symbols(shape = I495, border.lwd = NA, size = .1) +
#   tm_shape(I495roadSegment3) +
#   tm_symbols(shape = I495, border.lwd = NA, size = .1) +
#   tm_shape(I90roadSegment) +
#   tm_symbols(shape = I90, border.lwd = NA, size = .1) +
#   tm_shape(I90roadSegment2) +
#   tm_symbols(shape = I90, border.lwd = NA, size = .1) +
#   tm_shape(ma_towns_sf_pts) + tm_dots() +
#   tm_text("NAME", size = 0.5, col = "black", 
#           xmod = 0.7, ymod = 0.2, shadow = TRUE) +
#   tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
#                position = c(0.6,0.005)) +
#   tm_layout(title = "Mean\nHeadways\nby Bus\nRoute", 
#             frame = FALSE, main.title.size = 0.8,
#             legend.outside = TRUE,
#             legend.title.size = 0.8,
#             legend.outside.position = c("right", "top"))
# 
# tmap_save(m, "DATA/transport/MA/figures/ma_busHeadways.png",
#           height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_busHeadways.png")
```

The average population-weighted headway for all bus routes in the state is `r round(ma_busHeadwayPops_df %>% filter(Group == "Total Pop") %>% select(AvgWHeadway) %>% pull(),1)` minutes. However headways, or service frequencies, vary significantly across population groups. Figure \@ref(fig:loliBusHeadway) below compares the population-weighted average bus headways for different groups across the state. Most groups have average headways shorter than the general population. However, persons over age 64 have headways that exceed that of the general population (`r round(ma_busHeadwayPops_df %>% filter(Group == "Over 64") %>% select(AvgWHeadway) %>% pull(),1)` minutes). The shortest population-weighted average headway, experienced by limited English speaking households, as defined by Massachusetts environmental justice policy, is `r round(ma_busHeadwayPops_df %>% arrange(AvgWHeadway) %>% slice(.,1) %>% select(AvgWHeadway) %>% pull(),0)` minutes.

```{r loliBusHeadway, echo=FALSE, message=FALSE, warning=FALSE, fig.align = "center", fig.cap="Population-weighted average bus headways for groups within 400 meters of a bus stop across Massachusetts."}
ma_busHeadwayPops_df %>% 
  ggplot(aes(x = reorder(Group,AvgWHeadway), y = AvgWHeadway)) +
  geom_segment(aes(x = reorder(Group,AvgWHeadway), 
                   xend = reorder(Group,AvgWHeadway),
                   y = pull(ma_busHeadwayPops_df[9,2]), yend = AvgWHeadway), 
               color = "tan1") +
  geom_point(color = "orange", size = 4, alpha = 0.8) +
  coord_flip() + xlab("") + ylab("minutes") + ggtitle("Population-Weighted Average Bus Stop Headway for\nMassachusetts Groups within Walking Distance (400m)\nof Bus Stops") + theme_light() +
  theme(panel.grid.major.y = element_blank(),
        panel.border = element_blank(),
        axis.ticks.y = element_blank()) +
  geom_text(aes(x = Group, y = AvgWHeadway + 0.2 * sign(AvgWHeadway), 
                label = round(AvgWHeadway,0)), 
            hjust = 1.5, vjust = -0.6, size = 3,
            color=rgb(100,100,100, maxColorValue=255)) +
  geom_hline(yintercept = pull(ma_busHeadwayPops_df[9,2]), 
             linetype = "dashed") +
  geom_text(aes(x = "Under 18", y = 101, label = "Above state\naverage"),
            color = "gray48") +
  geom_text(aes(x = "Under 18", y = 87, label = "Below state\naverage"),
            color = "gray48") +
  expand_limits(y = c(75,105))
```

Rapid transit routes, which are localized to Boston and adjacent municipalities, show considerably shorter average headways than bus routes. Figure \@ref(fig:mapGTFSrapidTransit) shows average headways by line, and Table \@ref(tab:tabGTFSrapidTransit) shows a breakdown of headway times by route. The average population-weighted headway for all rapid transit routes in the state is `r round(ma_RTHeadwayPops_df %>% filter(Group == "Total Pop") %>% select(AvgWHeadway) %>% pull(),1)` minutes. However headways, or service frequencies, vary significantly across population groups. Figure \@ref(fig:loliRTHeadway) below compares the population-weighted average rapid transit headways for different groups within reasonable walking distance of stops. More than half of the groups have average headways longer than the general population. Adults without a high school diploma have the longest population-weighted average headways (`r round(ma_RTHeadwayPops_df %>% filter(Group == "No HS Dip") %>% select(AvgWHeadway) %>% pull(),1)` minutes). The shortest population-weighted average headway, experienced by limited English speaking households, as defined by Massachusetts environmental justice policy, is `r round(ma_RTHeadwayPops_df %>% arrange(AvgWHeadway) %>% slice(.,1) %>% select(AvgWHeadway) %>% pull(),1)` minutes.

```{r mapGTFSrapidTransit, fig.align = "center", fig.cap="Mean headways by rapid transit route for Massachusetts routes running Monday through Friday, from 6am - 9pm."}
# arrange row order descending so that higher frequency lines are on top
ma_routes_sf_RT <- ma_routes_sf_RT %>% 
  arrange(desc(mean_headways)) %>% 
  st_transform(., crs = st_crs(ma_state_sf_cb)) %>% 
  # st_simplify(., dTolerance = 100) %>% 
  st_make_valid()

# remove water area from towns layer for closeup mapping
ma_water <- area_water("MA", county = "Suffolk", class = "sf") %>% 
  st_transform(., crs = st_crs(ma_towns_sf))
# function to erase overlapping areas
st_erase <- function(x,y) {
  st_difference(x, st_union(y))
}
# create copy of ma_towns with water features erased
ma_towns_sf_cb <- st_erase(ma_towns_sf,ma_water) %>% 
  group_by(NAME) %>% 
  summarize() %>% 
  st_make_valid()

m <- tm_shape(ma_towns_sf_cb, bbox = ma_routes_sf_RT, unit = "mi") +
  tm_polygons(col = "gray", border.alpha = 0.8, lwd = 0.2, alpha = 0.2) +
  tm_shape(ma_towns_sf) + 
  tm_text("NAME", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_routes_sf_RT) +
  tm_lines(col = "mean_headways", style = "quantile", lwd = 2,
           title.col = "Minutes", legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")),
           palette = c("#1a9641","#a6d96a","#ffff00","#fdae61","#d7191c")) +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  # tm_shape(ma_towns_sf_pts) + tm_dots() +
  # tm_text("NAME", size = 0.5, col = "black",
  #         xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 1, 2), text.size = 0.5,
               position = c(0.6,0.005)) +
  tm_layout(title = "Mean\nHeadways\nby Rapid\nTransit\nRoute",
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_rtHeadways.png",
          height = 6, width = 5, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_rtHeadways.png")
```

```{r tabGTFSrapidTransit, fig.align = "center", fig.cap="Headway by rapid transit line based on on GTFS schedule for Monday to Friday service, 6am - 9pm."}
# Show table of mean headways by line
ma_stops_sf_RT %>% 
  as.data.frame() %>% 
  # mutate(ROUTE = as.character(ROUTE)) %>% 
  # left_join(., as.data.frame(ma_routes_sf), by=c("ROUTE" = "route_id")) %>% 
  group_by(route_long_name) %>% 
  summarize(Number = n(), Min = min(headway), Mean = mean(headway), Max = max(headway)) %>% 
  arrange(route_long_name) %>% 
  kableExtra::kable(longtable = T, booktabs = T, digits = 1, 
                    col.names = c("Route","Number of Stops",
                                  "Min",
                                  "Mean",
                                  "Max"), 
                    caption = "Headway by Rapid Transit Line", 
                    align = "r") %>% 
  kableExtra::add_header_above(c(" " = 2, "Headway (minutes)" = 3)) %>%
  # kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header"))
```

```{r loliRTHeadway, echo=FALSE, message=FALSE, warning=FALSE, fig.align = "center", fig.cap="Population-weighted average rapid transit headways for groups within 800 meters of a rapid transit stop."}
ma_RTHeadwayPops_df %>% 
  ggplot(aes(x = reorder(Group,AvgWHeadway), y = AvgWHeadway)) +
  geom_segment(aes(x = reorder(Group,AvgWHeadway), 
                   xend = reorder(Group,AvgWHeadway),
                   y = pull(ma_RTHeadwayPops_df[9,2]), yend = AvgWHeadway), 
               color = "tan1") +
  geom_point(color = "orange", size = 4, alpha = 0.8) +
  coord_flip() + xlab("") + ylab("minutes") + ggtitle("Population-Weighted Average Stop Headway for\nMassachusetts Groups within Walking Distance (800m)\nof Rapid Transit Stops") + theme_light() +
  theme(panel.grid.major.y = element_blank(),
        panel.border = element_blank(),
        axis.ticks.y = element_blank()) +
  geom_text(aes(x = Group, y = AvgWHeadway + 0.2 * sign(AvgWHeadway), 
                label = round(AvgWHeadway,1)), 
            hjust = 1.5, vjust = -0.6, size = 3,
            color=rgb(100,100,100, maxColorValue=255)) +
  geom_hline(yintercept = pull(ma_RTHeadwayPops_df[9,2]), 
             linetype = "dashed") +
  geom_text(aes(x = "Under 18", y = 11, label = "Above state\naverage"),
            color = "gray48") +
  geom_text(aes(x = "Under 18", y = 6.5, label = "Below state\naverage"),
            color = "gray48") +
  expand_limits(y = c(6,12))
```

Headways for commuter rail routes are slightly shorter on average than bus routes. Figure \@ref(fig:mapGTFScommuterRail) shows average headways by line and Table \@ref(tab:tabGTFSrapidCommuterRail) shows a breakdown of headway times by route. The average population-weighted headway for all commuter rail routes in the state is `r round(ma_CRHeadwayPops_df %>% filter(Group == "Total Pop") %>% select(AvgWHeadway) %>% pull(),1)` minutes. However headways, or service frequencies, vary significantly across population groups. Figure \@ref(fig:loliCRHeadway) below compares the population-weighted average commuter rail headways for different groups within 3 miles (4800m) of stops. Most groups have average headways shorter than the general population. However, persons over 64 have population-weighted average headways longer than the general population (`r round(ma_CRHeadwayPops_df %>% filter(Group == "Over 64") %>% select(AvgWHeadway) %>% pull(),1)` minutes). The shortest population-weighted average headway, experienced by limited English speaking households, as defined by Massachusetts environmental justice policy, is `r round(ma_CRHeadwayPops_df %>% arrange(AvgWHeadway) %>% slice(.,1) %>% select(AvgWHeadway) %>% pull(),1)` minutes.

```{r mapGTFScommuterRail, fig.align = "center", fig.cap="Mean headways by commuter rail route for Massachusetts routes running Monday through Friday, from 6am - 9pm."}
# arrange row order descending so that higher frequency lines are on top
ma_routes_sf_CR <- ma_routes_sf_CR %>% 
  arrange(desc(mean_headways)) %>% 
  st_transform(., crs = st_crs(ma_state_sf_cb)) %>% 
  # st_simplify(., dTolerance = 100) %>% 
  st_make_valid()

# m <- tm_shape(ma_towns_sf, bbox = ma_routes_sf_CR, unit = "mi") +
#   tm_polygons(col = "gray", border.alpha = 0.8, lwd = 0.2, alpha = 0.2) +
#   tm_text("NAME", size = 0.4, remove.overlap = TRUE, col = "gray") +
#   tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
#   tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
#   tm_shape(ma_routes_sf_CR) +
#   tm_lines(col = "mean_headways", style = "quantile", lwd = 2,
#            title.col = "Minutes", legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")),
#            palette = c("#1a9641","#a6d96a","#ffff00","#fdae61","#d7191c")) +
#   tm_shape(I95roadSegment) +
#   tm_symbols(shape = I95, border.lwd = NA, size = .1) +
#   tm_shape(I95roadSegment2) +
#   tm_symbols(shape = I95, border.lwd = NA, size = .1) +
#   tm_shape(I395roadSegment) +
#   tm_symbols(shape = I395, border.lwd = NA, size = .1) +
#   tm_shape(I91roadSegment) +
#   tm_symbols(shape = I91, border.lwd = NA, size = .1) +
#   tm_shape(I495roadSegment) +
#   tm_symbols(shape = I495, border.lwd = NA, size = .1) +
#   tm_shape(I495roadSegment2) +
#   tm_symbols(shape = I495, border.lwd = NA, size = .1) +
#   tm_shape(I495roadSegment3) +
#   tm_symbols(shape = I495, border.lwd = NA, size = .1) +
#   tm_shape(I90roadSegment) +
#   tm_symbols(shape = I90, border.lwd = NA, size = .1) +
#   tm_shape(I90roadSegment2) +
#   tm_symbols(shape = I90, border.lwd = NA, size = .1) +
#   # tm_shape(ma_towns_sf_pts) + tm_dots() +
#   # tm_text("NAME", size = 0.5, col = "black",
#   #         xmod = 0.7, ymod = 0.2, shadow = TRUE) +
#   tm_scale_bar(breaks = c(0, 5, 10), text.size = 0.5,
#                position = c(0.6,0.005)) +
#   tm_layout(title = "Mean\nHeadways\nby Commuter\nRail Route",
#             frame = FALSE, main.title.size = 0.8,
#             legend.outside = TRUE,
#             legend.title.size = 0.8,
#             legend.outside.position = c("right", "top"))
# 
# tmap_save(m, "DATA/transport/MA/figures/ma_crHeadways.png",
#           height = 6, width = 5, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_crHeadways.png")
```

```{r tabGTFSrapidCommuterRail, fig.align = "center", fig.cap="Headway by commuter rail line based on on GTFS schedule for Monday to Friday service, 6am - 9pm."}
# Show table of mean headways by line
ma_stops_sf_CR %>% 
  as.data.frame() %>% 
  # mutate(ROUTE = as.character(ROUTE)) %>% 
  # left_join(., as.data.frame(ma_routes_sf), by=c("ROUTE" = "route_id")) %>% 
  group_by(route_long_name) %>% 
  summarize(Number = n(), Min = min(headway), Mean = mean(headway), Max = max(headway)) %>% 
  arrange(route_long_name) %>% 
  kableExtra::kable(longtable = T, booktabs = T, digits = 1, 
                    col.names = c("Route","Number of Stops",
                                  "Min",
                                  "Mean",
                                  "Max"), 
                    caption = "Headway by Commuter Rail Line", 
                    align = "r") %>% 
  kableExtra::add_header_above(c(" " = 2, "Headway (minutes)" = 3)) %>%
  # kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header"))
```

```{r loliCRHeadway, echo=FALSE, message=FALSE, warning=FALSE, fig.align = "center", fig.cap="Population-weighted average commuter rail headways for groups within 4800 meters of a commuter rail stop."}
ma_CRHeadwayPops_df %>% 
  ggplot(aes(x = reorder(Group,AvgWHeadway), y = AvgWHeadway)) +
  geom_segment(aes(x = reorder(Group,AvgWHeadway), 
                   xend = reorder(Group,AvgWHeadway),
                   y = pull(ma_CRHeadwayPops_df[9,2]), yend = AvgWHeadway), 
               color = "tan1") +
  geom_point(color = "orange", size = 4, alpha = 0.8) +
  coord_flip() + xlab("") + ylab("minutes") + ggtitle("Population-Weighted Average Stop Headway for\nMassachusetts Groups within 3 miles (4800m)\nof Commuter Rail Stops") + theme_light() +
  theme(panel.grid.major.y = element_blank(),
        panel.border = element_blank(),
        axis.ticks.y = element_blank()) +
  geom_text(aes(x = Group, y = AvgWHeadway + 0.2 * sign(AvgWHeadway), 
                label = round(AvgWHeadway,1)), 
            hjust = 1.5, vjust = -0.6, size = 3,
            color=rgb(100,100,100, maxColorValue=255)) +
  geom_hline(yintercept = pull(ma_CRHeadwayPops_df[9,2]), 
             linetype = "dashed") +
  geom_text(aes(x = "Under 18", y = 87, label = "Above state\naverage"),
            color = "gray48") +
  geom_text(aes(x = "Under 18", y = 67, label = "Below state\naverage"),
            color = "gray48") +
  expand_limits(y = c(40,90))
```

```{r excessiveHeadway, include=FALSE}
# Subset block groups and tracts with average headways exceeding 80th percentile headway for all routes
headway80thblkgrps_bus <- ma_busBuff400m_sf %>% 
  left_join(., ma_bus_stopHeadway_df, by = "GEOID") %>% 
  filter(AvgStopHeadway >= quantile(ma_routes_sf_Bus$mean_headways,0.8))

headway80thtracts_bus <- ma_busBuff400mTracts_sf %>% 
  left_join(., ma_bus_stopHeadwayTracts_df, by = "GEOID") %>%
  filter(AvgStopHeadway >= quantile(ma_routes_sf_Bus$mean_headways,0.8))

headway80thblkgrps_RT <- ma_rtBuff800m_sf %>% 
  left_join(., ma_RT_stopHeadway_df, by = "GEOID") %>% 
  filter(AvgStopHeadway >= quantile(ma_routes_sf_RT$mean_headways,0.8))

headway80thtracts_RT <- ma_rtBuff800mTracts_sf %>% 
  left_join(., ma_RT_stopHeadwayTracts_df, by = "GEOID") %>%
  filter(AvgStopHeadway >= quantile(ma_routes_sf_RT$mean_headways,0.8))

# create buffers only around CR stops
ma_crBuff4800m_sf <- ma_blkgrps_developed %>% 
  select(GEOID,NewArea:NewMA_ENGLISH) %>% 
  mutate(OldArea = NewArea) %>% 
  st_intersection(ma_crBuff4800m,.) %>% 
  mutate(NewArea = st_area(.),
         Proportion = NewArea/OldArea,
         NewPop = as.integer(NewPop*Proportion),
         NewMinority = as.integer(NewMinority*Proportion),
         NewUnder5 = as.integer(NewUnder5*Proportion),
         NewOver64 = as.integer(NewOver64*Proportion),
         NewUnder18 = as.integer(NewUnder18*Proportion),
         NewEng_limit = as.integer(NewEng_limit*Proportion),
         NewPov = as.integer(NewPov*Proportion),
         NewLths = as.integer(NewLths*Proportion),
         NewMA_LOWINC = as.integer(NewMA_LOWINC*Proportion),
         NewMA_MINORITY = as.integer(NewMA_MINORITY*Proportion),
         NewMA_ENGLISH = as.integer(NewMA_ENGLISH*Proportion))


ma_crBuff4800mTracts_sf <- ma_tracts_developed %>% 
  select(GEOID,NewDisabled:NewHHNoCar) %>% 
  mutate(OldArea = st_area(.)) %>% 
  st_intersection(ma_crBuff4800m,.) %>% 
  mutate(NewArea = st_area(.),
         Proportion = NewArea/OldArea,
         NewDisabled = as.integer(NewDisabled*Proportion),
         NewNoCar = as.integer(NewHHNoCar*Proportion))

headway80thblkgrps_CR <- ma_crBuff4800m_sf %>% 
  left_join(., ma_CR_stopHeadway_df, by = "GEOID") %>% 
  filter(AvgStopHeadway >= quantile(ma_routes_sf_CR$mean_headways,0.8))

headway80thtracts_CR <- ma_crBuff4800mTracts_sf %>% 
  left_join(., ma_CR_stopHeadwayTracts_df, by = "GEOID") %>%
  filter(AvgStopHeadway >= quantile(ma_routes_sf_CR$mean_headways,0.8))

# calculate numbers of affected people by mode by municipality
headway80_bus <- headway80thblkgrps_bus %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Over 64` = sum(NewOver64,na.rm = TRUE),
            `Pct of Over 64` = round(sum(NewOver64)/max(TotalOver64)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  mutate(`Pct of Over 64` = paste0(`Pct of Over 64`,"%")) %>% 
  arrange(desc(`Over 64`))

headway80_rapidTransit <- headway80thblkgrps_RT %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `No HS Dip` = sum(NewLths,na.rm = TRUE),
            `Pct of No HS Dip` = round(sum(NewLths)/max(TotalNoHS)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  mutate(`Pct of No HS Dip` = paste0(`Pct of No HS Dip`,"%")) %>% 
  arrange(desc(`No HS Dip`))

headway80_commuterRail <- headway80thblkgrps_CR %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Over 64` = sum(NewOver64,na.rm = TRUE),
            `Pct of Over 64` = round(sum(NewOver64)/max(TotalOver64)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  mutate(`Pct of Over 64` = paste0(`Pct of Over 64`,"%")) %>% 
  arrange(desc(`Over 64`))

# # write out to file for use in later analysis
# save(headway80thblkgrps_bus,
#      headway80thtracts_bus,
#      headway80thblkgrps_RT,
#      headway80thtracts_RT,
#      headway80thblkgrps_CR,
#      headway80thtracts_CR, file = "DATA/transport/MA/headway80th.Rds")

# st_write(headway80thblkgrps_bus,"DATA/transport/MA/headway80thblkgrps_bus.shp")
# st_write(headway80thtracts_bus, "DATA/transport/MA/headway80thtracts_bus.shp")
# st_write(headway80thblkgrps_RT,"DATA/transport/MA/headway80thblkgrps_RT.shp")
# st_write(headway80thtracts_RT,"DATA/transport/MA/headway80thtracts_RT.shp")
# st_write(headway80thblkgrps_CR,"DATA/transport/MA/headway80thblkgrps_CR.shp")
# st_write(headway80thtracts_CR,"DATA/transport/MA/headway80thtracts_CR.shp")
```
The population-weighted average headways above provide a glimpse of average headways across the state for different population groups and for different transit modes. However, headways also vary for specific communities. Indeed, it is important to consider populations of concern or transportation-limited populations that experience excessively long headways or low service frequency. Figures \@ref(fig:mapHeadwayOver64bus) to \@ref(fig:mapHeadwayOver64CR) below highlight communities of persons over 64 and adults without a high school diploma who are within reasonable distance of bus stops (i.e., 400m or 1/4 mile), rapid transit stops (i.e., 800m or 1/2 mile), and commuter rail stops (i.e., 4800m or 3 miles), but where the mean headway for these stops exceeds the 80th percentile of mean route headways for the state. Tables \@ref(tab:tabHeadwayOver64bus) to \@ref(tab:tabHeadwayOver64commuterRail) show breakdowns by municipality. For example, Table \@ref(tab:tabHeadwayOver64bus) shows that `r formatC(as.numeric(headway80_bus[1,3]),big.mark=",",digits = 5)` people over 64 across `r headway80_bus[1,2]` Block Groups in `r headway80_bus[1,1]` resided in areas where the average headway of accessible transit stops exceeded `r quantile(ma_routes_sf_Bus$mean_headways,0.8)` minutes. These people represented `r headway80_bus[1,4]` of people over 64 in `r headway80_bus[1,1]`. Similarly, Table \@ref(tab:tabHeadwayDisabledRT) shows that `r formatC(as.numeric(headway80_rapidTransit[1,3]),big.mark=",")` people with disabilities across `r headway80_rapidTransit[1,2]` Census Tracts in `r headway80_rapidTransit[1,1]` resided in areas where the average headway of accessible transit stops exceeded `r quantile(ma_routes_sf_RT$mean_headways,0.8)` minutes. These people represented `r headway80_rapidTransit[1,4]` of people with disabilities in `r headway80_rapidTransit[1,1]`.
Maps and tables of other populations of concern with excessive headways can be found in Appendix B. 

```{r mapHeadwayOver64bus, fig.align = "center", fig.cap="Persons over 64 within 400m or 1/4 mile of transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") +
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) +
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_busRoutesAll_sf_simple) + tm_lines(lwd = 1, alpha = 0.3, col = "blue") +
  tm_shape(headway80thblkgrps_bus) +
  tm_fill(col = "NewOver64", style = "quantile",
          colorNA = "white", colorNULL = "gray",
          title = "Number of\nPersons Over 64",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black",
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5,
               position = c(0.6,0.005)) +
  tm_add_legend(type = "line", lwd=1, alpha = 0.3, labels = "Bus Route", col = "blue") +
  tm_layout(title = paste("Persons Over 64","with Bus Headways",paste0("Over ",quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"),
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_headwayOver64bus.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_headwayOver64bus.png")
```

```{r tabHeadwayOver64bus, fig.align = "center", fig.cap="Persons over 64 within 400m or 1/4 mile of transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
headway80thblkgrps_bus %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Over 64` = sum(NewOver64,na.rm = TRUE),
            `Pct of Over 64` = round(sum(NewOver64)/max(TotalOver64)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Over 64` > 0) %>% 
  mutate(`Pct of Over 64` = if_else(`Pct of Over 64` > 100, 100, `Pct of Over 64`)) %>% 
  mutate(`Pct of Over 64` = paste0(`Pct of Over 64`,"%")) %>% 
  arrange(desc(`Over 64`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = paste("Persons Over 64","with Average Bus Headways",paste0("Over ",quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"), align = "r", col.names = c(names(.)[1:2],"Number of Over 64 in Block Groups","Pct of Over 64 in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped"))

```

```{r mapHeadwayNoHSDipRT, fig.align = "center", fig.cap="Adults without a high school diploma within 800m or 1/2 mile of rapid transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
m <- tm_shape(ma_towns_sf_cb, bbox = ma_routes_sf_RT, unit = "mi") +
  tm_polygons(col = "gray", border.alpha = 0.8, lwd = 0.2, alpha = 0.2) +
  tm_shape(ma_towns_sf) + 
  tm_text("NAME", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(headway80thblkgrps_RT) +
  tm_fill(col = "NewLths", style = "quantile",
          colorNA = "white", colorNULL = "gray", 
          title = "Number of\nAdults without a\nHigh School Diploma",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  # tm_shape(ma_routes_sf_RT) + 
  # tm_lines(lwd = 2, col = "line_id", title.col = "", alpha = 0.6,
  #          labels = c("Blue line","Green line","Mattapan line","Orange line","Red line"), palette = c("blue","green","purple","orange","red")) +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  # tm_shape(ma_towns_sf_pts) + tm_dots() +
  # tm_text("NAME", size = 0.5, col = "black", 
  #         xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 1, 2), text.size = 0.5, 
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=1, alpha = 0.3, labels = "Rapid Transit Route") +
  tm_layout(title = paste("Adults without a High","School Diploma","with Rapid", "Transit Headways",paste0("Over ",quantile(ma_routes_sf_RT$mean_headways,0.8)," Minutes"),sep = "\n"), 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_headwayNoHSDipRT.png",
          height = 6, width = 5, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_headwayNoHSDipRT.png")
```

```{r tabHeadwayDisabledRT, fig.align = "center", fig.cap="Adults without a high school diploma within 800m or 1/2 mile of rapid transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
headway80thblkgrps_RT %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `No HS Dip` = sum(NewLths,na.rm = TRUE),
            `Pct of No HS Dip` = round(sum(NewLths)/max(TotalNoHS)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  mutate(`Pct of No HS Dip` = paste0(`Pct of No HS Dip`,"%")) %>% 
  arrange(desc(`No HS Dip`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = paste("Adults without a High School Diploma","with Rapid Transit Headways",paste0("Over ",quantile(ma_routes_sf_RT$mean_headways,0.8)," Minutes"),sep = "\n"), align = "r", col.names = c(names(.)[1:2],"Number of No HS Dip in Block Groups","Pct of No HS Dip in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped"))

```

```{r mapHeadwayOver64CR, fig.align = "center", fig.cap="Persons over 64 within 4800m or 3 miles of commuter rail stops in which the mean headway for these stops is above the 80th percentile for the state."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") +
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) +
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_routes_sf_CR) + tm_lines(lwd = 1, alpha = 0.5, col = "purple") +
  tm_shape(headway80thblkgrps_CR) +
  tm_fill(col = "NewOver64", style = "quantile",
          colorNA = "white", colorNULL = "gray",
          title = "Number of\nPersons Over 64",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black",
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5,
               position = c(0.6,0.005)) +
  tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Commuter Rail Route", col = "purple") +
  tm_layout(title = paste("Persons Over 64","with Commuter Rail", "Headways Over",paste0(quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"),
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_headwayOver64cr.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_headwayOver64cr.png")
```

```{r tabHeadwayOver64commuterRail, fig.align = "center", fig.cap="Persons over 64 within 800m or 1/2 mile of commuter rail stops in which the mean headway for these stops is above the 80th percentile for the state."}
headway80thblkgrps_CR %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Over 64` = sum(NewOver64,na.rm = TRUE),
            `Pct of Over 64` = round(sum(NewOver64)/max(TotalOver64)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  mutate(`Pct of Over 64` = paste0(`Pct of Over 64`,"%")) %>% 
  arrange(desc(`Over 64`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = paste("Persons Over 64","with Average Commuter Rail Headways",paste0("Over ",quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"), align = "r", col.names = c(names(.)[1:2],"Number of Over 64 in Block Groups","Pct of Over 64 in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped"))

```

## Walkability

More walkable communities are positively associated with a variety of quality of life and public health benefits. Conversely, less walkable communities are associated with a range of public health challenges, including higher rates of cardiovascular disease and diabetes.[^WalkCardio] The walkability of neighborhoods is increasingly regarded as an important component of healthier and more sustainable communities, particularly with regard to reducing motor vehicle travel and promoting alternative modes of transport that are more affordable, accessible, and less polluting.  

The National Walkability Index is a nationwide geographic data resource produced by the U.S. Environmental Protection Agency that ranks Census Block Groups according to their relative walkability.[^Walkability] Walkability was modeled based on characteristics of the built environment that influence the likelihood of walking being used as a mode of travel. These characteristics of Block Groups include:

* mix of employment types (greater mix = more walkable)
* amount or density of occupied housing (higher density = more walkable)
* street intersection density (higher density = more walkable)
* proportion of workers who carpool (more carpooling = more walkable)

```{r walkabilityData, include=FALSE}
# Analyze Walkability Index for MA. See https://edg.epa.gov/metadata/catalog/search/resource/details.page?uuid=%7B251AFDD9-23A7-4068-9B27-A3048A7E6012%7D
# Import walkability layer
walkability <- st_read(dsn = "DATA/Walkability/Natl_WI_SHP",
        layer = "Natl_WI") 

# Join NatWalkIndex values to other block group variables
ma_blkgrp_walkability_sf <- walkability %>% 
  as.data.frame() %>% 
  select(GEOID10,SFIPS,CFIPS,TRFIPS,NatWalkInd) %>% 
  left_join(ma_blkgrps_sf,., by = c("GEOID" = "GEOID10"))

# Aggregate NatWalkIndex values to tract level sf
ma_tract_walkability_sf <- ma_blkgrp_walkability_sf %>% 
  as.data.frame() %>% 
  select(SFIPS,CFIPS,TRFIPS,NatWalkInd) %>% 
  mutate(TRACTID = paste0(SFIPS,CFIPS,TRFIPS)) %>% 
  group_by(TRACTID) %>% 
  summarize(NatWalkInd = mean(NatWalkInd)) %>% 
  left_join(ma_tracts_sf,., by = c("GEOID" = "TRACTID"))

# Create summarized df of population weighted avg walkability by tract pop
ma_tract_walkability_df <- ma_tract_walkability_sf %>% 
  as.data.frame() %>% 
  transmute(Disabled = disabledOver18E,
            `No Car HH` = HHnoCarE,
            NatWalkInd) %>% 
  gather(key = Group, value = Pop, Disabled:`No Car HH`) %>% 
  group_by(Group) %>% 
  summarize(wNatWalkIndex = weighted.mean(NatWalkInd, Pop, na.rm = TRUE))

# Populated-Weighted Average Walkability Index for Populations of Concern
ma_wAvgWalkability_df <- ma_blkgrp_walkability_sf %>% 
  as.data.frame() %>% 
  mutate(MA_LOWINC = if_else(MA_INCOME == "I", totalpopE, 0)) %>% 
  mutate(MA_LOWINC = replace_na(MA_LOWINC,0)) %>% 
  mutate(MA_MINORITY = if_else(MA_MINORITY == "M", totalpopE,0)) %>%
  mutate(MA_MINORITY = replace_na(MA_MINORITY,0)) %>% 
  mutate(MA_ENGLISH = if_else(MA_ENGLISH == "E", totalpopE,0)) %>%
  mutate(MA_ENGLISH = replace_na(MA_ENGLISH,0)) %>% 
  transmute(`Total Pop` = totalpopE,
            Minority = minorityE,
            `Low Income` = num2povE,
            `Under 5` = under5E,
            `Under 18` = under18E,
            `Over 64` = over64E,
            `Limited English HH` = eng_limitE,
            `No HS Dip` = lthsE,
            `MA Low Income` = MA_LOWINC,
            `MA Minority` = MA_MINORITY,
            `MA Limited English HH` = MA_ENGLISH,
            NatWalkInd) %>% 
  gather(key = Group, value = Pop, `Total Pop`:`MA Limited English HH`) %>% 
  group_by(Group) %>% 
  summarize(wNatWalkIndex = weighted.mean(NatWalkInd, Pop, na.rm = TRUE)) %>% 
  rbind(., ma_tract_walkability_df)

# # save data for later analysis
# save(ma_blkgrp_walkability_sf,
#      ma_tract_walkability_sf,
#      file = "DATA/transport/MA/walkability.Rds")
```

Figure \@ref(fig:mapWalkability) shows walkability scores by Census Block Group across Massachusetts.  Walkability varies across the state. It is highest in and around the state's major urban centers, such as the Boston area, Springfield, Holyoke, Lawrence, Lowell, Pittsfield, and urbanized areas of the Cape.

```{r mapWalkability, echo=FALSE, message=FALSE, warning=FALSE, fig.align = "center", fig.cap="Walkability Index scores for Census Block Groups across Massachusetts."}
m <- tm_shape(ma_blkgrp_walkability_sf) +
  tm_fill(col = "NatWalkInd", alpha = 0.8, style = "equal", n = 4,
          colorNA = "white", colorNULL = "gray", title = "Walkability Index",
          legend.format = list(fun = function(x) formatC(x, digits = 1, format = "f")), palette = c("#FECC61","#FEF6BA","#B9E293","#238443"), 
          labels = c("1 - 5.8 (Least Walkable)","5.8 - 10.5 (Below Avg Walkable)","10.5 - 15.2 (Above Avg Walkable)","15.2 - 20 (Most Walkable)")) +
  tm_shape(ma_towns_sf, unit = "mi") + 
  tm_borders(col = "gray", lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  tm_layout(title = "Walkability", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_walk.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_walk.png")
```

Walkability varies for different population groups across the state. Figure \@ref(fig:loliWalkability) below compares population-weighted average walkability index scores for different populations. The average population-weighted walkability score across Massachusetts is `r round(ma_wAvgWalkability_df %>% filter(Group == "Total Pop") %>% select(wNatWalkIndex) %>% pull(),1)`. Most groups live in communities with walkability index scores that are at or above that of the general population. However, persons over age 64 and under 18 tend to live in communities with walkability scores below the state average. 

```{r loliWalkability, echo=FALSE, message=FALSE, warning=FALSE, fig.align = "center", fig.cap="population-weighted average walkability index scores for groups across Massachusetts."}
# Create lollipop graph of pop-weighted average walk index
ma_wAvgWalkability_df %>% 
  ggplot(aes(x = reorder(Group,-wNatWalkIndex), y = wNatWalkIndex)) +
  geom_segment(aes(x = reorder(Group,-wNatWalkIndex), 
                   xend = reorder(Group,-wNatWalkIndex),
                   y = pull(ma_wAvgWalkability_df[9,2]), yend = wNatWalkIndex), 
               color = "green4") +
  geom_point(color = "green", size = 4, alpha = 0.8) +
  coord_flip() + xlab("") + ylab("Walk Index") + ggtitle("Population-Weighted Walkability Index") + theme_light() +
  theme(panel.grid.major.y = element_blank(),
        panel.border = element_blank(),
        axis.ticks.y = element_blank()) +
  geom_text(aes(x = Group, y = wNatWalkIndex + 0.2 * sign(wNatWalkIndex), 
                label = round(wNatWalkIndex,1)), 
            hjust = 0.6, vjust=-0.8, size = 3,
            color=rgb(100,100,100, maxColorValue=255)) +
  geom_hline(yintercept = pull(ma_wAvgWalkability_df[9,2]), linetype = "dashed") +
  geom_text(aes(x = "Under 18", y = 12.5, label = "Above state\naverage"),
            color = "gray48") +
  geom_text(aes(x = "Under 18", y = 10, label = "Below state\naverage"),
            color = "gray48") +
  expand_limits(y = c(9,16))
```
```{r lowWalk, include=FALSE}
# Isolate least walkable block groups and tracts and add area variable
leastWalkable <- ma_blkgrp_walkability_sf %>% 
  filter(NatWalkInd <= 5.8) %>% 
  mutate(MA_LOWINC = if_else(MA_INCOME == "I", totalpopE, 0)) %>% 
  mutate(MA_LOWINC = replace_na(MA_LOWINC,0)) %>% 
  mutate(MA_MINORITY = if_else(MA_MINORITY == "M", totalpopE,0)) %>%
  mutate(MA_MINORITY = replace_na(MA_MINORITY,0)) %>% 
  mutate(MA_ENGLISH = if_else(MA_ENGLISH == "E", totalpopE,0)) %>%
  mutate(MA_ENGLISH = replace_na(MA_ENGLISH,0)) %>% 
  mutate(SqKm = bg_area_m2/10^6)

leastWalkableTract <- ma_tract_walkability_sf %>% 
  filter(NatWalkInd <= 5.8) %>% 
  mutate(SqKm = as.numeric(st_area(.))/10^6)

leastWalkable1 <- leastWalkable %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Over 64` = sum(over64E,na.rm = TRUE),
            `Pct of Over 64` = round(sum(over64E)/max(TotalOver64)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  mutate(`Pct of Over 64` = paste0(`Pct of Over 64`,"%")) %>% 
  arrange(desc(`Over 64`))

leastWalkable2 <- leastWalkable %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Under 18` = sum(under18E,na.rm = TRUE),
            `Pct of Under 18` = round(sum(under18E)/max(TotalUnder18)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  mutate(`Pct of Under 18` = paste0(`Pct of Under 18`,"%")) %>% 
  arrange(desc(`Under 18`))
```
The population-weighted average walkability scores provide a glimpse of average walkability across the state for different population groups. However, walkability also varies for specific communities. Indeed, it is important to consider populations of concern that reside in communities with low walkability. Figures \@ref(fig:mapLowWalkO64) and \@ref(fig:mapLowWalkU18) below highlight Census Block Groups across Massachusetts that are least walkable and the numbers of persons over 64 or under 18 live there. Tables \@ref(tab:tabLowWalkO64) and \@ref(tab:tabLowWalkU18) show breakdowns by municipality. For example, Table \@ref(tab:tabLowWalkO64) shows that `r formatC(as.numeric(leastWalkable1[1,3]),big.mark=",")` people over 64 across `r leastWalkable1[1,2]` Block Groups in `r leastWalkable1[1,1]` resided in the least walkable areas. These people represented `r leastWalkable1[1,4]` of people over 64 in `r leastWalkable1[1,1]`. Similarly, Table \@ref(tab:tabLowWalkU18) shows that `r formatC(as.numeric(leastWalkable2[1,3]),big.mark=",")` people under 18 across `r TransitNoAccess1[1,2]` Block Groups in `r leastWalkable2[1,1]` resided the least walkable areas. These people represented `r leastWalkable2[1,4]` of people under 18 in `r leastWalkable2[1,1]`.
Maps and tables of other populations of concern in the least walkable Block Groups can be found in Appendix B.

```{r mapLowWalkO64, fig.align = "center", fig.cap="Persons over 64 per square kilometer in least walkable Census Block Groups (i.e., Walkability Index Score less than or equal to 5.8)."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(leastWalkable, unit = "mi") +
  tm_fill(col = "over64E", alpha = 0.9, style = "quantile",
          colorNA = "white", colorNULL = "gray", title = "Persons Over 64\nPer Square Kilometer",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd", convert2density = TRUE, area = "SqKm") +
  tm_shape(ma_tracts_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  tm_layout(title = "Persons Over 64\nin Least Walkable\nBlock Groups", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_walkO64.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_walkO64.png")
```

```{r tabLowWalkO64, fig.align = "center", fig.cap="Persons over 64 by municipality in least walkable Census Block Groups (i.e., Walkability Index Score less than or equal to 5.8)."}
leastWalkable %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Over 64` = sum(over64E,na.rm = TRUE),
            `Pct of Over 64` = round(sum(over64E)/max(TotalOver64)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  mutate(`Pct of Over 64` = if_else(`Pct of Over 64` > 100, 100, `Pct of Over 64`)) %>%
  mutate(`Pct of Over 64` = paste0(`Pct of Over 64`,"%")) %>% 
  arrange(desc(`Over 64`)) %>% 
  filter(`Over 64` > 0) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Persons Over 64 in Least Walkable Block Groups", align = "r", col.names = c(names(.)[1:2],"Number of Over 64 in Block Groups","Pct of Over 64 in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped"))
```

```{r mapLowWalkU18, fig.align = "center", fig.cap="Persons under 18 per square kilometer in least walkable Census Block Groups (i.e., Walkability Index Score less than or equal to 5.8)."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(leastWalkable, unit = "mi") +
  tm_fill(col = "under18E", alpha = 0.9, style = "quantile",
          colorNA = "white", colorNULL = "gray", title = "Persons Under 18\nPer Square Kilometer",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd", convert2density = TRUE, area = "SqKm") +
  tm_shape(ma_tracts_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
 tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  tm_layout(title = "Persons Under 18\nin Least Walkable\nBlock Groups", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_walkU18.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_walkU18.png")
```

```{r tabLowWalkU18, fig.align = "center", fig.cap="Persons under 18 by municipality in least walkable Census Block Groups (i.e., Walkability Index Score less than or equal to 5.8)."}
leastWalkable %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Under 18` = sum(under18E,na.rm = TRUE),
            `Pct of Under 18` = round(sum(under18E)/max(TotalUnder18)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Under 18` > 0) %>% 
  mutate(`Pct of Under 18` = if_else(`Pct of Under 18` > 100, 100, `Pct of Under 18`)) %>% 
  mutate(`Pct of Under 18` = paste0(`Pct of Under 18`,"%")) %>% 
  arrange(desc(`Under 18`)) %>% 
  filter(`Under 18` > 0) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Persons Under 18 in Least Walkable Block Groups", align = "r", col.names = c(names(.)[1:2],"Number of Under 18 in Block Groups","Pct of Under 18 in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped"))
```



## Transportation Cost Burden

Transportation is the second-largest expenditure category for American households, approximately 16% of annual expenditures on average between 2015 and 2018.[^Expenditures] Only housing costs (~32%) exceed those of transportation. The high cost of transportation is due in large part to the costs of dependence on private vehicle ownership, including purchase and financing, insurance, maintenance, and fuel costs. Households without reasonable access to other modes of transportation typically experience higher transportation costs.[^CostBurden] Transportation costs can be significant economic burdens for moderate and lower income households and for communities where destinations are distant or limited. For many working-class and rural households, transportation costs exceed housing costs. 

The Location Affordability Index (LAI) is a nationwide geographic data resource developed by the U.S. Department of Housing and Urban Development (HUD) in collaboration with the U.S. Department of Transportation under the federal Partnership for Sustainable Communities.[^LAIabout] The LAI was developed as a way of integrating both housing and transportation costs into estimates of the affordability of specific neighborhoods and cities. The LAI provides estimated total expenses from transportation, whether transit or motor vehicle, as well as transportation cost as a percentage of household income, for eight different household types  which vary by household income, size, and number of commuters  at the Census Tract level. For the purposes of this analysis, transportation costs as a percentage of income for moderate-income households (households with one commuter making 80% or less of area median household income) was used as a proxy to represent transportation cost burden for all areas. LAI data were also downscaled to the Block Group level for the purpose of demographic analyses and comparisons (see Appendix B Data and Methodology). 

```{r TcostBurden, include=FALSE}
# Read in Location Affordability Index data. Using Version 3 based on ACS 2012-2016 data at Tract level. Downloaded from https://hudgis-hud.opendata.arcgis.com/datasets/location-affordability-index-v-3?selectedAttribute=avg_hh_size_renters
lai_ma <- st_read("DATA/transport/Location_Affordability_Index_v.3", "Location_Affordability_Index_v.3") %>% 
  filter(STUSAB == "MA") %>% 
  st_make_valid() %>% 
  st_transform(., crs = 26986)

# Downscale LAI to Block Group by assigning tract value to all overlapping block groups (i.e. block groups with same tract GEOID prefix)
lai_ma_blkgrp <- ma_blkgrps_sf %>% 
  mutate(GEOIDT = str_sub(GEOID,1,11)) %>% 
  left_join(., as.data.frame(lai_ma),by=c("GEOIDT"="GEOID"))

# Join LAI to tracts
lai_ma_tract <- ma_tracts_sf %>% 
  left_join(., as.data.frame(lai_ma),by="GEOID")

# create summarized df of population weighted average transportation cost burden by tract pop
lai_ma_tract_df <- lai_ma_tract %>% 
  as.data.frame() %>% 
  transmute(Disabled = disabledOver18E,
            `No Car HH` = HHnoCarE,
            hh7_t) %>% 
  gather(key = Group, value = Pop, Disabled:`No Car HH`) %>% 
  group_by(Group) %>% 
  summarize(wTBurden = weighted.mean(hh7_t, Pop, na.rm = TRUE))

# Population-weighted average transportation cost burden for populations of concern
lai_ma_df <- lai_ma_blkgrp %>% 
  as.data.frame() %>% 
  mutate(MA_LOWINC = if_else(MA_INCOME == "I", totalpopE, 0)) %>% 
  mutate(MA_LOWINC = replace_na(MA_LOWINC,0)) %>% 
  mutate(MA_MINORITY = if_else(MA_MINORITY == "M", totalpopE,0)) %>%
  mutate(MA_MINORITY = replace_na(MA_MINORITY,0)) %>% 
  mutate(MA_ENGLISH = if_else(MA_ENGLISH == "E", totalpopE,0)) %>%
  mutate(MA_ENGLISH = replace_na(MA_ENGLISH,0)) %>% 
  transmute(`Total Pop` = totalpopE,
            Minority = minorityE,
            `Low Income` = num2povE,
            `Under 5` = under5E,
            `Under 18` = under18E,
            `Over 64` = over64E,
            `Limited English HH` = eng_limitE,
            `No HS Dip` = lthsE,
            `MA Low Income` = MA_LOWINC,
            `MA Minority` = MA_MINORITY,
            `MA Limited English HH` = MA_ENGLISH,
            hh7_t) %>% 
  gather(key = Group, value = Pop, `Total Pop`:`MA Limited English HH`) %>% 
  group_by(Group) %>% 
  summarize(wTBurden = weighted.mean(hh7_t, Pop, na.rm = TRUE)) %>% 
  rbind(., lai_ma_tract_df)

# # save data for later analysis
# save(lai_ma_blkgrp,
#      lai_ma_tract,
#      file = "DATA/transport/MA/costBurden.Rds")

# isolate places where transportation cost as a percentage of income exceeds housing as a percentage of income
lai_ToverH <- lai_ma %>% 
  filter(hh7_t > hh7_h)
```

Figure \@ref(fig:mapLAI) below shows transportation cost burden (i.e., transportation cost as a percentage of household income) by Census Tract across Massachusetts. Transportation cost burden varies across the state. It is lowest in and around the state's major urban centers, and it is highest in central and western parts of the state. In `r nrow(lai_ToverH)` Census Tracts, the transportation cost burden exceeds the cost burden of housing. 

```{r mapLAI, fig.align = "center", fig.cap="Transportation cost burden for Census Tracts across Massachusetts."}
m <- tm_shape(lai_ma) +
  tm_fill(col = "hh7_t", alpha = 0.8, style = "quantile", title = "Transportation as\nPercent of Income", showNA = FALSE,
          legend.format = list(fun = function(x) formatC(x, digits = 1, format = "f"))) +
  tm_shape(lai_ToverH) + tm_dots(col = "gray", shape = 8, size = 0.5) +
  tm_shape(ma_towns_sf, unit = "mi") + 
  tm_borders(col = "gray", lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  tm_add_legend(type = "symbol",labels = "Transport burden > housing burden", shape = 8, size = 0.5, col = "gray") +
  tm_layout(title = "Transportation\nCost Burden", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_tburden.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_tburden.png")
````

Transportation cost burden varies for different population groups across the state. Figure \@ref(fig:loliLAI) below compares population-weighted average transportation cost burden for different populations. Most groups live in communities with transportation cost burdens that are below that of the general population. However, persons over age 64 and under 18 tend to live in communities with transportation cost burdens that exceed the state average. 

```{r loliLAI, fig.align = "center", fig.cap="Population-weighted average transportation cost burden as a percentage of household income for groups across Massachusetts."}
# Create lollipop graph of pop-weighted average LAI
lai_ma_df %>% 
  ggplot(aes(x = reorder(Group,wTBurden), y = wTBurden)) +
  geom_segment(aes(x = reorder(Group,wTBurden), 
                   xend = reorder(Group,wTBurden),
                   y = pull(lai_ma_df[9,2]), yend = wTBurden), 
               color = "coral4") +
  geom_point(color = "coral3", size = 4, alpha = 0.8) +
  coord_flip() + xlab("") + ylab("Transportation as Percent of Income") + ggtitle("Population-Weighted Transportation Cost Burden") + theme_light() +
  theme(panel.grid.major.y = element_blank(),
        panel.border = element_blank(),
        axis.ticks.y = element_blank()) +
  geom_text(aes(x = Group, y = wTBurden + 0.2 * sign(wTBurden), 
                label = round(wTBurden,1)), 
            hjust = 0.6, vjust=-0.8, size = 3,
            color=rgb(100,100,100, maxColorValue=255)) +
  scale_y_continuous(labels = function(x) paste0(x, "%")) +
  geom_hline(yintercept = pull(lai_ma_df[9,2]), linetype = "dashed") +
  geom_text(aes(x = "Under 18", y = 22, label = "Above state\naverage"),
            color = "gray48") +
  geom_text(aes(x = "Under 18", y = 18, label = "Below state\naverage"),
            color = "gray48") +
  expand_limits(y = c(13,23))
```
```{r HiBurden, include=FALSE}
# Isolate highest transport burden block groups and tracts and add area variable
HiBurden <- lai_ma_blkgrp %>% 
  filter(percent_rank(hh7_t) > 0.8) %>% 
  mutate(MA_LOWINC = if_else(MA_INCOME == "I", totalpopE, 0)) %>% 
  mutate(MA_LOWINC = replace_na(MA_LOWINC,0)) %>% 
  mutate(MA_MINORITY = if_else(MA_MINORITY == "M", totalpopE,0)) %>%
  mutate(MA_MINORITY = replace_na(MA_MINORITY,0)) %>% 
  mutate(MA_ENGLISH = if_else(MA_ENGLISH == "E", totalpopE,0)) %>%
  mutate(MA_ENGLISH = replace_na(MA_ENGLISH,0)) %>%
  mutate(SqKm = bg_area_m2/10^6)

HiBurdenTract <- lai_ma_tract %>% 
  filter(percent_rank(hh7_t) > 0.8) %>% 
  mutate(SqKm = as.numeric(st_area(.))/10^6)

HiBurden1 <- HiBurden %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Over 64` = sum(over64E,na.rm = TRUE),
            `Pct of Over 64` = round(sum(over64E)/max(TotalOver64)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  mutate(`Pct of Over 64` = paste0(`Pct of Over 64`,"%")) %>% 
  arrange(desc(`Over 64`))

HiBurden2 <- HiBurden %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Under 18` = sum(under18E,na.rm = TRUE),
            `Pct of Under 18` = round(sum(under18E)/max(TotalUnder18)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  mutate(`Pct of Under 18` = paste0(`Pct of Under 18`,"%")) %>% 
  arrange(desc(`Under 18`))
```
The population-weighted average transportation cost burden values provide a glimpse of average transportation cost burden across the state for different population groups. However, transportation cost burden also varies for specific communities. Indeed, it is important to consider populations of concern that reside in communities with a high transportation cost burden. Figures \@ref(fig:mapHiBurdenO64) and \@ref(fig:mapHiBurdenU18) below highlight Census Block Groups across Massachusetts where the transportation cost burden is in the highest quintile (i.e., 80th percentile) and the numbers of persons over 64 or under 18 that live there. Tables \@ref(tab:tabHiBurdenO64) and \@ref(tab:tabHiBurdenU18) show breakdowns by municipality. For example, Table \@ref(tab:tabHiBurdenO64) shows that `r formatC(as.numeric(HiBurden1[1,3]),big.mark=",")` people over 64 across `r HiBurden1[1,2]` Block Groups in `r HiBurden1[1,1]` resided in areas with the highest transportation cost burden. These people represented `r HiBurden1[1,4]` of people over 64 in `r HiBurden1[1,1]`. Similarly, Table \@ref(tab:tabHiBurdenU18) shows that `r formatC(as.numeric(HiBurden2[1,3]),big.mark=",")` people under 18 across `r HiBurden2[1,2]` Block Groups in `r HiBurden2[1,1]` resided in areas with the highest transportation cost burden. These people represented `r HiBurden2[1,4]` of people under 18 in `r HiBurden2[1,1]`.
Maps and tables of other populations of concern in areas with the highest transportation cost burden can be found in Appendix B.

```{r mapHiBurdenO64, fig.align = "center", fig.cap="Persons over 64 per square kilometer in Census Block Groups with the highest transportation cost burden (i.e., transportation cost burden in the 80th percentile for the state)."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(HiBurden, unit = "mi") +
  tm_fill(col = "over64E", alpha = 0.9, style = "quantile",
          colorNA = "white", colorNULL = "gray", title = "Persons Over 64\nPer Square Kilometer",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd", convert2density = TRUE, area = "SqKm") +
  tm_shape(ma_tracts_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  tm_layout(title = "Persons Over 64\nin Highest\nTransportation\nCost Burden\nBlock Groups", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_HiBurdenO64.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_HiBurdenO64.png")
```

```{r tabHiBurdenO64, fig.align = "center", fig.cap="Persons over 64 by municipality in Census Block Groups with the highest transportation cost burden (i.e., transportation cost burden in the 80th percentile for the state)."}
HiBurden %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Over 64` = sum(over64E,na.rm = TRUE),
            `Pct of Over 64` = round(sum(over64E)/max(TotalOver64)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Over 64` > 0) %>% 
  mutate(`Pct of Over 64` = if_else(`Pct of Over 64` > 100, 100, `Pct of Over 64`)) %>% 
  mutate(`Pct of Over 64` = paste0(`Pct of Over 64`,"%")) %>% 
  arrange(desc(`Over 64`)) %>% 
  filter(`Over 64` > 0) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Persons Over 64 in Highest Transportation Cost Burden Block Groups", align = "r", col.names = c(names(.)[1:2],"Number of Over 64 in Block Groups","Pct of Over 64 in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped"))
```

```{r mapHiBurdenU18, fig.align = "center", fig.cap="Persons under 18 per square kilometer in Census Block Groups with the highest transportation cost burden (i.e., transportation cost burden in the 80th percentile for the state)."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(HiBurden, unit = "mi") +
  tm_fill(col = "under18E", alpha = 0.9, style = "quantile",
          colorNA = "white", colorNULL = "gray", title = "Persons Under 18\nPer Square Kilometer",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd", convert2density = TRUE, area = "SqKm") +
  tm_shape(ma_tracts_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  tm_layout(title = "Persons Under 18\nin Highest\nTransportation\nCost Burden\nBlock Groups", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_HiBurdenU18.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_HiBurdenU18.png")
```

```{r tabHiBurdenU18, fig.align = "center", fig.cap="Persons under 18 by municipality in Census Block Groups with the highest transportation cost burden (i.e., transportation cost burden in the 80th percentile for the state)."}
HiBurden %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Under 18` = sum(under18E,na.rm = TRUE),
            `Pct of Under 18` = round(sum(under18E)/max(TotalUnder18)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Under 18` > 0) %>% 
  mutate(`Pct of Under 18` = if_else(`Pct of Under 18` > 100, 100, `Pct of Under 18`)) %>% 
  mutate(`Pct of Under 18` = paste0(`Pct of Under 18`,"%")) %>% 
  arrange(desc(`Under 18`)) %>% 
  filter(`Under 18` > 0) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Persons Under 18 in Highest Transportation Cost Burden Block Groups", align = "r", col.names = c(names(.)[1:2],"Number of Under 18 in Block Groups","Pct of Under 18 in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped"))
```



[^Dasymetric]: Areal apportionment of populations for mapping and analysis, also known as dasymetric mapping, is commonly used method to improve risk assessment of flooding. See for example Yi Qiang. 2019. "Disparities of population exposed to flood hazards in the United States." *Journal of Environmental Management* 232:295-304; Yi Qiang, Nina S. N. Lam, Heng Cai, and Lei Zou. 2017. "Changes in Exposure to Flood Hazards in the United States." *Annals of the American Association of Geographers* 107(6):1332-1350. https://doi.org/10.1080/24694452.2017.1320214

[^NLCD2016]: See MRLC NLCD 2016 Land Cover (CONUS). https://www.mrlc.gov/data/nlcd-2016-land-cover-conus.

[^NLCDdetails]: See Collin Homer, Jon Dewitz, Suming Jin, George Xian, Catherine Costello, Patrick Danielson, Leila Gass, Michelle Funk, James Wickham, Stephen Stehman, Roger Auch, and Kurt Riitters. 2020. "Conterminous United States land cover change patterns 20012016 from the 2016 National Land Cover Database." *ISPRS Journal of Photogrammetry and Remote Sensing* 162: 184-199. https://doi.org/10.1016/j.isprsjprs.2020.02.019.

[^headways]: TransitWiki. Headway. https://www.transitwiki.org/TransitWiki/index.php/Headway

[^mindGap]: Mind the Gap: Best practices in bus headway management. https://www.metro-magazine.com/10002870/mind-the-gap-best-practices-in-bus-headway-management

[^headwayReal]: Note that headways analyzed here are based on static schedules provided by the transit agency through the General Transit Feed System (GTFS). Scheduled headways likely differ from actual vehicle frequency due to traffic, dispatch management, accidents or breakdowns, and other issues. For an analysis of the difference between headways based on static schedules and actually observed headways, see Nate Wessel and Steven Farber. 2019. "On the accuracy of schedule-based GTFS for measuring accessibility." *The Journal of Transport and Land Use* 12(1):475-500. 

[^GTFSStaticOverview]: See Google Transit APIs. "GTFS Static Overview." https://developers.google.com/transit/gtfs

[^WalkCardio]: See Nicholas A. Howell, Jack V. Tu, Rahim Moineddin, Anna Chu, and Gillian L. Booth. 2019. "Association Between Neighborhood Walkability and Predicted 10Year Cardiovascular Disease Risk: The CANHEART (Cardiovascular Health in Ambulatory Care Research Team) Cohort." *Journal of the American Heart Association* 8(21). https://doi.org/10.1161/JAHA.119.013146; also see  Rachel C. Colley, Tanya Christidis, Isabelle Michaud, Michael Tjepkema and Nancy A. Ross. 2019. "The association between walkable neighbourhoods and physical activity across the lifespan." *Health Reports* 30(9).  http://dx.doi.org/10.25318/82-003-x201900900001-eng; see also Hao Wang and Yuqi Yang. 2019. "Neighbourhood walkability: A review and bibliometric analysis." *Cities* 93:43-61. https://doi.org/10.1016/j.cities.2019.04.015

[^Walkability]: See US EPA National Walkability Index. https://www.epa.gov/smartgrowth/smart-location-mapping#walkability; Also see Kathleen B. Watson, Geoffrey P. Whitfield, John V. Thomas, David Berrigan, Janet E. Fulton, and Susan A. Carlson. 2020. "Associations between the National Walkability Index and walking among US Adults  National Health Interview Survey, 2015." *Preventive Medicine* 137. https://doi.org/10.1016/j.ypmed.2020.106122.

[^Expenditures]: See U.S. Bureau of Labor Statistics. 2020. "Consumer Expenditures in 2018." BLS Reports May 2020.  https://www.bls.gov/opub/reports/consumer-expenditures/2018/home.htm; see also Thomas W. Sanchez, Carrie Makarewicz, Peter Haas, and Casey J. Dawkins. 2006. "Transportation costs, inequities, and tradeoffs." https://www.researchgate.net/profile/Thomas_Sanchez/publication/278017364_Transportation_Costs_Inequities_and_Tradeoffs/links/5578577e08aeb6d8c01f1382/Transportation-Costs-Inequities-and-Tradeoffs.pdf

[^CostBurden]: See Thomas W. Sanchez, Carrie Makarewicz, Peter Haas, and Casey J. Dawkins. 2006. "Transportation costs, inequities, and tradeoffs." https://www.researchgate.net/profile/Thomas_Sanchez/publication/278017364_Transportation_Costs_Inequities_and_Tradeoffs/links/5578577e08aeb6d8c01f1382/Transportation-Costs-Inequities-and-Tradeoffs.pdf

[^LAIabout]: See U.S. Department of Housing and Urban Development - HUD Exchange. "About the Location Affordability Index."  https://www.hudexchange.info/programs/location-affordability-index/about/

[^TransitDistance]: See C.K. Ayvalik and C.J. Khisty. 2002. "Heuristic analysis of impacts of commuter rail station consolidation on pedestrian access." *Transportation Research Record* 1793:4754; E.A. Beimborn, M.J. Greenwald, and X. Jin. 2003. "Accessibility, connectivity, and captivity: impacts on transit choice." *Transportation Research Record* 1835: 19; S. Biba. 2010. "A new method for determining the population with walking access to transit." *International Journal of Geographical Information Science* 24(3): 347-364; J.E. Burkhardt. 2003. "Critical measures of transit service quality in the eyes of older travelers." *Transportation Research Record* 1835: 8492; J. Dill. 2003. "Transit use and proximity to rail: results from large employment sites in the San Francisco, California, bay area." *Transportation Research Record* 1835:1924; J.E. Evans, V. Perincherry, and G.B.I. Douglas. 1997. "Transit friendliness factor: approach to quantifying transit access environment in a transportation planning model." *Transportation Research Record* 1604: 3239; S. Hsiao et al., 1997. "Use of geographic information system for analysis of transit pedestrian access." *Transportation Research Record* 1604: 5059; D.R. Loutzenheiser. 1997. "Pedestrian access to transit: model of walk trips and their design and urban form determinants around bar area rapid transit stations." *Transportation Research Record* 1604: 4049; W.A. ONeill, R.D. Ramsey, and J. Chou. 1992. "Analysis of transit service areas using geographic information systems." *Transportation Research Record* 1364: 131138; S.  OSullivan and J. Morrall. 1996. "Walking distances to and from light-rail transit stations." *Transportation Research Record* 1538: 1926; C.G. Phillips  and H.R. Edwards. 2002. "Socioeconomic, community-based approach for developing integrated mass transit systems application to city of Baltimore, Maryland." *Transportation Research Record* 1797: 7179; F. Zhao et al., 2003. "Forecasting transit walk accessibility  regression model alternative to buffer method." *Transportation Research Record* 1835: 3441.


\pagebreak
# Appendix A: Data and Methodology {-}

The analyses presented here are based on data from six sources:

* Massachusetts transit network
* MRLC National Land Cover Database (NLCD)
* General Transit Feed Specification (GTFS)
* US EPA Walkability Index
* US Department of Housing and Urban Development Location Affordability Index
* American Community Survey 5-year Estimates
  + Population demographics

## Massachusetts transit network {-}

The transit route linework and transit stop locations for Massachusetts  were downloaded from MassGIS at  https://www.mass.gov/orgs/massgis-bureau-of-geographic-information and the MassDOT Open Data Portal at https://geo-massdot.opendata.arcgis.com/. A resident is considered to have access if she is within onequarter mile of an MBTA bus stop, onehalf mile of a rapid transit (i.e. subway or light rail) station, and up to three miles of a commuter rail station or park-in-ride lot. This geographic definition of access is consistent with FTA Circular 4702.1B Title VI Requirements and Guidelines for Federal Transit Administration Recipients, Chapter IV14, as well as decades of research on transit behavior, and the judgment of most planners and transit researchers.[^TransitDistance] 

To identify the populations with access to transit, 400 meter, 800 meter, and 4800 meter buffers were generated around all bus, rapid transit, and commuter rail stops and park-in-ride lots, respectively. The transit buffer was intersected with the developed portions of Census Block Groups. Developed portions of Census Block Groups were identified based upon the National Land Cover Database (NLCD), using a process of areal apportionment (see below). The population with access to transit was calculated as the product of the  areal proportion of the intersecting buffer and developed Block Group polygons:

*Population with transit access = Proportion of developed Block Group Intersection x Population of developed Block Group*

For example, if 10% of the developed area of a Census Block Group intersected/overlapped with the 400m buffer around transit stops, it was assumed that 10% of the population has access to those transit stops. Assuming a population of 100 people in the developed portion of the Block Group, this would mean *100 x .10 = 10* people would have access to transit via those stops. This transit access analysis was done in R.


## MRLC National Land Cover Database (NLCD) {-}

The National Land Cover Database (NLCD) provides nationwide data on land cover and land cover change at a 30m resolution with a 16-class legend based on a modified Anderson Level II classification system:

```{r NLCDtab}
gridCodes <- c(11,12,21,22,23,24,31,41,42,43,51,52,71,72,73,74,81,82,90,95)

landUse <- c("Open Water", "Perennial Ice/Snow", "Developed, Open Space", "Developed, Low Intensity", "Developed, Medium Intensity", "Developed, High Intensity", "Barren Land (Rock/Sand/Clay)", "Deciduous Forest", "Evergreen Forest", "Mixed Forest", "Dwarf Scrub", "Shrub/Scrub", "Grassland/Herbaceous", "Sedge/Herbaceous", "Lichens", "Moss", "Pasture/Hay", "Cultivated Crops", "Woody Wetlands", "Emergent Herbaceous Wetlands")

data.frame(gridCodes,landUse) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    col.names = c("GMAD Code","Land Use Description"),
                    caption = "NLCD 2016 Land Cover Codes and Classifications", align = "l") %>% 
  kableExtra::kable_styling(latex_options = c("repeat_header"))
```

The NLCD is produced by the US Geological Survey (USGS) in partnership with several federal agencies as part of the Multi-Resolution Land Characteristics Consortium (MRLC).[^NLCD2016] NLCD identified land cover types based on semi-automated land use calssification algorithms applied to LANDSAT satellite imagery and supplemented with ancillary data.[^NLCDdetails] NLCD is distributed as a raster GeoTIFF at https://www.mrlc.gov/data. 

NLCD data was used to identify developed areas of Census Block Groups in order to better estimate where people are most likely to reside, and thus improve estimates of access to transit based on physical distance.[^Dasymetric] The NLCD 2016 was downloaded and converted to a vector polygon layer and clipped to New England states. Undeveloped polygon areas were extracted (all GMAD codes excluding 22 - 24; see Table \@ref(tab:NLCDtab)). These undeveloped areas of the NLCD polygon layer were then used to erase overlapping areas of Census Block Groups. The latter step served to eliminate areas of Census Block Groups that were classified as undeveloped and thus unlikely to be occupied by residences. The remaining developed areas of Census Block Groups were assumed to contain all populations assigned to that respective Block Group. Processing of NLCD and developed Census Block Groups was done in ArcGIS Desktop 10.7. These developed Census Block Group polygons were used for identifying populations with access to public transit.


## General Transit Feed Specification (GTFS) {-}

The General Transit Feed Specification (GTFS) is a a common format for public transportation schedules and associated geographic information. Public transit agencies increasingly publish their transit data electronically via GTFS "feeds" primarily to allow software developers to create applications which can tap into these feeds and provide users with detailed or timely transit schedules or route planning.[^GTFSStaticOverview] GTFS is also increasingly used by transportation researchers because it provides an efficient way to acquire detailed scheduling and routing information for transit networks. While GTFS feeds can provide real-time data on vehicle movements and locations, most data is provided as static schedules, and vehicle frequencies and headways are inferred from the schedule. 

GTFS data for the Massachusetts transit agencies were acquired from MBTA and Transit data for developers at https://www.mass.gov/lists/mbta-and-transit-data-for-developers. GTFS data was processed using the `tidytransit` package in R. Schedules for all routes running Monday through Friday, 6am to 9pm, were extracted. Headways for each transit stop on these routes was then calculated based on route schedules, and these headways were also averaged for each route.

To calculate headways experienced by different population groups, transit stop points with calculated headways were intersected with the developed portions of Census Block Groups and that were within 400m, 800m, and 4800m of these stops for buses, rapid transit, and commuter rail, respectively. Headways for these intersecting stops were then aggregated to provide mean headways for their intersecting Block Groups. Populations within those intersecting Block Groups were assumed to be subject to those mean headways. 


## US EPA Walkability Index {-}

The National Walkability Index is a nationwide geographic data resource produced by the U.S. Environmental Protection Agency that ranks Census Block Groups according to their relative walkability.[^Walkability] Walkability was modeled based on characteristics of the built environment that influence the likelihood of walking being used as a mode of travel. These characteristics of Block Groups include:

* mix of employment types (greater mix = more walkable)
* amount or density of occupied housing (higher density = more walkable)
* street intersection density (higher density = more walkable)
* proportion of workers who carpool (more carpooling = more walkable)

The Walkability Index was downloaded as a shapefile from the US EPA's Smart Location Mapping website at https://www.epa.gov/smartgrowth/smart-location-mapping#walkability. To compare walkability index values with disabled populations and households without a car, Block Group walkability index values were aggregated to the overlying Census Tract as simple averages. Population-weighted averages for the walkability index were also computed for Block Groups and Tracts to compare population groups. 


## US Department of Housing and Urban Development Location Affordability Index {-}

The Location Affordability Index (LAI) is a nationwide geographic data resource developed by the U.S. Department of Housing and Urban Development (HUD) in collaboration with the U.S. Department of Transportation under the federal Partnership for Sustainable Communities.[^LAIabout] The LAI was developed as a way of integrating both housing and transportation costs into estimates of the affordability of specific neighborhoods and cities. The LAI provides estimated total expenses from transportation, whether transit or motor vehicle, as well as transportation cost as a percentage of household income, for eight different household types  which vary by household income, size, and number of commuters  at the Census Tract level. For this analysis Location Affordability Index Model Version 3 (LAIM Version 3 or LAIM3), released in March 2019, was used. LAIM Version 3 estimates housing and transportation costs for eight different household profiles, to focus on the impact of the built environment on these costs by holding demographic characteristics constant. These household profiles are described in Table \@ref(tab:tabLAIprofiles). The LAI can be interpreted as the percentage of the specified household profiles income that would be needed to cover housing, transportation, or combined costs if that household type were to live in the specified Census Tract. So, for example, a household profile (such as single-parent family) with a housing LAI of 40% would be expected to pay 40% of their income for housing if they lived in the specified location. Details on how housing and transportation costs were modeled are descrbed in the Location Affordability Index Version 3 Data and Methodology document. 

```{r tabLAIprofiles}
data.frame(hhProfile = c("Median-Income Family", "Very Low-Income Individual", "Working Individual", "Single Professional", "Retired Couple", "Single-Parent Family", "Moderate-Income Family", "Dual-Professional Family"),
hhhIncome = c("MHHI", "National poverty line", "50% of MHHI", "135% of MHHI", "80% of MHHI", "50% of MHHI", "80% of MHHI", "150% of MHHI"),
hhSize = c(4,1,1,1,2,3,3,4),
Commuters = c(2,1,1,1,0,1,1,2)) %>% 
  kableExtra::kable(longtable = T, booktabs = T, 
                    caption = "Location Affordability Index Household Profiles", 
                    align = "l",
                    col.names = c("Household Profile","Income","Household Size","Commuters")) %>% 
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) %>% 
  kableExtra::footnote(., general = "MHHI = Median household income for a given area (CBSA or County)")
```

For the purposes of this analysis, transportation costs as a percentage of income for moderate-income households (three-member households with one commuter making 80% or less of area median household income) was used as a proxy to represent transportation cost burden for all areas. LAI data were also downscaled to the Block Group level for the purpose of demographic analyses and comparisons. Census Block Groups belonging to a given Census Tract were assigned the same value as the overlying Tract. 


## American Community Survey 5-year Estimates {-}

The American Community Survey (ACS) is an ongoing survey by the U.S. Census Bureau that provides information on a yearly basis about the U.S. and its people. The ACS provides detailed information on economic, housing, and demographic characteristics about the population that are not captured by the decennial Census. 

The ACS provides greater demographic detail and temporal resolution than the decennial Census, but its geographic resolution is more limited. While the decennial Census is based on an enumeration (i.e., a total count) of everyone in the U.S. once every decade, the ACS is based on a statistical sample of approximately 3.5 million addresses across the country each year. As a result of this sampling approach, the ACS estimates must be pooled, or combined, across multiple years in order to provide reliable estimates for smaller areas (i.e. areas with less than 20,000 people), such as at the Tract or Block Group levels. While it is possible to know the number of low income households across the U.S. annually, one may only know this about a Tract or Block Group based on 5-year estimates. Since 2010, the ACS has published 5-year data (beginning with 20052009 estimates) for all geographic areas down to the census Tract and Block Group levels. For more detail on the ACS, see Understanding and Using American Community Survey Data: What All Data Users Need to Know at https://www.census.gov/programs-surveys/acs/guidance/handbooks/general.html.

All data was analyzed or aggregated geographically by Census Tract and Block Group. A Census Tract is a small, relatively permanent statistical subdivision of a county that contains between 1,200 and 8,000 people. The entire area of a county is covered by Census Tracts, just as the entire area of a state is covered by counties or county equivalents. Census Tracts range in areal size depending on the population density; areal size is smaller in denser areas and larger in less densely populated areas. Census Block Groups are subdivisions of Census Tracts that contain between 600 and 3,000 people. Like Tracts, Block Groups range in areal size depending on the population density of the area. Block Groups are the smallest geographic unit at which detailed demographic and household data from the American Community Survey is made available by the Census. 

For the purposes of this analysis ACS 5-year estimates for the period 2014 - 2018 for Census Tracts and Block Groups in Massachusetts, as well as their associated TIGER/Line spatial files, were downloaded from the Census Bureau via API using the `tigris` package in R. Demographic variables consistent with those used by the EPA in EJSCREEN were chosen, as well as environmental justice population thresholds used by states where available. Table \@ref(tab:ACSvariables) below lists the demographic variables that were downloaded directly or computed from ACS variables:

```{r ACSvariables}
ACSvDF <- data.frame(Variable = c("Total Population",
                                  "Minority",
                                  "Low Income",
                                  "Limited English Household",
                                  "Less than High School Education",
                                  "Under 5",
                                  "Under 18",
                                  "Over 64",
                                  "Disabled",
                                  "No Car Household",
                                  "CT Income",
                                  "MA Income",
                                  "MA Limited English Household",
                                  "MA Minority",
                                  "MA Income",
                                  "MA Minority"),
                     Description = c("Total population",
                                     "Persons of Hispanic or Latino origin or persons who are not White",
                                     "People in households where the household income is less than or equal to twice the federal poverty level",
                                     "People in households where all adults speak English less than \"very well\"",
                                     "Adults 25 years+ with less than a high school education",
                                     "Persons under 5 years of age",
                                     "Persons under 18 years of age",
                                     "Persons over 64 years of age",
                                     "Persons 18 years+ with a disability",
                                     "Households with no vehicle available",
                                     "Connecticut Low Income threshold: 30% or more people in households where the household income is less than or equal to twice the federal poverty level",
                                     "Massachusetts Low Income threshold: 25% or more of households with median household incomes below 65% statewide median",
                                     "Massachusetts Language Isolation threshold: 25% or more people in households where all adults speak English less than \"very well\"",
                                     "Massachusetts Minority threshold: 25% or more are persons of Hispanic or Latino origin or persons who are not White",
                                     "Massachusetts Low Income threshold: highest 15% of block groups with people in households where the household income is less than or equal to twice the federal poverty level",
                                     "Massachusetts Minority threshold: highest 15% of block groups with persons of Hispanic or Latino origin or persons who are not White"),
                     'ACS Table ID' = c("B03002: Hispanic or Latino Origin by Race",
                                "B03002: Hispanic or Latino Origin by Race",
                                "C17002: Ratio of Income to Poverty Level",
                                "C16002: Household Language by Household Limited English Speaking Status",
                                "B15002: Sex by Educational Attainment",
                                "B01001: Sex by Age",
                                "B01001: Sex by Age",
                                "B01001: Sex by Age",
                                "B18101: Sex by Age by Disability Status",
                                "B08201: Household Size by Vehicles Available",
                                "C17002: Ratio of Income to Poverty Level",
                                "B19001: Household Income",
                                "C16002: Household Language by Household Limited English Speaking Status",
                                "B03002: Hispanic or Latino Origin by Race",
                                "C17002: Ratio of Income to Poverty Level",
                                "B03002: Hispanic or Latino Origin by Race"),
                     Geography = c("Block Group",
                                   "Block Group",
                                   "Block Group",
                                   "Block Group",
                                   "Block Group",
                                   "Block Group",
                                   "Block Group",
                                   "Block Group",
                                   "Tract",
                                   "Tract",
                                   "Block Group",
                                   "Block Group",
                                   "Block Group",
                                   "Block Group",
                                   "Block Group",
                                   "Block Group"))

ACSvDF %>% 
  kableExtra::kable(longtable = T, booktabs = T, 
                    caption = "Demographic Variables", align = "l",
                    col.names = c("Variable","Description","ACS Table ID","Geography")) %>% 
  kableExtra::column_spec(2:3, width = "3cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped"))
  
```

## Population-weighted averages {-}

Wherever feasible, averages are reported as population-weighted averages. A population weighted-average is equivalent to a weighted mean in which the raw values for which a mean (or average) is calculated are multiplied by a weight factor. For example, we are interested in knowing whether Minorities experience longer headways than the general or Total Population. Consider the table below.

```{r wmean1}
data.frame(BG = c("BG1","BG2","BG3","BG4"),
           Headway = c(65,75,85,70),
           Minority = c(5,10,20,10),
           NonMinority = c(20,12,5,10)) %>% 
  mutate(TotalPop = Minority + NonMinority) %>% 
  kableExtra::kable(longtable = T, booktabs = T, 
                    caption = "Block Group Populations and Headways", align = "l") %>% 
  kableExtra::kable_styling(latex_options = c("repeat_header"))
```

Population numbers of minorities, as well as the total population, and headways, are each reported by Block Group. Since each Block Group is associated with one headway value, we might assume (incorrectly) that everyone is equally exposed to the average headways of all Block Groups (`r round(mean(c(65,75,85,70)),2)`). However, not all Block Groups have the same number or categories of people, which means that each headway value is associated with a different number of people. Do Minorities occupy Block Groups with higher headways than the simple average would indicate?

To calculate the population-weighted average headway for Minorities, the number of Minorities in each Block Group is used as a 'weight'. The headway of each Block Group is multiplied by its respective number of Minorities. See the table below. 

```{r wmean2}
data.frame(BG = c("BG1","BG2","BG3","BG4"),
           Headway = c(65,75,85,70),
           Minority = c(5,10,20,10),
           NonMinority = c(20,12,5,10)) %>% 
  mutate(TotalPop = Minority + NonMinority,
         HeadwayxMinority = Headway*Minority) %>% 
  bind_rows(summarize_all(., funs(if(is.numeric(.)) sum(.) else "Total"))) %>% 
  kableExtra::kable(longtable = T, booktabs = T, 
                    caption = "Block Group Populations and Headway", 
                    align = "l") %>% 
  kableExtra::kable_styling(latex_options = c("repeat_header")) %>% 
  kableExtra::row_spec(5, bold = TRUE) %>% 
  kableExtra::column_spec(6, bold = TRUE, background = "#d3d3d3")
```

The total or sum of the products (i.e., Minority pop x Headway) is then divided by the sum of the weights (i.e., total Minority population), so that 3475/45 = `r round(3475/45,2)`. The result is a weighted average headway that is influenced by the number of minorities. 

This process is repeated for the Total Population so that the two population-weighted average headways can be compared. Below is the calculation of population-weighted calculation for the total population. 

```{r wmean3}
data.frame(BG = c("BG1","BG2","BG3","BG4"),
           Headway = c(65,75,85,70),
           Minority = c(5,10,20,10),
           NonMinority = c(20,12,5,10)) %>% 
  mutate(TotalPop = Minority + NonMinority,
         TempxTotalPop = Headway*TotalPop) %>% 
  bind_rows(summarize_all(., funs(if(is.numeric(.)) sum(.) else "Total"))) %>% 
  kableExtra::kable(longtable = T, booktabs = T, 
                    caption = "Block Group Populations and Headway", 
                    align = "l") %>% 
  kableExtra::kable_styling(latex_options = c("repeat_header")) %>% 
  kableExtra::row_spec(5, bold = TRUE) %>% 
  kableExtra::column_spec(6, bold = TRUE, background = "#d3d3d3")
```

For the TotalPop, the population-weighted average headway is 6800/92 = `r round(6800/92,2)`. Thus we can see that Minorities experience a higher population-weighted average headway than the general or total population. 


\pagebreak
# Appendix B: Supplementary Figures {-}

## No Transit Access and Populations of Concern {-}

### No Bus Access and Populations of Concern {-}

```{r mapBusAccessU18, fig.align = "center", fig.cap="Persons under 18 who are one or more miles from the nearest bus stop by Census Block Group."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") +
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_blkgrps_sf_noBus_simple, unit = "mi") +
  tm_fill(col = "NewUnder18", style = "equal", colorNA = "white", 
          colorNULL = "gray", title = "Number of\nPersons Under 18",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) +
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_busRoutesAll_sf_simple) +
  # tm_lines(lwd = 2, alpha = 0.3, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black",
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5,
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Bus Route",
  #               col = "darkblue") +
  tm_layout(title = "Persons Under 18\n1+ Miles from\nNearest Bus\nStop",
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_busU18access.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_busU18access.png")
```

```{r tabBusAccessU18, fig.align = "center", fig.cap="Persons under 18 in Census Block Groups one or more miles from the nearest bus stop."}
ma_blkgrps_sf_noBus %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Under 18` = sum(NewUnder18,na.rm = TRUE),
            `Pct of Under 18` = round(sum(NewUnder18)/max(TotalUnder18)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Under 18` > 0) %>% 
  mutate(`Pct of Under 18` = if_else(`Pct of Under 18` > 100, 100, `Pct of Under 18`)) %>%
  mutate(`Pct of Under 18` = paste0(`Pct of Under 18`,"%")) %>% 
  arrange(desc(`Under 18`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Persons Under 18 One or More Miles from Nearest Bus Stop", align = "r", col.names = c(names(.)[1:2],"Number of Under 18 in Block Groups","Pct of Under 18 in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapBusAccessDisabled, fig.align = "center", fig.cap="Disabled persons who are one or more miles from the nearest bus stop by Census Tract."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") +
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_tracts_sf_noBus_simple, unit = "mi") +
  tm_fill(col = "NewDisabled", style = "quantile",
          colorNA = "white", colorNULL = "gray", title = "Number of\nDisabled Persons",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_tracts_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) +
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_busRoutesAll_sf_simple) +
  # tm_lines(lwd = 2, alpha = 0.3, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black",
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 5, 10), text.size = 0.5,
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Bus Route", col = "darkblue") +
  tm_layout(title = "Disabled Persons\n1+ Miles from\nNearest Bus\nStop",
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_busDisabledaccess.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_busDisabledaccess.png")
```

```{r tabBusAccessDisabled, fig.align = "center", fig.cap="Disabled Persons in Census Block Groups one or more miles from the nearest bus stop."}
ma_tracts_sf_noBus %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Tracts` = n(),
            Disabled = sum(NewDisabled,na.rm = TRUE),
            `Pct of Disabled` = round(sum(NewDisabled)/max(TotalDisabled)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Disabled` > 0) %>% 
  mutate(`Pct of Disabled` = if_else(`Pct of Disabled` > 100, 100, `Pct of Disabled`)) %>%
  mutate(`Pct of Disabled` = paste0(`Pct of Disabled`,"%")) %>% 
  arrange(desc(Disabled)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Disabled Persons One or More Miles from Nearest Bus Stop", align = "r", col.names = c(names(.)[1:2],"Number of Disabled in Census Tracts","Pct of Disabled in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapBusAccessU5, fig.align = "center", fig.cap="Children under 5 who are one or more miles from the nearest transit stop by Census Block Group."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") +
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_blkgrps_sf_noBus_simple, unit = "mi") +
  tm_fill(col = "NewUnder5", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nChildren Under 5",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) +
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_busRoutesAll_sf_simple) +
  # tm_lines(lwd = 2, alpha = 0.3, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black",
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5,
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Bus Route", col = "darkblue") +
  tm_layout(title = "Children Under 5\n1+ Miles from\nNearest Bus\nStop",
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_busU5access.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_busU5access.png")
```

```{r tabBusAccessU5, fig.align = "center", fig.cap="Children under 5 in Census Block Groups one or more miles from the nearest bus stop."}
ma_blkgrps_sf_noBus %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Under 5` = sum(NewUnder5,na.rm = TRUE),
            `Pct of Under 5` = round(sum(NewUnder5)/max(TotalUnder5)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Under 5` > 0) %>% 
  mutate(`Pct of Under 5` = if_else(`Pct of Under 5` > 100, 100, `Pct of Under 5`)) %>%
  mutate(`Pct of Under 5` = paste0(`Pct of Under 5`,"%")) %>% 
  arrange(desc(`Under 5`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Children Under 5 One or More Miles from Nearest Bus Stop", align = "r", col.names = c(names(.)[1:2],"Number of Under 5 in Block Groups","Pct of Under 5 in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapBusAccessMAINC, fig.align = "center", fig.cap="Low income persons, as defined by state environmental justice policy, who are one or more miles from the nearest transit stop by Census Block Group."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") +
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_blkgrps_sf_noBus_simple, unit = "mi") +
  tm_fill(col = "NewMA_LOWINC", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nMA Low Income\nPersons",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) +
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_busRoutesAll_sf_simple) +
  # tm_lines(lwd = 2, alpha = 0.3, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black",
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5,
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Bus Route", col = "darkblue") +
  tm_layout(title = "MA Low Income\nPersons 1+ Miles\nfrom Nearest\nBus Stop",
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_busMAINCaccess.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_busMAINCaccess.png")
```

```{r tabBusAccessMAINC, fig.align = "center", fig.cap="Low income persons, as defined by state environmental justice policy, in Census Block Groups one or more miles from the nearest bus stop."}
ma_blkgrps_sf_noBus %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `MA Low Income` = sum(NewMA_LOWINC,na.rm = TRUE),
            `Pct of MA Low Income` = round(sum(NewMA_LOWINC)/max(TotalMA_LOWINC)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of MA Low Income` > 0) %>% 
  mutate(`Pct of MA Low Income` = if_else(`Pct of MA Low Income` > 100,100,`Pct of MA Low Income`)) %>% 
  mutate(`Pct of MA Low Income` = paste0(`Pct of MA Low Income`,"%")) %>% 
  arrange(desc(`MA Low Income`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Low Income Persons One or More Miles from Nearest Transit Stop", align = "r", col.names = c(names(.)[1:2],"Number of MA Low Income in Block Groups","Pct of MA Low Income in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapBusAccessINC, fig.align = "center", fig.cap="Low income persons who are one or more miles from the nearest transit stop by Census Block Group."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") +
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_blkgrps_sf_noBus_simple, unit = "mi") +
  tm_fill(col = "NewPov", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nLow Income\nPersons",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) +
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_busRoutesAll_sf_simple) +
  # tm_lines(lwd = 1, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black",
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5,
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=1, labels = "Bus Route", col = "darkblue") +
  tm_layout(title = "Low Income\nPersons 1+ Miles\nfrom Nearest\nBus Stop",
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_busINCaccess.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_busINCaccess.png")
```

```{r tabBusAccessINC, fig.align = "center", fig.cap="Low income persons in Census Block Groups one or more miles from the nearest bus stop."}
ma_blkgrps_sf_noBus %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Low Income` = sum(NewPov,na.rm = TRUE),
            `Pct of Low Income` = round(sum(NewPov)/max(TotalLowInc)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Low Income` > 0) %>% 
  mutate(`Pct of Low Income` = if_else(`Pct of Low Income` > 100,100,`Pct of Low Income`)) %>% 
  mutate(`Pct of Low Income` = paste0(`Pct of Low Income`,"%")) %>% 
  arrange(desc(`Low Income`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Low Income Persons One or More Miles from Nearest Transit Stop", align = "r", col.names = c(names(.)[1:2],"Number of Low Income in Block Groups","Pct of Low Income in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapBusAccessNOHS, fig.align = "center", fig.cap="Adults without a high school diploma who are one or more miles from the nearest bus stop by Census Block Group."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_blkgrps_sf_noBus_simple, unit = "mi") +
  tm_fill(col = "NewLths", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nAdults without a\nHigh School Diploma",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_busRoutesAll_sf_simple) +
  # tm_lines(lwd = 1, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Transit Route") +
  tm_layout(title = "Adults without a\nHigh School Diploma\n1+ Miles from\nNearest Transit\nStop", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_busNOHSaccess.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_busNOHSaccess.png")
```

```{r tabBusAccessNOHS, fig.align = "center", fig.cap="Adults without a high school diploma in Census Block Groups one or more miles from the nearest bus stop."}
ma_blkgrps_sf_noBus %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `No HS Dip` = sum(NewLths,na.rm = TRUE),
            `Pct of No HS Dip` = round(sum(NewLths)/max(TotalNoHS)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of No HS Dip` > 0) %>% 
  mutate(`Pct of No HS Dip` = if_else(`Pct of No HS Dip` > 100, 100, `Pct of No HS Dip`)) %>% 
  mutate(`Pct of No HS Dip` = paste0(`Pct of No HS Dip`,"%")) %>% 
  arrange(desc(`No HS Dip`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Adults without a High School Diploma One or More Miles from Nearest Bus Stop", align = "r", col.names = c(names(.)[1:2],"Number of No HS Dip in Block Groups","Pct of No HS Dip in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapBusAccessMIN, fig.align = "center", fig.cap="Minority persons who are one or more miles from the nearest bus stop by Census Block Group."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_blkgrps_sf_noBus_simple, unit = "mi") +
  tm_fill(col = "NewMinority", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nMinority Persons",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_busRoutesAll_sf_simple) +
  # tm_lines(lwd = 1, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Transit Route") +
  tm_layout(title = "Minority Persons\n1+ Miles from\nNearest Bus\nStop", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_busMINaccess.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_busMINaccess.png")
```

```{r tabBusAccessMIN, fig.align = "center", fig.cap="Minority persons in Census Block Groups one or more miles from the nearest bus stop."}
ma_blkgrps_sf_noBus %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            Minority = sum(NewOver64,na.rm = TRUE),
            `Pct of Minority` = round(sum(NewMinority)/max(TotalMin)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Minority` > 0) %>% 
  mutate(`Pct of Minority` = if_else(`Pct of Minority` > 100, 100, `Pct of Minority`)) %>% 
  mutate(`Pct of Minority` = paste0(`Pct of Minority`,"%")) %>% 
  arrange(desc(Minority)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Minority Persons One or More Miles from Nearest Bus Stop", align = "r", col.names = c(names(.)[1:2],"Number of Minorities in Block Groups","Pct of Minorities in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapBusAccessNoCar, fig.align = "center", fig.cap="Households without a car that are one or more miles from the nearest bus stop by Census Tract."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_tracts_sf_noBus_simple, unit = "mi") +
  tm_fill(col = "NewHHNoCar", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nNo Car Households",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_tracts_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_busRoutesAll_sf_simple) +
  # tm_lines(lwd = 1, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Transit Route") +
  tm_layout(title = "Households\nwithout a Car\n1+ Miles from\nNearest Bus\nStop", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_busNoCaraccess.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_busNoCaraccess.png")
```

```{r tabBusAccessNoCar, fig.align = "center", fig.cap="Households without a car in Census Tracts one or more miles from the nearest bus stop."}
ma_tracts_sf_noBus %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Tracts` = n(),
            `No Car HH` = sum(NewHHNoCar,na.rm = TRUE),
            `Pct of No Car HH` = round(sum(NewHHNoCar)/max(TotalNoCar)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of No Car HH` > 0) %>% 
  mutate(`Pct of No Car HH` = if_else(`Pct of No Car HH` > 100, 100, `Pct of No Car HH`)) %>%
  mutate(`Pct of No Car HH` = paste0(`Pct of No Car HH`,"%")) %>% 
  arrange(desc(`No Car HH`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Households without a Car One or More Miles from Nearest Bus Stop", align = "r", col.names = c(names(.)[1:2],"Number of No Car Households in Census Tracts","Pct of No Car Households in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped"))
```

```{r mapBusAccessMAMIN, fig.align = "center", fig.cap="Minority persons, as defined by state environmental justice policy, who are one or more miles from the nearest bus stop by Census Block Group."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_blkgrps_sf_noBus_simple, unit = "mi") +
  tm_fill(col = "NewMA_MINORITY", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nMA Minority Persons",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_busRoutesAll_sf_simple) +
  # tm_lines(lwd = 1, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Transit Route") +
  tm_layout(title = "MA Minority Persons\n1+ Miles from\nNearest Bus\nStop", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_busMAMINaccess.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_busMAMINaccess.png")
```

```{r tabBusAccessMAMIN, fig.align = "center", fig.cap="MA Minority persons in Census Block Groups one or more miles from the nearest bus stop."}
ma_blkgrps_sf_noBus %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `MA Minority` = sum(NewMA_MINORITY,na.rm = TRUE),
            `Pct of MA Minority` = round(sum(NewMA_MINORITY)/max(TotalMA_MINORITY)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of MA Minority` > 0) %>% 
  mutate(`Pct of MA Minority` = if_else(`Pct of MA Minority` > 100, 100, `Pct of MA Minority`)) %>%
  mutate(`Pct of MA Minority` = paste0(`Pct of MA Minority`,"%")) %>% 
  arrange(desc(`MA Minority`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "MA Minority Persons One or More Miles from Nearest Bus Stop", align = "r", col.names = c(names(.)[1:2],"Number of Minorities in Block Groups","Pct of Minorities in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapBusAccessLEH, fig.align = "center", fig.cap="Limited English speaking households that are one or more miles from the nearest bus stop by Census Block Group."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_blkgrps_sf_noBus_simple, unit = "mi") +
  tm_fill(col = "NewEng_limit", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nLimited English Households",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_busRoutesAll_sf_simple) +
  # tm_lines(lwd = 1, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Transit Route") +
  tm_layout(title = "Limited English\nSpeaking\nHouseholds\n1+ Miles from\nNearest Bus\nStop", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_busLEHaccess.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_busLEHaccess.png")
```

```{r tabBusAccessLEH, fig.align = "center", fig.cap="Limited English speaking households in Census Block Groups one or more miles from the nearest bus stop."}
ma_blkgrps_sf_noBus %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Limited English HH` = sum(NewEng_limit,na.rm = TRUE),
            `Pct of Limited English HH` = round(sum(NewEng_limit)/max(TotalLEH)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  mutate(`Pct of Limited English HH` = if_else(`Pct of Limited English HH` > 100, 100, `Pct of Limited English HH`)) %>% 
  filter(`Pct of Limited English HH` > 0) %>% 
  mutate(`Pct of Limited English HH` = paste0(`Pct of Limited English HH`,"%")) %>% 
  arrange(desc(`Limited English HH`)) %>% 
  filter(`Limited English HH` > 0) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Limited English Speaking Households One or More Miles from Nearest Bus Stop", align = "r", col.names = c(names(.)[1:2],"Number of Limited English Households in Block Groups","Pct of Limited English Households in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapBusAccessMALEH, fig.align = "center", fig.cap="Limited English speaking households, as defined by state environmental justice policy, that are one or more miles from the nearest bus stop by Census Block Group."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_blkgrps_sf_noBus_simple, unit = "mi") +
  tm_fill(col = "NewMA_ENGLISH", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nMA Limited English\nHouseholds",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_busRoutesAll_sf_simple) +
  # tm_lines(lwd = 1, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Transit Route") +
  tm_layout(title = "MA Limited English\nSpeaking\nHouseholds\n1+ Miles from\nNearest Bus\nStop", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_busMALEHaccess.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_busMALEHaccess.png")
```

```{r tabBusAccessMALEH, fig.align = "center", fig.cap="Limited English speaking households, as defined by state environmental justice policy, in Census Block Groups one or more miles from the nearest bus stop."}
ma_blkgrps_sf_noBus %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `MA Limited English HH` = sum(NewMA_ENGLISH,na.rm = TRUE),
            `Pct of MA Limited English HH` = round(sum(NewMA_ENGLISH)/max(TotalMA_ENGLISH)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  mutate(`Pct of MA Limited English HH` = if_else(`Pct of MA Limited English HH` > 100, 100, `Pct of MA Limited English HH`)) %>% 
  filter(`Pct of MA Limited English HH` > 0) %>% 
  mutate(`Pct of MA Limited English HH` = paste0(`Pct of MA Limited English HH`,"%")) %>% 
  arrange(desc(`MA Limited English HH`)) %>% 
  filter(`MA Limited English HH` > 0) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "MA Limited English Speaking Households One or More Miles from Nearest Bus Stop", align = "r", col.names = c(names(.)[1:2],"Number of MA Limited English Households in Block Groups","Pct of MA Limited English Households in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```


### No Rapid Transit Access and Populations of Concern {-}

```{r mapRTAccessDisabled, fig.align = "center", fig.cap="Disabled persons who are one or more miles from the nearest rapid transit stop by Census Tract."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") +
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_tracts_sf_noRT_simple, unit = "mi") +
  tm_fill(col = "NewDisabled", style = "quantile",
          colorNA = "white", colorNULL = "gray", title = "Number of\nDisabled Persons",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_tracts_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) +
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_RTRoutesAll_sf_simple) +
  # tm_lines(lwd = 2, alpha = 0.3, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black",
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 5, 10), text.size = 0.5,
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Bus Route", col = "darkblue") +
  tm_layout(title = "Disabled Persons\n1+ Miles from\nNearest Rapid\n Transit Stop",
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_RTDisabledaccess.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_RTDisabledaccess.png")
```

```{r tabRTAccessDisabled, fig.align = "center", fig.cap="Disabled Persons in Census Block Groups one or more miles from the nearest rapid transit stop."}
ma_tracts_sf_noRT %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Tracts` = n(),
            Disabled = sum(NewDisabled,na.rm = TRUE),
            `Pct of Disabled` = round(sum(NewDisabled)/max(TotalDisabled)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Disabled` > 0) %>%
  mutate(`Pct of Disabled` = if_else(`Pct of Disabled` > 100, 100, `Pct of Disabled`)) %>% 
  mutate(`Pct of Disabled` = paste0(`Pct of Disabled`,"%")) %>% 
  arrange(desc(Disabled)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Disabled Persons One or More Miles from Nearest Rapid Transit Stop", align = "r", col.names = c(names(.)[1:2],"Number of Disabled in Census Tracts","Pct of Disabled in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapRTAccessU5, fig.align = "center", fig.cap="Children under 5 who are one or more miles from the nearest rapid transit stop by Census Block Group."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") +
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_blkgrps_sf_noRT_simple, unit = "mi") +
  tm_fill(col = "NewUnder5", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nChildren Under 5",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) +
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_RTRoutesAll_sf_simple) +
  # tm_lines(lwd = 2, alpha = 0.3, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black",
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5,
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Bus Route", col = "darkblue") +
  tm_layout(title = "Children Under 5\n1+ Miles from\nNearest Rapid\n Transit Stop",
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_RTU5access.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_RTU5access.png")
```

```{r tabRTAccessU5, fig.align = "center", fig.cap="Children under 5 in Census Block Groups one or more miles from the nearest rapid transit stop."}
ma_blkgrps_sf_noRT %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Under 5` = sum(NewUnder5,na.rm = TRUE),
            `Pct of Under 5` = round(sum(NewUnder5)/max(TotalUnder5)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Under 5` > 0) %>% 
  mutate(`Pct of Under 5` = if_else(`Pct of Under 5` > 100, 100, `Pct of Under 5`)) %>% 
  mutate(`Pct of Under 5` = paste0(`Pct of Under 5`,"%")) %>% 
  arrange(desc(`Under 5`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Children Under 5 One or More Miles from Nearest Rapid Transit Stop", align = "r", col.names = c(names(.)[1:2],"Number of Under 5 in Block Groups","Pct of Under 5 in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapRTAccessMAINC, fig.align = "center", fig.cap="Low income persons, as defined by state environmental justice policy, who are one or more miles from the nearest transit stop by Census Block Group."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") +
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_blkgrps_sf_noRT_simple, unit = "mi") +
  tm_fill(col = "NewMA_LOWINC", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nMA Low Income\nPersons",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) +
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_RTRoutesAll_sf_simple) +
  # tm_lines(lwd = 2, alpha = 0.3, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black",
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5,
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Bus Route", col = "darkblue") +
  tm_layout(title = "MA Low Income\nPersons 1+ Miles\nfrom Nearest\nRapid Transit Stop",
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_RTMAINCaccess.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_RTMAINCaccess.png")
```

```{r tabRTAccessMAINC, fig.align = "center", fig.cap="Low income persons, as defined by state environmental justice policy, in Census Block Groups one or more miles from the nearest rapid transit stop."}
ma_blkgrps_sf_noRT %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `MA Low Income` = sum(NewMA_LOWINC,na.rm = TRUE),
            `Pct of MA Low Income` = round(sum(NewMA_LOWINC)/max(TotalMA_LOWINC)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of MA Low Income` > 0) %>% 
  mutate(`Pct of MA Low Income` = if_else(`Pct of MA Low Income` > 100,100,`Pct of MA Low Income`)) %>% 
  mutate(`Pct of MA Low Income` = paste0(`Pct of MA Low Income`,"%")) %>% 
  arrange(desc(`MA Low Income`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Low Income Persons One or More Miles from Nearest Transit Stop", align = "r", col.names = c(names(.)[1:2],"Number of MA Low Income in Block Groups","Pct of MA Low Income in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapRTAccessINC, fig.align = "center", fig.cap="Low income persons who are one or more miles from the nearest transit stop by Census Block Group."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") +
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_blkgrps_sf_noRT_simple, unit = "mi") +
  tm_fill(col = "NewPov", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nLow Income\nPersons",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) +
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_RTRoutesAll_sf_simple) +
  # tm_lines(lwd = 1, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black",
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5,
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=1, labels = "Bus Route", col = "darkblue") +
  tm_layout(title = "Low Income\nPersons 1+ Miles\nfrom Nearest\nRapid Transit Stop",
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_RTINCaccess.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_RTINCaccess.png")
```

```{r tabRTAccessINC, fig.align = "center", fig.cap="Low income persons in Census Block Groups one or more miles from the nearest rapid transit stop."}
ma_blkgrps_sf_noRT %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Low Income` = sum(NewPov,na.rm = TRUE),
            `Pct of Low Income` = round(sum(NewPov)/max(TotalLowInc)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Low Income` > 0) %>% 
  mutate(`Pct of Low Income` = if_else(`Pct of Low Income` > 100,100,`Pct of Low Income`)) %>% 
  mutate(`Pct of Low Income` = paste0(`Pct of Low Income`,"%")) %>% 
  arrange(desc(`Low Income`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Low Income Persons One or More Miles from Nearest Transit Stop", align = "r", col.names = c(names(.)[1:2],"Number of Low Income in Block Groups","Pct of Low Income in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapRTAccessNOHS, fig.align = "center", fig.cap="Adults without a high school diploma who are one or more miles from the nearest rapid transit stop by Census Block Group."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_blkgrps_sf_noRT_simple, unit = "mi") +
  tm_fill(col = "NewLths", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nAdults without a\nHigh School Diploma",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_RTRoutesAll_sf_simple) +
  # tm_lines(lwd = 1, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Transit Route") +
  tm_layout(title = "Adults without a\nHigh School Diploma\n1+ Miles from\nNearest Transit\nStop", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_RTNOHSaccess.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_RTNOHSaccess.png")
```

```{r tabRTAccessNOHS, fig.align = "center", fig.cap="Adults without a high school diploma in Census Block Groups one or more miles from the nearest rapid transit stop."}
ma_blkgrps_sf_noRT %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `No HS Dip` = sum(NewLths,na.rm = TRUE),
            `Pct of No HS Dip` = round(sum(NewLths)/max(TotalNoHS)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of No HS Dip` > 0) %>% 
  mutate(`Pct of No HS Dip` = if_else(`Pct of No HS Dip` > 100, 100, `Pct of No HS Dip`)) %>% 
  mutate(`Pct of No HS Dip` = paste0(`Pct of No HS Dip`,"%")) %>% 
  arrange(desc(`No HS Dip`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Adults without a High School Diploma One or More Miles from Nearest Rapid Transit Stop", align = "r", col.names = c(names(.)[1:2],"Number of No HS Dip in Block Groups","Pct of No HS Dip in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapRTAccessMIN, fig.align = "center", fig.cap="Minority persons who are one or more miles from the nearest rapid transit stop by Census Block Group."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_blkgrps_sf_noRT_simple, unit = "mi") +
  tm_fill(col = "NewMinority", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nMinority Persons",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_RTRoutesAll_sf_simple) +
  # tm_lines(lwd = 1, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Transit Route") +
  tm_layout(title = "Minority Persons\n1+ Miles from\nNearest Rapid\n Transit Stop", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_RTMINaccess.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_RTMINaccess.png")
```

```{r tabRTAccessMIN, fig.align = "center", fig.cap="Minority persons in Census Block Groups one or more miles from the nearest rapid transit stop."}
ma_blkgrps_sf_noRT %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            Minority = sum(NewOver64,na.rm = TRUE),
            `Pct of Minority` = round(sum(NewMinority)/max(TotalMin)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Minority` > 0) %>% 
  mutate(`Pct of Minority` = if_else(`Pct of Minority` > 100, 100, `Pct of Minority`)) %>% 
  mutate(`Pct of Minority` = paste0(`Pct of Minority`,"%")) %>% 
  arrange(desc(Minority)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Minority Persons One or More Miles from Nearest Rapid Transit Stop", align = "r", col.names = c(names(.)[1:2],"Number of Minorities in Block Groups","Pct of Minorities in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapRTAccessNoCar, fig.align = "center", fig.cap="Households without a car that are one or more miles from the nearest rapid transit stop by Census Tract."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_tracts_sf_noRT_simple, unit = "mi") +
  tm_fill(col = "NewHHNoCar", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nNo Car Households",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_tracts_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_RTRoutesAll_sf_simple) +
  # tm_lines(lwd = 1, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Transit Route") +
  tm_layout(title = "Households\nwithout a Car\n1+ Miles from\nNearest Rapid\n Transit Stop", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_RTNoCaraccess.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_RTNoCaraccess.png")
```

```{r tabRTAccessNoCar, fig.align = "center", fig.cap="Households without a car in Census Tracts one or more miles from the nearest rapid transit stop."}
ma_tracts_sf_noRT %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Tracts` = n(),
            `No Car HH` = sum(NewHHNoCar,na.rm = TRUE),
            `Pct of No Car HH` = round(sum(NewHHNoCar)/max(TotalNoCar)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of No Car HH` > 0) %>% 
  mutate(`Pct of No Car HH` = if_else(`Pct of No Car HH` > 100, 100, `Pct of No Car HH`)) %>% 
  mutate(`Pct of No Car HH` = paste0(`Pct of No Car HH`,"%")) %>% 
  arrange(desc(`No Car HH`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Households without a Car One or More Miles from Nearest Rapid Transit Stop", align = "r", col.names = c(names(.)[1:2],"Number of No Car Households in Census Tracts","Pct of No Car Households in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped"))
```

```{r mapRTAccessMAMIN, fig.align = "center", fig.cap="Minority persons, as defined by state environmental justice policy, who are one or more miles from the nearest rapid transit stop by Census Block Group."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_blkgrps_sf_noRT_simple, unit = "mi") +
  tm_fill(col = "NewMA_MINORITY", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nMA Minority Persons",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_RTRoutesAll_sf_simple) +
  # tm_lines(lwd = 1, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Transit Route") +
  tm_layout(title = "MA Minority Persons\n1+ Miles from\nNearest Rapid\n Transit Stop", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_RTMAMINaccess.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_RTMAMINaccess.png")
```

```{r tabRTAccessMAMIN, fig.align = "center", fig.cap="MA Minority persons in Census Block Groups one or more miles from the nearest rapid transit stop."}
ma_blkgrps_sf_noRT %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `MA Minority` = sum(NewMA_MINORITY,na.rm = TRUE),
            `Pct of MA Minority` = round(sum(NewMA_MINORITY)/max(TotalMA_MINORITY)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of MA Minority` > 0) %>% 
  mutate(`Pct of MA Minority` = if_else(`Pct of MA Minority` > 100, 100, `Pct of MA Minority`)) %>% 
  mutate(`Pct of MA Minority` = paste0(`Pct of MA Minority`,"%")) %>% 
  arrange(desc(`MA Minority`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "MA Minority Persons One or More Miles from Nearest Rapid Transit Stop", align = "r", col.names = c(names(.)[1:2],"Number of Minorities in Block Groups","Pct of Minorities in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapRTAccessLEH, fig.align = "center", fig.cap="Limited English speaking households that are one or more miles from the nearest rapid transit stop by Census Block Group."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_blkgrps_sf_noRT_simple, unit = "mi") +
  tm_fill(col = "NewEng_limit", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nLimited English Households",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_RTRoutesAll_sf_simple) +
  # tm_lines(lwd = 1, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Transit Route") +
  tm_layout(title = "Limited English\nSpeaking\nHouseholds\n1+ Miles from\nNearest Rapid\n Transit Stop", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_RTLEHaccess.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_RTLEHaccess.png")
```

```{r tabRTAccessLEH, fig.align = "center", fig.cap="Limited English speaking households in Census Block Groups one or more miles from the nearest rapid transit stop."}
ma_blkgrps_sf_noRT %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Limited English HH` = sum(NewEng_limit,na.rm = TRUE),
            `Pct of Limited English HH` = round(sum(NewEng_limit)/max(TotalLEH)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  mutate(`Pct of Limited English HH` = if_else(`Pct of Limited English HH` > 100, 100, `Pct of Limited English HH`)) %>% 
  filter(`Pct of Limited English HH` > 0) %>% 
  mutate(`Pct of Limited English HH` = paste0(`Pct of Limited English HH`,"%")) %>% 
  arrange(desc(`Limited English HH`)) %>% 
  filter(`Limited English HH` > 0) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Limited English Speaking Households One or More Miles from Nearest Rapid Transit Stop", align = "r", col.names = c(names(.)[1:2],"Number of Limited English Households in Block Groups","Pct of Limited English Households in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapRTAccessMALEH, fig.align = "center", fig.cap="Limited English speaking households, as defined by state environmental justice policy, that are one or more miles from the nearest rapid transit stop by Census Block Group."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_blkgrps_sf_noRT_simple, unit = "mi") +
  tm_fill(col = "NewMA_ENGLISH", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nMA Limited English\nHouseholds",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_RTRoutesAll_sf_simple) +
  # tm_lines(lwd = 1, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Transit Route") +
  tm_layout(title = "MA Limited English\nSpeaking\nHouseholds\n1+ Miles from\nNearest Rapid\n Transit Stop", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_RTMALEHaccess.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_RTMALEHaccess.png")
```

```{r tabRTAccessMALEH, fig.align = "center", fig.cap="Limited English speaking households, as defined by state environmental justice policy, in Census Block Groups one or more miles from the nearest rapid transit stop."}
ma_blkgrps_sf_noRT %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `MA Limited English HH` = sum(NewMA_ENGLISH,na.rm = TRUE),
            `Pct of MA Limited English HH` = round(sum(NewMA_ENGLISH)/max(TotalMA_ENGLISH)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  mutate(`Pct of MA Limited English HH` = if_else(`Pct of MA Limited English HH` > 100, 100, `Pct of MA Limited English HH`)) %>% 
  filter(`Pct of MA Limited English HH` > 0) %>% 
  mutate(`Pct of MA Limited English HH` = paste0(`Pct of MA Limited English HH`,"%")) %>% 
  arrange(desc(`MA Limited English HH`)) %>% 
  filter(`MA Limited English HH` > 0) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "MA Limited English Speaking Households One or More Miles from Nearest Rapid Transit Stop", align = "r", col.names = c(names(.)[1:2],"Number of MA Limited English Households in Block Groups","Pct of MA Limited English Households in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```


### No Commuter Rail Access and Populations of Concern {-}

```{r mapCRPRAccessU18, fig.align = "center", fig.cap="Persons under 18 who are ten or more miles from the nearest commuter rail stop or park-in-ride lot by Census Block Group."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") +
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_blkgrps_sf_noCRPR_simple, unit = "mi") +
  tm_fill(col = "NewUnder18", style = "equal", colorNA = "white", 
          colorNULL = "gray", title = "Number of\nPersons Under 18",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) +
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_CRPRRoutesAll_sf_simple) +
  # tm_lines(lwd = 2, alpha = 0.3, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black",
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5,
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Bus Route",
  #               col = "darkblue") +
  tm_layout(title = "Persons Under 18\n10+ Miles from\nNearest Commuter\nRail Stop\nor Park-in-Ride Lot",
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_CRPRU18access.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_CRPRU18access.png")
```

```{r tabCRPRAccessU18, fig.align = "center", fig.cap="Persons under 18 in Census Block Groups ten or more miles from the nearest commuter rail stop or park-in-ride lot."}
ma_blkgrps_sf_noCRPR %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Under 18` = sum(NewUnder18,na.rm = TRUE),
            `Pct of Under 18` = round(sum(NewUnder18)/max(TotalUnder18)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Under 18` > 0) %>% 
  mutate(`Pct of Under 18` = if_else(`Pct of Under 18` > 100, 100, `Pct of Under 18`)) %>% 
  mutate(`Pct of Under 18` = paste0(`Pct of Under 18`,"%")) %>% 
  arrange(desc(`Under 18`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Persons Under 18 Ten or More Miles from Nearest Commuter Rail Stop or Park-in-Ride Lot", align = "r", col.names = c(names(.)[1:2],"Number of Under 18 in Block Groups","Pct of Under 18 in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapCRPRAccessDisabled, fig.align = "center", fig.cap="Disabled persons who are ten or more miles from the nearest commuter rail stop or park-in-ride lot by Census Tract."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") +
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_tracts_sf_noCRPR_simple, unit = "mi") +
  tm_fill(col = "NewDisabled", style = "quantile",
          colorNA = "white", colorNULL = "gray", title = "Number of\nDisabled Persons",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_tracts_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) +
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_CRPRRoutesAll_sf_simple) +
  # tm_lines(lwd = 2, alpha = 0.3, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black",
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 5, 10), text.size = 0.5,
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Bus Route", col = "darkblue") +
  tm_layout(title = "Disabled Persons\n10+ Miles from\nNearest Commuter\nRail Stop\nor Park-in-Ride Lot",
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_CRPRDisabledaccess.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_CRPRDisabledaccess.png")
```

```{r tabCRPRAccessDisabled, fig.align = "center", fig.cap="Disabled Persons in Census Block Groups ten or more miles from the nearest commuter rail stop or park-in-ride lot."}
ma_tracts_sf_noCRPR %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Tracts` = n(),
            Disabled = sum(NewDisabled,na.rm = TRUE),
            `Pct of Disabled` = round(sum(NewDisabled)/max(TotalDisabled)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  mutate(`Pct of Disabled` = if_else(`Pct of Disabled` > 100, 100, `Pct of Disabled`)) %>% 
  filter(`Pct of Disabled` > 0) %>% 
  mutate(`Pct of Disabled` = paste0(`Pct of Disabled`,"%")) %>% 
  arrange(desc(Disabled)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Disabled Persons Ten or More Miles from Nearest Commuter Rail Stop or Park-in-Ride Lot", align = "r", col.names = c(names(.)[1:2],"Number of Disabled in Census Tracts","Pct of Disabled in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapCRPRAccessU5, fig.align = "center", fig.cap="Children under 5 who are ten or more miles from the nearest transit stop by Census Block Group."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") +
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_blkgrps_sf_noCRPR_simple, unit = "mi") +
  tm_fill(col = "NewUnder5", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nChildren Under 5",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) +
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_CRPRRoutesAll_sf_simple) +
  # tm_lines(lwd = 2, alpha = 0.3, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black",
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5,
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Bus Route", col = "darkblue") +
  tm_layout(title = "Children Under 5\n10+ Miles from\nNearest Commuter\nRail Stop\nor Park-in-Ride Lot",
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_CRPRU5access.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_CRPRU5access.png")
```

```{r tabCRPRAccessU5, fig.align = "center", fig.cap="Children under 5 in Census Block Groups ten or more miles from the nearest commuter rail stop or park-in-ride lot."}
ma_blkgrps_sf_noCRPR %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Under 5` = sum(NewUnder5,na.rm = TRUE),
            `Pct of Under 5` = round(sum(NewUnder5)/max(TotalUnder5)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Under 5` > 0) %>% 
  mutate(`Pct of Under 5` = if_else(`Pct of Under 5` > 100, 100, `Pct of Under 5`)) %>% 
  mutate(`Pct of Under 5` = paste0(`Pct of Under 5`,"%")) %>% 
  arrange(desc(`Under 5`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Children Under 5 Ten or More Miles from Nearest Commuter Rail Stop or Park-in-Ride Lot", align = "r", col.names = c(names(.)[1:2],"Number of Under 5 in Block Groups","Pct of Under 5 in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapCRPRAccessMAINC, fig.align = "center", fig.cap="Low income persons, as defined by state environmental justice policy, who are ten or more miles from the nearest transit stop by Census Block Group."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") +
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_blkgrps_sf_noCRPR_simple, unit = "mi") +
  tm_fill(col = "NewMA_LOWINC", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nMA Low Income\nPersons",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) +
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_CRPRRoutesAll_sf_simple) +
  # tm_lines(lwd = 2, alpha = 0.3, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black",
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5,
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Bus Route", col = "darkblue") +
  tm_layout(title = "MA Low Income\nPersons 10+ Miles\nfrom Nearest\nCommuter Rail Stop\nor Park-in-Ride Lot",
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_CRPRMAINCaccess.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_CRPRMAINCaccess.png")
```

```{r tabCRPRAccessMAINC, fig.align = "center", fig.cap="Low income persons, as defined by state environmental justice policy, in Census Block Groups ten or more miles from the nearest commuter rail stop or park-in-ride lot."}
ma_blkgrps_sf_noCRPR %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `MA Low Income` = sum(NewMA_LOWINC,na.rm = TRUE),
            `Pct of MA Low Income` = round(sum(NewMA_LOWINC)/max(TotalMA_LOWINC)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of MA Low Income` > 0) %>% 
  mutate(`Pct of MA Low Income` = if_else(`Pct of MA Low Income` > 100,100,`Pct of MA Low Income`)) %>% 
  mutate(`Pct of MA Low Income` = paste0(`Pct of MA Low Income`,"%")) %>% 
  arrange(desc(`MA Low Income`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Low Income Persons Ten or More Miles from Nearest Transit Stop", align = "r", col.names = c(names(.)[1:2],"Number of MA Low Income in Block Groups","Pct of MA Low Income in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapCRPRAccessINC, fig.align = "center", fig.cap="Low income persons who are ten or more miles from the nearest transit stop by Census Block Group."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") +
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_blkgrps_sf_noCRPR_simple, unit = "mi") +
  tm_fill(col = "NewPov", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nLow Income\nPersons",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) +
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_CRPRRoutesAll_sf_simple) +
  # tm_lines(lwd = 1, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black",
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5,
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=1, labels = "Bus Route", col = "darkblue") +
  tm_layout(title = "Low Income\nPersons 10+ Miles\nfrom Nearest\nCommuter Rail Stop\nor Park-in-Ride Lot",
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_CRPRINCaccess.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_CRPRINCaccess.png")
```

```{r tabCRPRAccessINC, fig.align = "center", fig.cap="Low income persons in Census Block Groups ten or more miles from the nearest commuter rail stop or park-in-ride lot."}
ma_blkgrps_sf_noCRPR %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Low Income` = sum(NewPov,na.rm = TRUE),
            `Pct of Low Income` = round(sum(NewPov)/max(TotalLowInc)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Low Income` > 0) %>% 
  mutate(`Pct of Low Income` = if_else(`Pct of Low Income` > 100,100,`Pct of Low Income`)) %>% 
  mutate(`Pct of Low Income` = paste0(`Pct of Low Income`,"%")) %>% 
  arrange(desc(`Low Income`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Low Income Persons Ten or More Miles from Nearest Transit Stop", align = "r", col.names = c(names(.)[1:2],"Number of Low Income in Block Groups","Pct of Low Income in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapCRPRAccessNOHS, fig.align = "center", fig.cap="Adults without a high school diploma who are ten or more miles from the nearest commuter rail stop or park-in-ride lot by Census Block Group."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_blkgrps_sf_noCRPR_simple, unit = "mi") +
  tm_fill(col = "NewLths", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nAdults without a\nHigh School Diploma",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_CRPRRoutesAll_sf_simple) +
  # tm_lines(lwd = 1, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Transit Route") +
  tm_layout(title = "Adults without a\nHigh School Diploma\n10+ Miles from\nNearest Commuter\nRail Stop or\nPark-in-Ride-Lot", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_CRPRNOHSaccess.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_CRPRNOHSaccess.png")
```

```{r tabCRPRAccessNOHS, fig.align = "center", fig.cap="Adults without a high school diploma in Census Block Groups ten or more miles from the nearest commuter rail stop or park-in-ride lot."}
ma_blkgrps_sf_noCRPR %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `No HS Dip` = sum(NewLths,na.rm = TRUE),
            `Pct of No HS Dip` = round(sum(NewLths)/max(TotalNoHS)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  mutate(`Pct of No HS Dip` = if_else(`Pct of No HS Dip` > 100, 100, `Pct of No HS Dip`)) %>% 
  filter(`Pct of No HS Dip` > 0) %>% 
  mutate(`Pct of No HS Dip` = paste0(`Pct of No HS Dip`,"%")) %>% 
  arrange(desc(`No HS Dip`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Adults without a High School Diploma Ten or More Miles from Nearest Commuter Rail Stop or Park-in-Ride Lot", align = "r", col.names = c(names(.)[1:2],"Number of No HS Dip in Block Groups","Pct of No HS Dip in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapCRPRAccessMIN, fig.align = "center", fig.cap="Minority persons who are ten or more miles from the nearest commuter rail stop or park-in-ride lot by Census Block Group."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_blkgrps_sf_noCRPR_simple, unit = "mi") +
  tm_fill(col = "NewMinority", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nMinority Persons",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_CRPRRoutesAll_sf_simple) +
  # tm_lines(lwd = 1, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Transit Route") +
  tm_layout(title = "Minority Persons\n10+ Miles from\nNearest Commuter\nRail Stop\nor Park-in-Ride Lot", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_CRPRMINaccess.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_CRPRMINaccess.png")
```

```{r tabCRPRAccessMIN, fig.align = "center", fig.cap="Minority persons in Census Block Groups ten or more miles from the nearest commuter rail stop or park-in-ride lot."}
ma_blkgrps_sf_noCRPR %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            Minority = sum(NewOver64,na.rm = TRUE),
            `Pct of Minority` = round(sum(NewMinority)/max(TotalMin)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  mutate(`Pct of Minority` = if_else(`Pct of Minority` > 100, 100, `Pct of Minority`)) %>% 
  filter(`Pct of Minority` > 0) %>% 
  mutate(`Pct of Minority` = paste0(`Pct of Minority`,"%")) %>% 
  arrange(desc(Minority)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Minority Persons Ten or More Miles from Nearest Commuter Rail Stop or Park-in-Ride Lot", align = "r", col.names = c(names(.)[1:2],"Number of Minorities in Block Groups","Pct of Minorities in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapCRPRAccessNoCar, fig.align = "center", fig.cap="Households without a car that are ten or more miles from the nearest commuter rail stop or park-in-ride lot by Census Tract."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_tracts_sf_noCRPR_simple, unit = "mi") +
  tm_fill(col = "NewHHNoCar", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nNo Car Households",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_tracts_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_CRPRRoutesAll_sf_simple) +
  # tm_lines(lwd = 1, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Transit Route") +
  tm_layout(title = "Households\nwithout a Car\n10+ Miles from\nNearest Commuter\nRail Stop\nor Park-in-Ride Lot", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_CRPRNoCaraccess.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_CRPRNoCaraccess.png")
```

```{r tabCRPRAccessNoCar, fig.align = "center", fig.cap="Households without a car in Census Tracts ten or more miles from the nearest commuter rail stop or park-in-ride lot."}
ma_tracts_sf_noCRPR %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Tracts` = n(),
            `No Car HH` = sum(NewHHNoCar,na.rm = TRUE),
            `Pct of No Car HH` = round(sum(NewHHNoCar)/max(TotalNoCar)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of No Car HH` > 0) %>% 
  mutate(`Pct of No Car HH` = if_else(`Pct of No Car HH` > 100, 100, `Pct of No Car HH`)) %>% 
  mutate(`Pct of No Car HH` = paste0(`Pct of No Car HH`,"%")) %>% 
  arrange(desc(`No Car HH`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Households without a Car Ten or More Miles from Nearest Commuter Rail Stop or Park-in-Ride Lot", align = "r", col.names = c(names(.)[1:2],"Number of No Car Households in Census Tracts","Pct of No Car Households in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped"))
```

```{r mapCRPRAccessMAMIN, fig.align = "center", fig.cap="Minority persons, as defined by state environmental justice policy, who are ten or more miles from the nearest commuter rail stop or park-in-ride lot by Census Block Group."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_blkgrps_sf_noCRPR_simple, unit = "mi") +
  tm_fill(col = "NewMA_MINORITY", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nMA Minority Persons",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_CRPRRoutesAll_sf_simple) +
  # tm_lines(lwd = 1, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Transit Route") +
  tm_layout(title = "MA Minority Persons\n10+ Miles from\nNearest Commuter\nRail Stop\nor Park-in-Ride Lot", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_CRPRMAMINaccess.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_CRPRMAMINaccess.png")
```

```{r tabCRPRAccessMAMIN, fig.align = "center", fig.cap="MA Minority persons in Census Block Groups ten or more miles from the nearest commuter rail stop or park-in-ride lot."}
ma_blkgrps_sf_noCRPR %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `MA Minority` = sum(NewMA_MINORITY,na.rm = TRUE),
            `Pct of MA Minority` = round(sum(NewMA_MINORITY)/max(TotalMA_MINORITY)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of MA Minority` > 0) %>% 
  mutate(`Pct of MA Minority` = if_else(`Pct of MA Minority` > 100, 100, `Pct of MA Minority`)) %>% 
  mutate(`Pct of MA Minority` = paste0(`Pct of MA Minority`,"%")) %>% 
  arrange(desc(`MA Minority`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "MA Minority Persons Ten or More Miles from Nearest Commuter Rail Stop or Park-in-Ride Lot", align = "r", col.names = c(names(.)[1:2],"Number of Minorities in Block Groups","Pct of Minorities in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapCRPRAccessLEH, fig.align = "center", fig.cap="Limited English speaking households that are ten or more miles from the nearest commuter rail stop or park-in-ride lot by Census Block Group."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_blkgrps_sf_noCRPR_simple, unit = "mi") +
  tm_fill(col = "NewEng_limit", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nLimited English Households",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_CRPRRoutesAll_sf_simple) +
  # tm_lines(lwd = 1, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Transit Route") +
  tm_layout(title = "Limited English\nSpeaking\nHouseholds\n10+ Miles from\nNearest Commuter\nRail Stop\nor Park-in-Ride Lot", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_CRPRLEHaccess.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_CRPRLEHaccess.png")
```

```{r tabCRPRAccessLEH, fig.align = "center", fig.cap="Limited English speaking households in Census Block Groups ten or more miles from the nearest commuter rail stop or park-in-ride lot."}
ma_blkgrps_sf_noCRPR %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Limited English HH` = sum(NewEng_limit,na.rm = TRUE),
            `Pct of Limited English HH` = round(sum(NewEng_limit)/max(TotalLEH)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  mutate(`Pct of Limited English HH` = if_else(`Pct of Limited English HH` > 100, 100, `Pct of Limited English HH`)) %>% 
  filter(`Pct of Limited English HH` > 0) %>% 
  mutate(`Pct of Limited English HH` = paste0(`Pct of Limited English HH`,"%")) %>% 
  arrange(desc(`Limited English HH`)) %>% 
  filter(`Limited English HH` > 0) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Limited English Speaking Households Ten or More Miles from Nearest Commuter Rail Stop or Park-in-Ride Lot", align = "r", col.names = c(names(.)[1:2],"Number of Limited English Households in Block Groups","Pct of Limited English Households in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapCRPRAccessMALEH, fig.align = "center", fig.cap="Limited English speaking households, as defined by state environmental justice policy, that are ten or more miles from the nearest commuter rail stop or park-in-ride lot by Census Block Group."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_blkgrps_sf_noCRPR_simple, unit = "mi") +
  tm_fill(col = "NewMA_ENGLISH", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nMA Limited English\nHouseholds",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_CRPRRoutesAll_sf_simple) +
  # tm_lines(lwd = 1, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Transit Route") +
  tm_layout(title = "MA Limited English\nSpeaking\nHouseholds\n10+ Miles from\nNearest Commuter\nRail Stop\nor Park-in-Ride Lot", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_CRPRMALEHaccess.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_CRPRMALEHaccess.png")
```

```{r tabCRPRAccessMALEH, fig.align = "center", fig.cap="Limited English speaking households, as defined by state environmental justice policy, in Census Block Groups ten or more miles from the nearest commuter rail stop or park-in-ride lot."}
ma_blkgrps_sf_noCRPR %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `MA Limited English HH` = sum(NewMA_ENGLISH,na.rm = TRUE),
            `Pct of MA Limited English HH` = round(sum(NewMA_ENGLISH)/max(TotalMA_ENGLISH)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  mutate(`Pct of MA Limited English HH` = if_else(`Pct of MA Limited English HH` > 100, 100, `Pct of MA Limited English HH`)) %>% 
  filter(`Pct of MA Limited English HH` > 0) %>% 
  mutate(`Pct of MA Limited English HH` = paste0(`Pct of MA Limited English HH`,"%")) %>% 
  arrange(desc(`MA Limited English HH`)) %>% 
  filter(`MA Limited English HH` > 0) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "MA Limited English Speaking Households Ten or More Miles from Nearest Commuter Rail Stop or Park-in-Ride Lot", align = "r", col.names = c(names(.)[1:2],"Number of MA Limited English Households in Block Groups","Pct of MA Limited English Households in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```


### No Transit Access and Populations of Concern {-}

```{r mapTransitAccessU18, fig.align = "center", fig.cap="Persons under 18 without reasonable access to any form of transit by Census Block Group."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") +
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_blkgrps_sf_noTransit_simple, unit = "mi") +
  tm_fill(col = "NewUnder18", style = "equal", colorNA = "white", 
          colorNULL = "gray", title = "Number of\nPersons Under 18",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) +
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_transitRoutesAll_sf_simple) +
  # tm_lines(lwd = 2, alpha = 0.3, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black",
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5,
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Bus Route",
  #               col = "darkblue") +
  tm_layout(title = "Persons Under 18\nwithout Reasonable\nAccess to any\nMode of Transit",
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_transitU18access.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_transitU18access.png")
```

```{r tabTransitAccessU18, fig.align = "center", fig.cap="Persons under 18 in Census Block Groups without reasonable access to any form of transit."}
ma_blkgrps_sf_noTransit %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Under 18` = sum(NewUnder18,na.rm = TRUE),
            `Pct of Under 18` = round(sum(NewUnder18)/max(TotalUnder18)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Under 18` > 0) %>% 
  mutate(`Pct of Under 18` = if_else(`Pct of Under 18` > 100, 100, `Pct of Under 18`)) %>% 
  mutate(`Pct of Under 18` = paste0(`Pct of Under 18`,"%")) %>% 
  arrange(desc(`Under 18`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Persons Under 18 without Reasonable Access to any Mode of Transit", align = "r", col.names = c(names(.)[1:2],"Number of Under 18 in Block Groups","Pct of Under 18 in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapTransitAccessDisabled, fig.align = "center", fig.cap="Disabled persons without reasonable access to any form of transit by Census Tract."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") +
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_tracts_sf_noTransit_simple, unit = "mi") +
  tm_fill(col = "NewDisabled", style = "quantile",
          colorNA = "white", colorNULL = "gray", title = "Number of\nDisabled Persons",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_tracts_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) +
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_transitRoutesAll_sf_simple) +
  # tm_lines(lwd = 2, alpha = 0.3, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black",
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 5, 10), text.size = 0.5,
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Bus Route", col = "darkblue") +
  tm_layout(title = "Disabled Persons\nwithout Reasonable\nAccess to any\nMode of Transit",
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_transitDisabledaccess.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_transitDisabledaccess.png")
```

```{r tabTransitAccessDisabled, fig.align = "center", fig.cap="Disabled Persons in Census Block Groups without reasonable access to any form of transit."}
ma_tracts_sf_noTransit %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Tracts` = n(),
            Disabled = sum(NewDisabled,na.rm = TRUE),
            `Pct of Disabled` = round(sum(NewDisabled)/max(TotalDisabled)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Disabled` > 0) %>% 
  mutate(`Pct of Disabled` = if_else(`Pct of Disabled` > 100, 100, `Pct of Disabled`)) %>% 
  mutate(`Pct of Disabled` = paste0(`Pct of Disabled`,"%")) %>% 
  arrange(desc(Disabled)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Disabled Persons without Reasonable Access to any Mode of Transit", align = "r", col.names = c(names(.)[1:2],"Number of Disabled in Census Tracts","Pct of Disabled in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapTransitAccessU5, fig.align = "center", fig.cap="Children under 5 who are one or more miles from the nearest transit stop by Census Block Group."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") +
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_blkgrps_sf_noTransit_simple, unit = "mi") +
  tm_fill(col = "NewUnder5", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nChildren Under 5",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) +
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_transitRoutesAll_sf_simple) +
  # tm_lines(lwd = 2, alpha = 0.3, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black",
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5,
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Bus Route", col = "darkblue") +
  tm_layout(title = "Children Under 5\nwithout Reasonable\nAccess to any\nMode of Transit",
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_transitU5access.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_transitU5access.png")
```

```{r tabTransitAccessU5, fig.align = "center", fig.cap="Children under 5 in Census Block Groups without reasonable access to any form of transit."}
ma_blkgrps_sf_noTransit %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Under 5` = sum(NewUnder5,na.rm = TRUE),
            `Pct of Under 5` = round(sum(NewUnder5)/max(TotalUnder5)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Under 5` > 0) %>% 
  mutate(`Pct of Under 5` = if_else(`Pct of Under 5` > 100, 100, `Pct of Under 5`)) %>% 
  mutate(`Pct of Under 5` = paste0(`Pct of Under 5`,"%")) %>% 
  arrange(desc(`Under 5`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Children Under 5 without Reasonable Access to any Mode of Transit", align = "r", col.names = c(names(.)[1:2],"Number of Under 5 in Block Groups","Pct of Under 5 in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapTransitAccessMAINC, fig.align = "center", fig.cap="Low income persons, as defined by state environmental justice policy, who are one or more miles from the nearest transit stop by Census Block Group."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") +
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_blkgrps_sf_noTransit_simple, unit = "mi") +
  tm_fill(col = "NewMA_LOWINC", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nMA Low Income\nPersons",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) +
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_transitRoutesAll_sf_simple) +
  # tm_lines(lwd = 2, alpha = 0.3, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black",
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5,
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Bus Route", col = "darkblue") +
  tm_layout(title = "MA Low Income\nPersons 1+ Miles\nfrom Nearest\nBus Stop",
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_transitMAINCaccess.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_transitMAINCaccess.png")
```

```{r tabTransitAccessMAINC, fig.align = "center", fig.cap="Low income persons, as defined by state environmental justice policy, in Census Block Groups without reasonable access to any form of transit."}
ma_blkgrps_sf_noTransit %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `MA Low Income` = sum(NewMA_LOWINC,na.rm = TRUE),
            `Pct of MA Low Income` = round(sum(NewMA_LOWINC)/max(TotalMA_LOWINC)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of MA Low Income` > 0) %>% 
  mutate(`Pct of MA Low Income` = if_else(`Pct of MA Low Income` > 100,100,`Pct of MA Low Income`)) %>% 
  mutate(`Pct of MA Low Income` = paste0(`Pct of MA Low Income`,"%")) %>% 
  arrange(desc(`MA Low Income`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Low Income Persons One or More Miles from Nearest Transit Stop", align = "r", col.names = c(names(.)[1:2],"Number of MA Low Income in Block Groups","Pct of MA Low Income in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapTransitAccessINC, fig.align = "center", fig.cap="Low income persons who are one or more miles from the nearest transit stop by Census Block Group."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") +
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_blkgrps_sf_noTransit_simple, unit = "mi") +
  tm_fill(col = "NewPov", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nLow Income\nPersons",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) +
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_transitRoutesAll_sf_simple) +
  # tm_lines(lwd = 1, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black",
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5,
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=1, labels = "Bus Route", col = "darkblue") +
  tm_layout(title = "Low Income\nPersons 1+ Miles\nfrom Nearest\nBus Stop",
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_transitINCaccess.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_transitINCaccess.png")
```

```{r tabTransitAccessINC, fig.align = "center", fig.cap="Low income persons in Census Block Groups without reasonable access to any form of transit."}
ma_blkgrps_sf_noTransit %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Low Income` = sum(NewPov,na.rm = TRUE),
            `Pct of Low Income` = round(sum(NewPov)/max(TotalLowInc)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Low Income` > 0) %>% 
  mutate(`Pct of Low Income` = if_else(`Pct of Low Income` > 100,100,`Pct of Low Income`)) %>% 
  mutate(`Pct of Low Income` = paste0(`Pct of Low Income`,"%")) %>% 
  arrange(desc(`Low Income`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Low Income Persons without Reasonable Access to any Mode of Transit", align = "r", col.names = c(names(.)[1:2],"Number of Low Income in Block Groups","Pct of Low Income in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapTransitAccessNOHS, fig.align = "center", fig.cap="Adults without a high school diploma without reasonable access to any form of transit by Census Block Group."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_blkgrps_sf_noTransit_simple, unit = "mi") +
  tm_fill(col = "NewLths", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nAdults without a\nHigh School Diploma",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_transitRoutesAll_sf_simple) +
  # tm_lines(lwd = 1, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Transit Route") +
  tm_layout(title = "Adults without a\nHigh School Diploma\n1+ Miles from\nNearest Transit\nStop", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_transitNOHSaccess.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_transitNOHSaccess.png")
```

```{r tabTransitAccessNOHS, fig.align = "center", fig.cap="Adults without a high school diploma in Census Block Groups without reasonable access to any form of transit."}
ma_blkgrps_sf_noTransit %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `No HS Dip` = sum(NewLths,na.rm = TRUE),
            `Pct of No HS Dip` = round(sum(NewLths)/max(TotalNoHS)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of No HS Dip` > 0) %>% 
  mutate(`Pct of No HS Dip` = if_else(`Pct of No HS Dip` > 100, 100, `Pct of No HS Dip`)) %>% 
  mutate(`Pct of No HS Dip` = paste0(`Pct of No HS Dip`,"%")) %>% 
  arrange(desc(`No HS Dip`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Adults without a High School Diploma without Reasonable Access to any Mode of Transit", align = "r", col.names = c(names(.)[1:2],"Number of No HS Dip in Block Groups","Pct of No HS Dip in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapTransitAccessMIN, fig.align = "center", fig.cap="Minority persons without reasonable access to any form of transit by Census Block Group."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_blkgrps_sf_noTransit_simple, unit = "mi") +
  tm_fill(col = "NewMinority", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nMinority Persons",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_transitRoutesAll_sf_simple) +
  # tm_lines(lwd = 1, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Transit Route") +
  tm_layout(title = "Minority Persons\nwithout Reasonable\nAccess to any\nMode of Transit", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_transitMINaccess.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_transitMINaccess.png")
```

```{r tabTransitAccessMIN, fig.align = "center", fig.cap="Minority persons in Census Block Groups without reasonable access to any form of transit."}
ma_blkgrps_sf_noTransit %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            Minority = sum(NewOver64,na.rm = TRUE),
            `Pct of Minority` = round(sum(NewMinority)/max(TotalMin)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Minority` > 0) %>% 
  mutate(`Pct of Minority` = if_else(`Pct of Minority` > 100, 100, `Pct of Minority`)) %>% 
  mutate(`Pct of Minority` = paste0(`Pct of Minority`,"%")) %>% 
  arrange(desc(Minority)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Minority Persons without Reasonable Access to any Mode of Transit", align = "r", col.names = c(names(.)[1:2],"Number of Minorities in Block Groups","Pct of Minorities in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapTransitAccessNoCar, fig.align = "center", fig.cap="Households without a car that are without reasonable access to any form of transit by Census Tract."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_tracts_sf_noTransit_simple, unit = "mi") +
  tm_fill(col = "NewHHNoCar", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nNo Car Households",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_tracts_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_transitRoutesAll_sf_simple) +
  # tm_lines(lwd = 1, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Transit Route") +
  tm_layout(title = "Households\nwithout a Car\nwithout Reasonable\nAccess to any\nMode of Transit", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_transitNoCaraccess.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_transitNoCaraccess.png")
```

```{r tabTransitAccessNoCar, fig.align = "center", fig.cap="Households without a car in Census Tracts without reasonable access to any form of transit."}
ma_tracts_sf_noTransit %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Tracts` = n(),
            `No Car HH` = sum(NewHHNoCar,na.rm = TRUE),
            `Pct of No Car HH` = round(sum(NewHHNoCar)/max(TotalNoCar)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of No Car HH` > 0) %>% 
  mutate(`Pct of No Car HH` = if_else(`Pct of No Car HH` > 100, 100, `Pct of No Car HH`)) %>% 
  mutate(`Pct of No Car HH` = paste0(`Pct of No Car HH`,"%")) %>% 
  arrange(desc(`No Car HH`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Households without a Car without Reasonable Access to any Mode of Transit", align = "r", col.names = c(names(.)[1:2],"Number of No Car Households in Census Tracts","Pct of No Car Households in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped"))
```

```{r mapTransitAccessMAMIN, fig.align = "center", fig.cap="Minority persons, as defined by state environmental justice policy, without reasonable access to any form of transit by Census Block Group.", include=FALSE, eval=FALSE}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_blkgrps_sf_noTransit_simple, unit = "mi") +
  tm_fill(col = "NewMA_MINORITY", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nMA Minority Persons",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_transitRoutesAll_sf_simple) +
  # tm_lines(lwd = 1, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Transit Route") +
  tm_layout(title = "MA Minority Persons\nwithout Reasonable\nAccess to any\nMode of Transit", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_transitMAMINaccess.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_transitMAMINaccess.png")
```

```{r tabTransitAccessMAMIN, fig.align = "center", fig.cap="MA Minority persons in Census Block Groups without reasonable access to any form of transit.", include=FALSE, eval=FALSE}
ma_blkgrps_sf_noTransit %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `MA Minority` = sum(NewMA_MINORITY,na.rm = TRUE),
            `Pct of MA Minority` = round(sum(NewMA_MINORITY)/max(TotalMA_MINORITY)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of MA Minority` > 0) %>% 
  mutate(`Pct of MA Minority` = if_else(`Pct of MA Minority` > 100, 100, `Pct of MA Minority`)) %>% 
  mutate(`Pct of MA Minority` = paste0(`Pct of MA Minority`,"%")) %>% 
  arrange(desc(`MA Minority`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "MA Minority Persons without Reasonable Access to any Mode of Transit", align = "r", col.names = c(names(.)[1:2],"Number of Minorities in Block Groups","Pct of Minorities in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapTransitAccessLEH, fig.align = "center", fig.cap="Limited English speaking households that are without reasonable access to any form of transit by Census Block Group."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_blkgrps_sf_noTransit_simple, unit = "mi") +
  tm_fill(col = "NewEng_limit", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nLimited English Households",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_transitRoutesAll_sf_simple) +
  # tm_lines(lwd = 1, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Transit Route") +
  tm_layout(title = "Limited English\nSpeaking\nHouseholds\nwithout Reasonable\nAccess to any\nMode of Transit", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_transitLEHaccess.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_transitLEHaccess.png")
```

```{r tabTransitAccessLEH, fig.align = "center", fig.cap="Limited English speaking households in Census Block Groups without reasonable access to any form of transit."}
ma_blkgrps_sf_noTransit %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Limited English HH` = sum(NewEng_limit,na.rm = TRUE),
            `Pct of Limited English HH` = round(sum(NewEng_limit)/max(TotalLEH)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  mutate(`Pct of Limited English HH` = if_else(`Pct of Limited English HH` > 100, 100, `Pct of Limited English HH`)) %>% 
  filter(`Pct of Limited English HH` > 0) %>% 
  mutate(`Pct of Limited English HH` = paste0(`Pct of Limited English HH`,"%")) %>% 
  arrange(desc(`Limited English HH`)) %>% 
  filter(`Limited English HH` > 0) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Limited English Speaking Households without Reasonable Access to any Mode of Transit", align = "r", col.names = c(names(.)[1:2],"Number of Limited English Households in Block Groups","Pct of Limited English Households in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapTransitAccessMALEH, fig.align = "center", fig.cap="Limited English speaking households, as defined by state environmental justice policy, that are without reasonable access to any form of transit by Census Block Group.", include=FALSE, eval=FALSE}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(ma_blkgrps_sf_noTransit_simple, unit = "mi") +
  tm_fill(col = "NewMA_ENGLISH", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nMA Limited English\nHouseholds",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_transitRoutesAll_sf_simple) +
  # tm_lines(lwd = 1, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Transit Route") +
  tm_layout(title = "MA Limited English\nSpeaking\nHouseholds\nwithout Reasonable\nAccess to any\nMode of Transit", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_transitMALEHaccess.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_transitMALEHaccess.png")
```

```{r tabTransitAccessMALEH, fig.align = "center", fig.cap="Limited English speaking households, as defined by state environmental justice policy, in Census Block Groups without reasonable access to any form of transit.", include=FALSE, eval=FALSE}
ma_blkgrps_sf_noTransit %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `MA Limited English HH` = sum(NewMA_ENGLISH,na.rm = TRUE),
            `Pct of MA Limited English HH` = round(sum(NewMA_ENGLISH)/max(TotalMA_ENGLISH)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  mutate(`Pct of MA Limited English HH` = if_else(`Pct of MA Limited English HH` > 100, 100, `Pct of MA Limited English HH`)) %>% 
  filter(`Pct of MA Limited English HH` > 0) %>% 
  mutate(`Pct of MA Limited English HH` = paste0(`Pct of MA Limited English HH`,"%")) %>% 
  arrange(desc(`MA Limited English HH`)) %>% 
  filter(`MA Limited English HH` > 0) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "MA Limited English Speaking Households without Reasonable Access to any Mode of Transit", align = "r", col.names = c(names(.)[1:2],"Number of MA Limited English Households in Block Groups","Pct of MA Limited English Households in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```
No groups meeting environmental justice criteria for minority or limited English speaking households were found in areas without reasonable access to some form of transit. 


## Excessive Headways and Populations of Concern {-}

### Excessive Bus Headways and Populations of Concern {-}

```{r mapHeadwayBusDisabled, fig.align = "center", fig.cap="Disabled Persons within 400m or 1/4 mile of bus stops in which the mean headway for these stops is above the 80th percentile for the state."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") +
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(headway80thtracts_bus, unit = "mi") +
  tm_fill(col = "NewDisabled", style = "equal", colorNA = "white", 
          colorNULL = "gray", title = "Number of\nDisabled Persons",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) +
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_rapid busRoutesAll_sf_simple) +
  # tm_lines(lwd = 2, alpha = 0.3, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black",
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5,
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Bus Route",
  #               col = "darkblue") +
  tm_layout(title = paste("Disabled Persons","with Bus Headways",paste0("Over ",quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"),
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_headwayDisabledBus.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_headwayDisabledBus.png")
```

```{r tabHeadwayDisabledbus, fig.align = "center", fig.cap="Disabled Persons in Census Tracts one or more miles from the nearest bus stop."}
headway80thtracts_bus %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Tracts` = n(),
            Disabled = sum(NewDisabled,na.rm = TRUE),
            `Pct of Disabled` = round(sum(NewDisabled)/max(TotalDisabled)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Disabled` > 0) %>% 
  mutate(`Pct of Disabled` = paste0(`Pct of Disabled`,"%")) %>% 
  arrange(desc(Disabled)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = paste("Disabled Persons","with Average Headways",paste0("Over ",quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"), align = "r", col.names = c(names(.)[1:2],"Number of Disabled in Census Tracts","Pct of Disabled in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapHeadwayBusU5, fig.align = "center", fig.cap="Children under 5 within 400m or 1/4 mile of bus stops in which the mean headway for these stops is above the 80th percentile for the state."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") +
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(headway80thblkgrps_bus, unit = "mi") +
  tm_fill(col = "NewUnder5", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nChildren Under 5",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) +
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_RTRoutesAll_sf_simple) +
  # tm_lines(lwd = 2, alpha = 0.3, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black",
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5,
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Bus Route", col = "darkblue") +
  tm_layout(title = paste("Children Under 5","with Bus Headways",paste0("Over ",quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"),
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_headwayUnder5bus.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_headwayUnder5bus.png")
```

```{r tabHeadwayU5, fig.align = "center", fig.cap="Children under 5 within 400m or 1/4 mile of transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
headway80thblkgrps_bus %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Under 5` = sum(NewUnder5,na.rm = TRUE),
            `Pct of Under 5` = round(sum(NewUnder5)/max(TotalUnder5)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Under 5` > 0) %>% 
  mutate(`Pct of Under 5` = if_else(`Pct of Under 5` > 100, 100, `Pct of Under 5`)) %>% 
  mutate(`Pct of Under 5` = paste0(`Pct of Under 5`,"%")) %>% 
  arrange(desc(`Under 5`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = paste("Children Under 5","with Average Headways",paste0("Over ",quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"), align = "r", col.names = c(names(.)[1:2],"Number of Under 5 in Block Groups","Pct of Under 5 in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapHeadwayBusU18, fig.align = "center", fig.cap="Persons under 18 within 400m or 1/4 mile of bus stops in which the mean headway for these stops is above the 80th percentile for the state."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") +
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(headway80thblkgrps_bus, unit = "mi") +
  tm_fill(col = "NewUnder18", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nPersons Under 18",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) +
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_RTRoutesAll_sf_simple) +
  # tm_lines(lwd = 2, alpha = 0.3, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black",
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5,
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Bus Route", col = "darkblue") +
  tm_layout(title = paste("Persons Under 18","with Bus Headways",paste0("Over ",quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"),
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_headwayUnder18bus.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_headwayUnder18bus.png")
```

```{r tabHeadwayU18, fig.align = "center", fig.cap="Persons under 18 within 400m or 1/4 mile of transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
headway80thblkgrps_bus %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Under 18` = sum(NewUnder18,na.rm = TRUE),
            `Pct of Under 18` = round(sum(NewUnder18)/max(TotalUnder18)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Under 18` > 0) %>% 
  mutate(`Pct of Under 18` = if_else(`Pct of Under 18` > 100, 100, `Pct of Under 18`)) %>% 
  mutate(`Pct of Under 18` = paste0(`Pct of Under 18`,"%")) %>% 
  arrange(desc(`Under 18`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = paste("Persons Under 18","with Average Headways",paste0("Over ",quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"), align = "r", col.names = c(names(.)[1:2],"Number of Under 18 in Block Groups","Pct of Under 18 in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapHeadwayBusMAINC, fig.align = "center", fig.cap="Low income persons, as defined by state environmental justice policy, within 400m or 1/4 mile of transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") +
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(headway80thblkgrps_bus, unit = "mi") +
  tm_fill(col = "NewMA_LOWINC", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nMA Low Income\nPersons",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) +
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_RTRoutesAll_sf_simple) +
  # tm_lines(lwd = 2, alpha = 0.3, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black",
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5,
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Bus Route", col = "darkblue") +
  tm_layout(title = paste("MA Low Income","Persons with Bus", "Headways Over", paste0(quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"),
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_headwayMAINCbus.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_headwayMAINCbus.png")
```

```{r tabHeadwayMAINC, fig.align = "center", fig.cap="Low income persons, as defined by state environmental justice policy, within 400m or 1/4 mile of transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
headway80thblkgrps_bus %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `MA Low Income` = sum(NewMA_LOWINC,na.rm = TRUE),
            `Pct of MA Low Income` = round(sum(NewMA_LOWINC)/max(TotalMA_LOWINC)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of MA Low Income` > 0) %>% 
  mutate(`Pct of MA Low Income` = if_else(`Pct of MA Low Income` > 100,100,`Pct of MA Low Income`)) %>% 
  mutate(`Pct of MA Low Income` = paste0(`Pct of MA Low Income`,"%")) %>% 
  arrange(desc(`MA Low Income`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = paste("MA Low Income Persons","with Average Headways",paste0("Over ",quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"), align = "r", col.names = c(names(.)[1:2],"Number of MA Low Income in Block Groups","Pct of MA Low Income in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapHeadwayBusINC, fig.align = "center", fig.cap="Low income persons within 400m or 1/4 mile of transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") +
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(headway80thblkgrps_bus, unit = "mi") +
  tm_fill(col = "NewPov", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nLow Income\nPersons",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) +
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_RTRoutesAll_sf_simple) +
  # tm_lines(lwd = 1, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black",
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5,
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=1, labels = "Bus Route", col = "darkblue") +
  tm_layout(title = paste("Low Income Persons","with Bus Headways",paste0("Over ",quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"),
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_headwayINCbus.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_headwayINCbus.png")
```

```{r tabHeadwayINC, fig.align = "center", fig.cap="Low income persons within 400m or 1/4 mile of transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
headway80thblkgrps_bus %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Low Income` = sum(NewPov,na.rm = TRUE),
            `Pct of Low Income` = round(sum(NewPov)/max(TotalLowInc)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Low Income` > 0) %>% 
  mutate(`Pct of Low Income` = if_else(`Pct of Low Income` > 100,100,`Pct of Low Income`)) %>% 
  mutate(`Pct of Low Income` = paste0(`Pct of Low Income`,"%")) %>% 
  arrange(desc(`Low Income`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = paste("Low Income Persons","with Average Headways",paste0("Over ",quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"), align = "r", col.names = c(names(.)[1:2],"Number of Low Income in Block Groups","Pct of Low Income in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapHeadwayBusNOHS, fig.align = "center", fig.cap="Adults without a high school diploma within 400m or 1/4 mile of bus stops in which the mean headway for these stops is above the 80th percentile for the state."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(headway80thblkgrps_bus, unit = "mi") +
  tm_fill(col = "NewLths", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nAdults without a\nHigh School Diploma",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_RTRoutesAll_sf_simple) +
  # tm_lines(lwd = 1, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Transit Route") +
  tm_layout(title = paste("Adults without a", "High School Diploma","with Bus Headways",paste0("Over ",quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"), 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_headwayLTHSbus.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_headwayLTHSbus.png")
```

```{r tabHeadwayNOHS, fig.align = "center", fig.cap="Adults without a high school diploma within 400m or 1/4 mile of transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
headway80thblkgrps_bus %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `No HS Dip` = sum(NewLths,na.rm = TRUE),
            `Pct of No HS Dip` = round(sum(NewLths)/max(TotalNoHS)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of No HS Dip` > 0) %>% 
  mutate(`Pct of No HS Dip` = if_else(`Pct of No HS Dip` > 100, 100, `Pct of No HS Dip`)) %>% 
  mutate(`Pct of No HS Dip` = paste0(`Pct of No HS Dip`,"%")) %>% 
  arrange(desc(`No HS Dip`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = paste("Adults without a", "High School Diploma","with Bus Headways",paste0("Over ",quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"), align = "r", col.names = c(names(.)[1:2],"Number of No HS Dip in Block Groups","Pct of No HS Dip in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapHeadwayBusMIN, fig.align = "center", fig.cap="Minority persons within 400m or 1/4 mile of bus stops in which the mean headway for these stops is above the 80th percentile for the state."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(headway80thblkgrps_bus, unit = "mi") +
  tm_fill(col = "NewMinority", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nMinority Persons",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_RTRoutesAll_sf_simple) +
  # tm_lines(lwd = 1, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Transit Route") +
  tm_layout(title = paste("Minority Persons","with Bus Headways",paste0("Over ",quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"), 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_headwayMINbus.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_headwayMINbus.png")
```

```{r tabHeadwayMIN, fig.align = "center", fig.cap="Minority persons within 400m or 1/4 mile of transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
headway80thblkgrps_bus %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            Minority = sum(NewOver64,na.rm = TRUE),
            `Pct of Minority` = round(sum(NewMinority)/max(TotalMin)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Minority` > 0) %>% 
  mutate(`Pct of Minority` = if_else(`Pct of Minority` > 100, 100, `Pct of Minority`)) %>% 
  mutate(`Pct of Minority` = paste0(`Pct of Minority`,"%")) %>% 
  arrange(desc(Minority)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = paste("Minority Persons","with Bus Headways",paste0("Over ",quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"), align = "r", col.names = c(names(.)[1:2],"Number of Minorities in Block Groups","Pct of Minorities in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapHeadwayBusNoCar, fig.align = "center", fig.cap="Households without a car within 400m or 1/4 mile of transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(headway80thtracts_bus, unit = "mi") +
  tm_fill(col = "NewHHNoCar", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nNo Car Households",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_tracts_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_RTRoutesAll_sf_simple) +
  # tm_lines(lwd = 1, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Transit Route") +
  tm_layout(title = paste("Households", "without a Car", "with Bus Headways", paste0("Over ",quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"), 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_headwayNoCarHHbus.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_headwayNoCarHHbus.png")
```

```{r tabHeadwayNoCar, fig.align = "center", fig.cap="Households without a car within 400m or 1/4 mile of transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
headway80thtracts_bus %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Tracts` = n(),
            `No Car HH` = sum(NewHHNoCar,na.rm = TRUE),
            `Pct of No Car HH` = round(sum(NewHHNoCar)/max(TotalNoCar)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of No Car HH` > 0) %>% 
  mutate(`Pct of No Car HH` = if_else(`Pct of No Car HH` > 100, 100, `Pct of No Car HH`)) %>% 
  mutate(`Pct of No Car HH` = paste0(`Pct of No Car HH`,"%")) %>% 
  arrange(desc(`No Car HH`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = paste("Households without a Car","with Bus Headways",paste0("Over ",quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"), align = "r", col.names = c(names(.)[1:2],"Number of No Car Households in Census Tracts","Pct of No Car Households in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped"))
```

```{r mapHeadwayBusMAMIN, fig.align = "center", fig.cap="Minority persons, as defined by state environmental justice policy, within 400m or 1/4 mile of bus stops in which the mean headway for these stops is above the 80th percentile for the state."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(headway80thblkgrps_bus, unit = "mi") +
  tm_fill(col = "NewMA_MINORITY", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nMA Minority Persons",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_RTRoutesAll_sf_simple) +
  # tm_lines(lwd = 1, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Transit Route") +
  tm_layout(title = paste("MA Minority Persons","with Bus Headways", paste0("Over ",quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"), 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_headwayMAMINbus.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_headwayMAMINbus.png")
```

```{r tabHeadwayMAMIN, fig.align = "center", fig.cap="MA Minority persons within 400m or 1/4 mile of transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
headway80thblkgrps_bus %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `MA Minority` = sum(NewMA_MINORITY,na.rm = TRUE),
            `Pct of MA Minority` = round(sum(NewMA_MINORITY)/max(TotalMA_MINORITY)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of MA Minority` > 0) %>% 
  mutate(`Pct of MA Minority` = if_else(`Pct of MA Minority` > 100, 100, `Pct of MA Minority`)) %>% 
  mutate(`Pct of MA Minority` = paste0(`Pct of MA Minority`,"%")) %>% 
  arrange(desc(`MA Minority`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = paste("MA Minority Persons","with Bus Headways", paste0("Over ",quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"), align = "r", col.names = c(names(.)[1:2],"Number of Minorities in Block Groups","Pct of Minorities in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapHeadwayBusLEH, fig.align = "center", fig.cap="Limited English speaking households within 400m or 1/4 mile of transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(headway80thblkgrps_bus, unit = "mi") +
  tm_fill(col = "NewEng_limit", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nLimited English Households",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_RTRoutesAll_sf_simple) +
  # tm_lines(lwd = 1, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Transit Route") +
  tm_layout(title = paste("Limited English","Speaking","Households","with Bus Headways",paste0("Over ",quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"), 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_headwayLEHbus.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_headwayLEHbus.png")
```

```{r tabHeadwayLEH, fig.align = "center", fig.cap="Limited English speaking households within 400m or 1/4 mile of transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
headway80thblkgrps_bus %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Limited English HH` = sum(NewEng_limit,na.rm = TRUE),
            `Pct of Limited English HH` = round(sum(NewEng_limit)/max(TotalLEH)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  mutate(`Pct of Limited English HH` = if_else(`Pct of Limited English HH` > 100, 100, `Pct of Limited English HH`)) %>% 
  filter(`Pct of Limited English HH` > 0) %>% 
  mutate(`Pct of Limited English HH` = paste0(`Pct of Limited English HH`,"%")) %>% 
  arrange(desc(`Limited English HH`)) %>% 
  filter(`Limited English HH` > 0) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = paste("Limited English","Speaking","Households","with Bus Headways",paste0("Over ",quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"), align = "r", col.names = c(names(.)[1:2],"Number of Limited English Households in Block Groups","Pct of Limited English Households in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapHeadwayBusMALEH, fig.align = "center", fig.cap="Limited English speaking households, as defined by state environmental justice policy, within 400m or 1/4 mile of transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(headway80thblkgrps_bus, unit = "mi") +
  tm_fill(col = "NewMA_ENGLISH", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nMA Limited English\nHouseholds",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_RTRoutesAll_sf_simple) +
  # tm_lines(lwd = 1, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Transit Route") +
  tm_layout(title = paste("MA Limited English","Speaking","Households","with Bus Headways",paste0("Over ",quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"), 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_headwayMALEHbus.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_headwayMALEHbus.png")
```

```{r tabHeadwayMALEH, fig.align = "center", fig.cap="Limited English speaking households, as defined by state environmental justice policy, within 400m or 1/4 mile of transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
headway80thblkgrps_bus %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `MA Limited English HH` = sum(NewMA_ENGLISH,na.rm = TRUE),
            `Pct of MA Limited English HH` = round(sum(NewMA_ENGLISH)/max(TotalMA_ENGLISH)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  mutate(`Pct of MA Limited English HH` = if_else(`Pct of MA Limited English HH` > 100, 100, `Pct of MA Limited English HH`)) %>% 
  filter(`Pct of MA Limited English HH` > 0) %>% 
  mutate(`Pct of MA Limited English HH` = paste0(`Pct of MA Limited English HH`,"%")) %>% 
  arrange(desc(`MA Limited English HH`)) %>% 
  filter(`MA Limited English HH` > 0) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = paste("MA Limited English","Speaking","Households","with Bus Headways",paste0("Over ",quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"), align = "r", col.names = c(names(.)[1:2],"Number of MA Limited English Households in Block Groups","Pct of MA Limited English Households in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```


### Excessive Rapid Transit Headways and Populations of Concern {-}

```{r mapHeadwayRTDisabled, fig.align = "center", fig.cap="Disabled Persons within 800m or 1/2 mile of rapid transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
m <- tm_shape(ma_towns_sf, bbox = ma_routes_sf_RT, unit = "mi") + 
  tm_polygons(col = "gray", border.alpha = 0.8, lwd = 0.2, alpha = 0.2) +
  tm_text("NAME", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(headway80thtracts_RT, unit = "mi") +
  tm_fill(col = "NewDisabled", style = "equal", colorNA = "white", 
          colorNULL = "gray", title = "Number of\nDisabled Persons",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  # tm_shape(ma_towns_sf_pts) + tm_dots() +
  # tm_text("NAME", size = 0.5, col = "black",
  #         xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 1, 2), text.size = 0.5,
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "RT Route",
  #               col = "darkblue") +
  tm_layout(title = paste("Disabled Persons","with Rapid Transit", "Headways Over",paste0(quantile(ma_routes_sf_RT$mean_headways,0.8)," Minutes"),sep = "\n"),
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_headwayDisabledRT.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_headwayDisabledRT.png")
```

```{r tabHeadwayRTDisabled, fig.align = "center", fig.cap="Disabled Persons in Census Tracts one or more miles from the nearest bus stop."}
headway80thtracts_RT %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Tracts` = n(),
            Disabled = sum(NewDisabled,na.rm = TRUE),
            `Pct of Disabled` = round(sum(NewDisabled)/max(TotalDisabled)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Disabled` > 0) %>% 
  mutate(`Pct of Disabled` = if_else(`Pct of Disabled` > 100, 100, `Pct of Disabled`)) %>%
  mutate(`Pct of Disabled` = paste0(`Pct of Disabled`,"%")) %>% 
  arrange(desc(Disabled)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = paste("Disabled Persons","with Average Headways",paste0("Over ",quantile(ma_routes_sf_RT$mean_headways,0.8)," Minutes"),sep = "\n"), align = "r", col.names = c(names(.)[1:2],"Number of Disabled in Census Tracts","Pct of Disabled in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapHeadwayRTU5, fig.align = "center", fig.cap="Children under 5 within 800m or 1/2 mile of rapid transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
m <- tm_shape(ma_towns_sf, bbox = ma_routes_sf_RT, unit = "mi") + 
  tm_polygons(col = "gray", border.alpha = 0.8, lwd = 0.2, alpha = 0.2) +
  tm_text("NAME", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(headway80thblkgrps_RT, unit = "mi") +
  tm_fill(col = "NewUnder5", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nChildren Under 5",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  # tm_shape(ma_towns_sf_pts) + tm_dots() +
  # tm_text("NAME", size = 0.5, col = "black",
  #         xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 1, 2), text.size = 0.5,
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "RT Route", col = "darkblue") +
  tm_layout(title = paste("Children Under 5","with Rapid Transit Headways",paste0("Over ",quantile(ma_routes_sf_RT$mean_headways,0.8)," Minutes"),sep = "\n"),
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_headwayUnder5RT.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_headwayUnder5RT.png")
```

```{r tabHeadwayRTU5, fig.align = "center", fig.cap="Children under 5 within 800m or 1/2 mile of rapid transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
headway80thblkgrps_RT %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Under 5` = sum(NewUnder5,na.rm = TRUE),
            `Pct of Under 5` = round(sum(NewUnder5)/max(TotalUnder5)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Under 5` > 0) %>% 
  mutate(`Pct of Under 5` = if_else(`Pct of Under 5` > 100, 100, `Pct of Under 5`)) %>% 
  mutate(`Pct of Under 5` = paste0(`Pct of Under 5`,"%")) %>% 
  arrange(desc(`Under 5`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = paste("Children Under 5","with Average Headways",paste0("Over ",quantile(ma_routes_sf_RT$mean_headways,0.8)," Minutes"),sep = "\n"), align = "r", col.names = c(names(.)[1:2],"Number of Under 5 in Block Groups","Pct of Under 5 in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapHeadwayRTU18, fig.align = "center", fig.cap="Persons under 18 within 800m or 1/2 mile of rapid transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
m <- tm_shape(ma_towns_sf, bbox = ma_routes_sf_RT, unit = "mi") + 
  tm_polygons(col = "gray", border.alpha = 0.8, lwd = 0.2, alpha = 0.2) +
  tm_text("NAME", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(headway80thblkgrps_RT, unit = "mi") +
  tm_fill(col = "NewUnder18", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nPersons Under 18",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  # tm_shape(ma_towns_sf_pts) + tm_dots() +
  # tm_text("NAME", size = 0.5, col = "black",
  #         xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 1, 2), text.size = 0.5,
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "RT Route", col = "darkblue") +
  tm_layout(title = paste("Persons Under 18","with Rapid Transit Headways",paste0("Over ",quantile(ma_routes_sf_RT$mean_headways,0.8)," Minutes"),sep = "\n"),
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_headwayUnder18RT.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_headwayUnder18RT.png")
```

```{r tabHeadwayRTU18, fig.align = "center", fig.cap="Persons under 18 within 800m or 1/2 mile of rapid transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
headway80thblkgrps_RT %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Under 18` = sum(NewUnder18,na.rm = TRUE),
            `Pct of Under 18` = round(sum(NewUnder18)/max(TotalUnder18)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Under 18` > 0) %>% 
  mutate(`Pct of Under 18` = if_else(`Pct of Under 18` > 100, 100, `Pct of Under 18`)) %>% 
  mutate(`Pct of Under 18` = paste0(`Pct of Under 18`,"%")) %>% 
  arrange(desc(`Under 18`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = paste("Persons Under 18","with Average Headways",paste0("Over ",quantile(ma_routes_sf_RT$mean_headways,0.8)," Minutes"),sep = "\n"), align = "r", col.names = c(names(.)[1:2],"Number of Under 18 in Block Groups","Pct of Under 18 in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapHeadwayRTMAINC, fig.align = "center", fig.cap="Low income persons, as defined by state environmental justice policy, within 800m or 1/2 mile of rapid transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
m <- tm_shape(ma_towns_sf, bbox = ma_routes_sf_RT, unit = "mi") + 
  tm_polygons(col = "gray", border.alpha = 0.8, lwd = 0.2, alpha = 0.2) +
  tm_text("NAME", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(headway80thblkgrps_RT, unit = "mi") +
  tm_fill(col = "NewMA_LOWINC", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nMA Low Income\nPersons",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  # tm_shape(ma_towns_sf_pts) + tm_dots() +
  # tm_text("NAME", size = 0.5, col = "black",
  #         xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 1, 2), text.size = 0.5,
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "RT Route", col = "darkblue") +
  tm_layout(title = paste("MA Low Income","Persons with RT", "Headways Over", paste0(quantile(ma_routes_sf_RT$mean_headways,0.8)," Minutes"),sep = "\n"),
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_headwayMAINCRT.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_headwayMAINCRT.png")
```

```{r tabHeadwayRTMAINC, fig.align = "center", fig.cap="Low income persons, as defined by state environmental justice policy, within 800m or 1/2 mile of rapid transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
headway80thblkgrps_RT %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `MA Low Income` = sum(NewMA_LOWINC,na.rm = TRUE),
            `Pct of MA Low Income` = round(sum(NewMA_LOWINC)/max(TotalMA_LOWINC)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of MA Low Income` > 0) %>% 
  mutate(`Pct of MA Low Income` = if_else(`Pct of MA Low Income` > 100,100,`Pct of MA Low Income`)) %>% 
  mutate(`Pct of MA Low Income` = paste0(`Pct of MA Low Income`,"%")) %>% 
  arrange(desc(`MA Low Income`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = paste("MA Low Income Persons","with Average Headways",paste0("Over ",quantile(ma_routes_sf_RT$mean_headways,0.8)," Minutes"),sep = "\n"), align = "r", col.names = c(names(.)[1:2],"Number of MA Low Income in Block Groups","Pct of MA Low Income in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapHeadwayRTINC, fig.align = "center", fig.cap="Low income persons within 800m or 1/2 mile of rapid transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
m <- tm_shape(ma_towns_sf, bbox = ma_routes_sf_RT, unit = "mi") + 
  tm_polygons(col = "gray", border.alpha = 0.8, lwd = 0.2, alpha = 0.2) +
  tm_text("NAME", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(headway80thblkgrps_RT, unit = "mi") +
  tm_fill(col = "NewPov", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nLow Income\nPersons",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  # tm_shape(ma_towns_sf_pts) + tm_dots() +
  # tm_text("NAME", size = 0.5, col = "black",
  #         xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 1, 2), text.size = 0.5,
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=1, labels = "RT Route", col = "darkblue") +
  tm_layout(title = paste("Low Income Persons","with Rapid Transit", "Headways Over",paste0(quantile(ma_routes_sf_RT$mean_headways,0.8)," Minutes"),sep = "\n"),
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_headwayINCRT.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_headwayINCRT.png")
```

```{r tabHeadwayRTINC, fig.align = "center", fig.cap="Low income persons within 800m or 1/2 mile of rapid transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
headway80thblkgrps_RT %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Low Income` = sum(NewPov,na.rm = TRUE),
            `Pct of Low Income` = round(sum(NewPov)/max(TotalLowInc)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Low Income` > 0) %>% 
  mutate(`Pct of Low Income` = if_else(`Pct of Low Income` > 100,100,`Pct of Low Income`)) %>% 
  mutate(`Pct of Low Income` = paste0(`Pct of Low Income`,"%")) %>% 
  arrange(desc(`Low Income`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = paste("Low Income Persons","with Average Headways",paste0("Over ",quantile(ma_routes_sf_RT$mean_headways,0.8)," Minutes"),sep = "\n"), align = "r", col.names = c(names(.)[1:2],"Number of Low Income in Block Groups","Pct of Low Income in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapHeadwayRTO64, fig.align = "center", fig.cap="Persons over 64 within 800m or 1/2 mile of rapid transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
m <- tm_shape(ma_towns_sf, bbox = ma_routes_sf_RT, unit = "mi") + 
  tm_polygons(col = "gray", border.alpha = 0.8, lwd = 0.2, alpha = 0.2) +
  tm_text("NAME", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(headway80thblkgrps_RT, unit = "mi") +
  tm_fill(col = "NewOver64", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nPersons Over 64",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  # tm_shape(ma_towns_sf_pts) + tm_dots() +
  # tm_text("NAME", size = 0.5, col = "black", 
  #         xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 1, 2), text.size = 0.5, 
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Transit Route") +
  tm_layout(title = paste("Persons Over 64","with Rapid Transit", "Headways Over",paste0(quantile(ma_routes_sf_RT$mean_headways,0.8)," Minutes"),sep = "\n"), 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_headwayO64RT.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_headwayO64RT.png")
```

```{r tabHeadwayRTO64, fig.align = "center", fig.cap="Persons over 64 within 800m or 1/2 mile of rapid transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
headway80thblkgrps_RT %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Over 64` = sum(NewOver64,na.rm = TRUE),
            `Pct of Over 64` = round(sum(NewOver64)/max(TotalOver64)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Over 64` > 0) %>% 
  mutate(`Pct of Over 64` = if_else(`Pct of Over 64` > 100, 100, `Pct of Over 64`)) %>% 
  mutate(`Pct of Over 64` = paste0(`Pct of Over 64`,"%")) %>% 
  arrange(desc(`Over 64`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = paste("Persons Over 64","with Rapid Transit Headways",paste0("Over ",quantile(ma_routes_sf_RT$mean_headways,0.8)," Minutes"),sep = "\n"), align = "r", col.names = c(names(.)[1:2],"Number of Over 64 in Block Groups","Pct of Over 64 in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapHeadwayRTMIN, fig.align = "center", fig.cap="Minority persons within 800m or 1/2 mile of rapid transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
m <- tm_shape(ma_towns_sf, bbox = ma_routes_sf_RT, unit = "mi") + 
  tm_polygons(col = "gray", border.alpha = 0.8, lwd = 0.2, alpha = 0.2) +
  tm_text("NAME", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(headway80thblkgrps_RT, unit = "mi") +
  tm_fill(col = "NewMinority", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nMinority Persons",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  # tm_shape(ma_towns_sf_pts) + tm_dots() +
  # tm_text("NAME", size = 0.5, col = "black", 
  #         xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 1, 2), text.size = 0.5, 
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Transit Route") +
  tm_layout(title = paste("Minority Persons","with Rapid Transit Headways",paste0("Over ",quantile(ma_routes_sf_RT$mean_headways,0.8)," Minutes"),sep = "\n"), 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_headwayMINRT.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_headwayMINRT.png")
```

```{r tabHeadwayRTMIN, fig.align = "center", fig.cap="Minority persons within 800m or 1/2 mile of rapid transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
headway80thblkgrps_RT %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            Minority = sum(NewOver64,na.rm = TRUE),
            `Pct of Minority` = round(sum(NewMinority)/max(TotalMin)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Minority` > 0) %>% 
  mutate(`Pct of Minority` = if_else(`Pct of Minority` > 100, 100, `Pct of Minority`)) %>% 
  mutate(`Pct of Minority` = paste0(`Pct of Minority`,"%")) %>% 
  arrange(desc(Minority)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = paste("Minority Persons","with Rapid Transit Headways",paste0("Over ",quantile(ma_routes_sf_RT$mean_headways,0.8)," Minutes"),sep = "\n"), align = "r", col.names = c(names(.)[1:2],"Number of Minorities in Block Groups","Pct of Minorities in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapHeadwayRTNoCar, fig.align = "center", fig.cap="Households without a car within 800m or 1/2 mile of rapid transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
m <- tm_shape(ma_towns_sf, bbox = ma_routes_sf_RT, unit = "mi") + 
  tm_polygons(col = "gray", border.alpha = 0.8, lwd = 0.2, alpha = 0.2) +
  tm_text("NAME", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(headway80thtracts_RT, unit = "mi") +
  tm_fill(col = "NewHHNoCar", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nNo Car Households",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  # tm_shape(ma_towns_sf_pts) + tm_dots() +
  # tm_text("NAME", size = 0.5, col = "black", 
  #         xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 1, 2), text.size = 0.5, 
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Transit Route") +
  tm_layout(title = paste("Households", "without a Car", "with Rapid Transit", "Headways Over", paste0(quantile(ma_routes_sf_RT$mean_headways,0.8)," Minutes"),sep = "\n"), 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_headwayNoCarHHRT.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_headwayNoCarHHRT.png")
```

```{r tabHeadwayRTNoCar, fig.align = "center", fig.cap="Households without a car within 800m or 1/2 mile of rapid transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
headway80thtracts_RT %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Tracts` = n(),
            `No Car HH` = sum(NewHHNoCar,na.rm = TRUE),
            `Pct of No Car HH` = round(sum(NewHHNoCar)/max(TotalNoCar)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of No Car HH` > 0) %>% 
  mutate(`Pct of No Car HH` = if_else(`Pct of No Car HH` > 100, 100, `Pct of No Car HH`)) %>% 
  mutate(`Pct of No Car HH` = paste0(`Pct of No Car HH`,"%")) %>% 
  arrange(desc(`No Car HH`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = paste("Households without a Car","with Rapid Transit Headways",paste0("Over ",quantile(ma_routes_sf_RT$mean_headways,0.8)," Minutes"),sep = "\n"), align = "r", col.names = c(names(.)[1:2],"Number of No Car Households in Census Tracts","Pct of No Car Households in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped"))
```

```{r mapHeadwayRTMAMIN, fig.align = "center", fig.cap="Minority persons, as defined by state environmental justice policy, within 800m or 1/2 mile of rapid transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
m <- tm_shape(ma_towns_sf, bbox = ma_routes_sf_RT, unit = "mi") + 
  tm_polygons(col = "gray", border.alpha = 0.8, lwd = 0.2, alpha = 0.2) +
  tm_text("NAME", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(headway80thblkgrps_RT, unit = "mi") +
  tm_fill(col = "NewMA_MINORITY", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nMA Minority Persons",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  # tm_shape(ma_towns_sf_pts) + tm_dots() +
  # tm_text("NAME", size = 0.5, col = "black", 
  #         xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 1, 2), text.size = 0.5, 
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Transit Route") +
  tm_layout(title = paste("MA Minority Persons","with Rapid Transit Headways", paste0("Over ",quantile(ma_routes_sf_RT$mean_headways,0.8)," Minutes"),sep = "\n"), 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_headwayMAMINRT.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_headwayMAMINRT.png")
```

```{r tabHeadwayRTMAMIN, fig.align = "center", fig.cap="MA Minority persons within 800m or 1/2 mile of rapid transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
headway80thblkgrps_RT %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `MA Minority` = sum(NewMA_MINORITY,na.rm = TRUE),
            `Pct of MA Minority` = round(sum(NewMA_MINORITY)/max(TotalMA_MINORITY)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of MA Minority` > 0) %>% 
  mutate(`Pct of MA Minority` = if_else(`Pct of MA Minority` > 100, 100, `Pct of MA Minority`)) %>% 
  mutate(`Pct of MA Minority` = paste0(`Pct of MA Minority`,"%")) %>% 
  arrange(desc(`MA Minority`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = paste("MA Minority Persons","with Rapid Transit Headways", paste0("Over ",quantile(ma_routes_sf_RT$mean_headways,0.8)," Minutes"),sep = "\n"), align = "r", col.names = c(names(.)[1:2],"Number of Minorities in Block Groups","Pct of Minorities in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapHeadwayRTLEH, fig.align = "center", fig.cap="Limited English speaking households within 800m or 1/2 mile of rapid transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
m <- tm_shape(ma_towns_sf, bbox = ma_routes_sf_RT, unit = "mi") + 
  tm_polygons(col = "gray", border.alpha = 0.8, lwd = 0.2, alpha = 0.2) +
  tm_text("NAME", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(headway80thblkgrps_RT, unit = "mi") +
  tm_fill(col = "NewEng_limit", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nLimited English Households",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  # tm_shape(ma_towns_sf_pts) + tm_dots() +
  # tm_text("NAME", size = 0.5, col = "black", 
  #         xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 1, 2), text.size = 0.5, 
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Transit Route") +
  tm_layout(title = paste("Limited English","Speaking","Households","with Rapid Transit", "Headways Over",paste0(quantile(ma_routes_sf_RT$mean_headways,0.8)," Minutes"),sep = "\n"), 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_headwayLEHRT.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_headwayLEHRT.png")
```

```{r tabHeadwayRTLEH, fig.align = "center", fig.cap="Limited English speaking households within 800m or 1/2 mile of rapid transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
headway80thblkgrps_RT %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Limited English HH` = sum(NewEng_limit,na.rm = TRUE),
            `Pct of Limited English HH` = round(sum(NewEng_limit)/max(TotalLEH)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  mutate(`Pct of Limited English HH` = if_else(`Pct of Limited English HH` > 100, 100, `Pct of Limited English HH`)) %>% 
  filter(`Pct of Limited English HH` > 0) %>% 
  mutate(`Pct of Limited English HH` = paste0(`Pct of Limited English HH`,"%")) %>% 
  arrange(desc(`Limited English HH`)) %>% 
  filter(`Limited English HH` > 0) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = paste("Limited English","Speaking","Households","with Rapid Transit Headways",paste0("Over ",quantile(ma_routes_sf_RT$mean_headways,0.8)," Minutes"),sep = "\n"), align = "r", col.names = c(names(.)[1:2],"Number of Limited English Households in Block Groups","Pct of Limited English Households in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapHeadwayRTMALEH, fig.align = "center", fig.cap="Limited English speaking households, as defined by state environmental justice policy, within 800m or 1/2 mile of rapid transit stops in which the mean headway for these stops is above the 80th percentile for the state.",include=FALSE,eval=FALSE}
m <- tm_shape(ma_towns_sf, bbox = ma_routes_sf_RT, unit = "mi") + 
  tm_polygons(col = "gray", border.alpha = 0.8, lwd = 0.2, alpha = 0.2) +
  tm_text("NAME", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(headway80thblkgrps_RT, unit = "mi") +
  tm_fill(col = "NewMA_ENGLISH", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nMA Limited English\nHouseholds",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  # tm_shape(ma_towns_sf_pts) + tm_dots() +
  # tm_text("NAME", size = 0.5, col = "black", 
  #         xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 1, 2), text.size = 0.5, 
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Transit Route") +
  tm_layout(title = paste("MA Limited English","Speaking","Households","with Rapid Transit", "Headways Over", paste0(quantile(ma_routes_sf_RT$mean_headways,0.8)," Minutes"),sep = "\n"), 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_headwayMALEHRT.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_headwayMALEHRT.png")
```

```{r tabHeadwayRTMALEH, fig.align = "center", fig.cap="Limited English speaking households, as defined by state environmental justice policy, within 800m or 1/2 mile of rapid transit stops in which the mean headway for these stops is above the 80th percentile for the state.",include=FALSE,eval=FALSE}
headway80thblkgrps_RT %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `MA Limited English HH` = sum(NewMA_ENGLISH,na.rm = TRUE),
            `Pct of MA Limited English HH` = round(sum(NewMA_ENGLISH)/max(TotalMA_ENGLISH)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  mutate(`Pct of MA Limited English HH` = if_else(`Pct of MA Limited English HH` > 100, 100, `Pct of MA Limited English HH`)) %>% 
  filter(`Pct of MA Limited English HH` > 0) %>% 
  mutate(`Pct of MA Limited English HH` = paste0(`Pct of MA Limited English HH`,"%")) %>% 
  arrange(desc(`MA Limited English HH`)) %>% 
  filter(`MA Limited English HH` > 0) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = paste("MA Limited English","Speaking","Households","with Rapid Transit Headways",paste0("Over ",quantile(ma_routes_sf_RT$mean_headways,0.8)," Minutes"),sep = "\n"), align = "r", col.names = c(names(.)[1:2],"Number of MA Limited English Households in Block Groups","Pct of MA Limited English Households in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```
No populations of limited English speaking households, as defined by state environmental justice policy, were found in areas with rapid transit headways exceeding the 80th percentile. 


### Excessive Commuter Rail Headways and Populations of Concern {-}

```{r mapHeadwayCRDisabled, fig.align = "center", fig.cap="Disabled Persons within 4800m or 3 miles of commuter rail stops in which the mean headway for these stops is above the 80th percentile for the state."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") +
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(headway80thtracts_CR, unit = "mi") +
  tm_fill(col = "NewDisabled", style = "equal", colorNA = "white", 
          colorNULL = "gray", title = "Number of\nDisabled Persons",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) +
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_rapid busRoutesAll_sf_simple) +
  # tm_lines(lwd = 2, alpha = 0.3, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black",
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5,
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Bus Route",
  #               col = "darkblue") +
  tm_layout(title = paste("Disabled Persons","with Commuter", "Rail Headways",paste0("Over ",quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"),
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_headwayDisabledCR.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_headwayDisabledCR.png")
```

```{r tabHeadwayCRDisabled, fig.align = "center", fig.cap="Disabled Persons within 4800m or 3 miles of commuter rail stops in which the mean headway for these stops is above the 80th percentile for the state."}
headway80thtracts_CR %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Tracts` = n(),
            Disabled = sum(NewDisabled,na.rm = TRUE),
            `Pct of Disabled` = round(sum(NewDisabled)/max(TotalDisabled)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Disabled` > 0) %>% 
  mutate(`Pct of Disabled` = if_else(`Pct of Disabled` > 100, 100, `Pct of Disabled`)) %>%
  mutate(`Pct of Disabled` = paste0(`Pct of Disabled`,"%")) %>% 
  arrange(desc(Disabled)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = paste("Disabled Persons","with Average Headways",paste0("Over ",quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"), align = "r", col.names = c(names(.)[1:2],"Number of Disabled in Census Tracts","Pct of Disabled in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapHeadwayCRU5, fig.align = "center", fig.cap="Children under 5 within 4800m or 3 miles of commuter rail stops in which the mean headway for these stops is above the 80th percentile for the state."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") +
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(headway80thblkgrps_CR, unit = "mi") +
  tm_fill(col = "NewUnder5", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nChildren Under 5",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) +
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_CRRoutesAll_sf_simple) +
  # tm_lines(lwd = 2, alpha = 0.3, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black",
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5,
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Bus Route", col = "darkblue") +
  tm_layout(title = paste("Children Under 5","with Commuter", "Rail Headways",paste0("Over ",quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"),
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_headwayUnder5CR.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_headwayUnder5CR.png")
```

```{r tabHeadwayCRU5, fig.align = "center", fig.cap="Children under 5 within 4800m or 3 miles of transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
headway80thblkgrps_CR %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Under 5` = sum(NewUnder5,na.rm = TRUE),
            `Pct of Under 5` = round(sum(NewUnder5)/max(TotalUnder5)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Under 5` > 0) %>% 
  mutate(`Pct of Under 5` = if_else(`Pct of Under 5` > 100, 100, `Pct of Under 5`)) %>% 
  mutate(`Pct of Under 5` = paste0(`Pct of Under 5`,"%")) %>% 
  arrange(desc(`Under 5`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = paste("Children Under 5","with Average Headways",paste0("Over ",quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"), align = "r", col.names = c(names(.)[1:2],"Number of Under 5 in Block Groups","Pct of Under 5 in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapHeadwayCRU18, fig.align = "center", fig.cap="Persons under 18 within 4800m or 3 miles of commuter rail stops in which the mean headway for these stops is above the 80th percentile for the state."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") +
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(headway80thblkgrps_CR, unit = "mi") +
  tm_fill(col = "NewUnder18", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nPersons Under 18",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) +
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_CRRoutesAll_sf_simple) +
  # tm_lines(lwd = 2, alpha = 0.3, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black",
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5,
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Bus Route", col = "darkblue") +
  tm_layout(title = paste("Persons Under 18","with Commuter", "Rail Headways",paste0("Over ",quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"),
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_headwayUnder18CR.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_headwayUnder18CR.png")
```

```{r tabHeadwayCRU18, fig.align = "center", fig.cap="Persons under 18 within 4800m or 3 miles of transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
headway80thblkgrps_CR %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Under 18` = sum(NewUnder18,na.rm = TRUE),
            `Pct of Under 18` = round(sum(NewUnder18)/max(TotalUnder18)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Under 18` > 0) %>% 
  mutate(`Pct of Under 18` = if_else(`Pct of Under 18` > 100, 100, `Pct of Under 18`)) %>% 
  mutate(`Pct of Under 18` = paste0(`Pct of Under 18`,"%")) %>% 
  arrange(desc(`Under 18`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = paste("Persons Under 18","with Average Headways",paste0("Over ",quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"), align = "r", col.names = c(names(.)[1:2],"Number of Under 18 in Block Groups","Pct of Under 18 in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapHeadwayCRMAINC, fig.align = "center", fig.cap="Low income persons, as defined by state environmental justice policy, within 4800m or 3 miles of transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") +
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(headway80thblkgrps_CR, unit = "mi") +
  tm_fill(col = "NewMA_LOWINC", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nMA Low Income\nPersons",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) +
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_CRRoutesAll_sf_simple) +
  # tm_lines(lwd = 2, alpha = 0.3, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black",
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5,
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Bus Route", col = "darkblue") +
  tm_layout(title = paste("MA Low Income","Persons with Bus", "Headways Over", paste0(quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"),
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_headwayMAINCCR.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_headwayMAINCCR.png")
```

```{r tabHeadwayCRMAINC, fig.align = "center", fig.cap="Low income persons, as defined by state environmental justice policy, within 4800m or 3 miles of transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
headway80thblkgrps_CR %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `MA Low Income` = sum(NewMA_LOWINC,na.rm = TRUE),
            `Pct of MA Low Income` = round(sum(NewMA_LOWINC)/max(TotalMA_LOWINC)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of MA Low Income` > 0) %>% 
  mutate(`Pct of MA Low Income` = if_else(`Pct of MA Low Income` > 100,100,`Pct of MA Low Income`)) %>% 
  mutate(`Pct of MA Low Income` = paste0(`Pct of MA Low Income`,"%")) %>% 
  arrange(desc(`MA Low Income`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = paste("MA Low Income Persons","with Average Headways",paste0("Over ",quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"), align = "r", col.names = c(names(.)[1:2],"Number of MA Low Income in Block Groups","Pct of MA Low Income in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapHeadwayCRINC, fig.align = "center", fig.cap="Low income persons within 4800m or 3 miles of transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") +
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(headway80thblkgrps_CR, unit = "mi") +
  tm_fill(col = "NewPov", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nLow Income\nPersons",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) +
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_CRRoutesAll_sf_simple) +
  # tm_lines(lwd = 1, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black",
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5,
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=1, labels = "Bus Route", col = "darkblue") +
  tm_layout(title = paste("Low Income Persons","with Commuter", "Rail Headways",paste0("Over ",quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"),
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_headwayINCCR.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_headwayINCCR.png")
```

```{r tabHeadwayCRINC, fig.align = "center", fig.cap="Low income persons within 4800m or 3 miles of transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
headway80thblkgrps_CR %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Low Income` = sum(NewPov,na.rm = TRUE),
            `Pct of Low Income` = round(sum(NewPov)/max(TotalLowInc)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Low Income` > 0) %>% 
  mutate(`Pct of Low Income` = if_else(`Pct of Low Income` > 100,100,`Pct of Low Income`)) %>% 
  mutate(`Pct of Low Income` = paste0(`Pct of Low Income`,"%")) %>% 
  arrange(desc(`Low Income`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = paste("Low Income Persons","with Average Headways",paste0("Over ",quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"), align = "r", col.names = c(names(.)[1:2],"Number of Low Income in Block Groups","Pct of Low Income in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapHeadwayCRNOHS, fig.align = "center", fig.cap="Adults without a high school diploma within 4800m or 3 miles of commuter rail stops in which the mean headway for these stops is above the 80th percentile for the state."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(headway80thblkgrps_CR, unit = "mi") +
  tm_fill(col = "NewLths", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nAdults without a\nHigh School Diploma",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_CRRoutesAll_sf_simple) +
  # tm_lines(lwd = 1, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Transit Route") +
  tm_layout(title = paste("Adults without a", "High School Diploma","with Commuter", "Rail Headways",paste0("Over ",quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"), 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_headwayLTHSCR.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_headwayLTHSCR.png")
```

```{r tabHeadwayCRNOHS, fig.align = "center", fig.cap="Adults without a high school diploma within 4800m or 3 miles of transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
headway80thblkgrps_CR %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `No HS Dip` = sum(NewLths,na.rm = TRUE),
            `Pct of No HS Dip` = round(sum(NewLths)/max(TotalNoHS)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of No HS Dip` > 0) %>% 
  mutate(`Pct of No HS Dip` = if_else(`Pct of No HS Dip` > 100, 100, `Pct of No HS Dip`)) %>% 
  mutate(`Pct of No HS Dip` = paste0(`Pct of No HS Dip`,"%")) %>% 
  arrange(desc(`No HS Dip`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = paste("Adults without a", "High School Diploma","with Commuter", "Rail Headways",paste0("Over ",quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"), align = "r", col.names = c(names(.)[1:2],"Number of No HS Dip in Block Groups","Pct of No HS Dip in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapHeadwayCRMIN, fig.align = "center", fig.cap="Minority persons within 4800m or 3 miles of commuter rail stops in which the mean headway for these stops is above the 80th percentile for the state."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(headway80thblkgrps_CR, unit = "mi") +
  tm_fill(col = "NewMinority", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nMinority Persons",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_CRRoutesAll_sf_simple) +
  # tm_lines(lwd = 1, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Transit Route") +
  tm_layout(title = paste("Minority Persons","with Commuter", "Rail Headways",paste0("Over ",quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"), 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_headwayMINCR.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_headwayMINCR.png")
```

```{r tabHeadwayCRMIN, fig.align = "center", fig.cap="Minority persons within 4800m or 3 miles of transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
headway80thblkgrps_CR %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            Minority = sum(NewOver64,na.rm = TRUE),
            `Pct of Minority` = round(sum(NewMinority)/max(TotalMin)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Minority` > 0) %>% 
  mutate(`Pct of Minority` = if_else(`Pct of Minority` > 100, 100, `Pct of Minority`)) %>% 
  mutate(`Pct of Minority` = paste0(`Pct of Minority`,"%")) %>% 
  arrange(desc(Minority)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = paste("Minority Persons","with Commuter", "Rail Headways",paste0("Over ",quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"), align = "r", col.names = c(names(.)[1:2],"Number of Minorities in Block Groups","Pct of Minorities in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapHeadwayCRNoCar, fig.align = "center", fig.cap="Households without a car within 4800m or 3 miles of transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(headway80thtracts_CR, unit = "mi") +
  tm_fill(col = "NewHHNoCar", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nNo Car Households",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_tracts_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_CRRoutesAll_sf_simple) +
  # tm_lines(lwd = 1, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Transit Route") +
  tm_layout(title = paste("Households", "without a Car", "with Commuter", "Rail Headways", paste0("Over ",quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"), 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_headwayNoCarHHCR.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_headwayNoCarHHCR.png")
```

```{r tabHeadwayCRNoCar, fig.align = "center", fig.cap="Households without a car within 4800m or 3 miles of transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
headway80thtracts_CR %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Tracts` = n(),
            `No Car HH` = sum(NewHHNoCar,na.rm = TRUE),
            `Pct of No Car HH` = round(sum(NewHHNoCar)/max(TotalNoCar)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of No Car HH` > 0) %>% 
  mutate(`Pct of No Car HH` = if_else(`Pct of No Car HH` > 100, 100, `Pct of No Car HH`)) %>% 
  mutate(`Pct of No Car HH` = paste0(`Pct of No Car HH`,"%")) %>% 
  arrange(desc(`No Car HH`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = paste("Households without a Car","with Commuter", "Rail Headways",paste0("Over ",quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"), align = "r", col.names = c(names(.)[1:2],"Number of No Car Households in Census Tracts","Pct of No Car Households in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped"))
```

```{r mapHeadwayCRMAMIN, fig.align = "center", fig.cap="Minority persons, as defined by state environmental justice policy, within 4800m or 3 miles of commuter rail stops in which the mean headway for these stops is above the 80th percentile for the state."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(headway80thblkgrps_CR, unit = "mi") +
  tm_fill(col = "NewMA_MINORITY", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nMA Minority Persons",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_CRRoutesAll_sf_simple) +
  # tm_lines(lwd = 1, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Transit Route") +
  tm_layout(title = paste("MA Minority Persons","with Commuter", "Rail Headways", paste0("Over ",quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"), 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_headwayMAMINCR.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_headwayMAMINCR.png")
```

```{r tabHeadwayCRMAMIN, fig.align = "center", fig.cap="MA Minority persons within 4800m or 3 miles of transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
headway80thblkgrps_CR %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `MA Minority` = sum(NewMA_MINORITY,na.rm = TRUE),
            `Pct of MA Minority` = round(sum(NewMA_MINORITY)/max(TotalMA_MINORITY)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of MA Minority` > 0) %>% 
  mutate(`Pct of MA Minority` = if_else(`Pct of MA Minority` > 100, 100, `Pct of MA Minority`)) %>% 
  mutate(`Pct of MA Minority` = paste0(`Pct of MA Minority`,"%")) %>% 
  arrange(desc(`MA Minority`)) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = paste("MA Minority Persons","with Commuter", "Rail Headways", paste0("Over ",quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"), align = "r", col.names = c(names(.)[1:2],"Number of Minorities in Block Groups","Pct of Minorities in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapHeadwayCRLEH, fig.align = "center", fig.cap="Limited English speaking households within 4800m or 3 miles of transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(headway80thblkgrps_CR, unit = "mi") +
  tm_fill(col = "NewEng_limit", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nLimited English Households",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_CRRoutesAll_sf_simple) +
  # tm_lines(lwd = 1, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Transit Route") +
  tm_layout(title = paste("Limited English","Speaking","Households","with Commuter", "Rail Headways",paste0("Over ",quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"), 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_headwayLEHCR.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_headwayLEHCR.png")
```

```{r tabHeadwayCRLEH, fig.align = "center", fig.cap="Limited English speaking households within 4800m or 3 miles of transit stops in which the mean headway for these stops is above the 80th percentile for the state."}
headway80thblkgrps_CR %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Limited English HH` = sum(NewEng_limit,na.rm = TRUE),
            `Pct of Limited English HH` = round(sum(NewEng_limit)/max(TotalLEH)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  mutate(`Pct of Limited English HH` = if_else(`Pct of Limited English HH` > 100, 100, `Pct of Limited English HH`)) %>% 
  filter(`Pct of Limited English HH` > 0) %>% 
  mutate(`Pct of Limited English HH` = paste0(`Pct of Limited English HH`,"%")) %>% 
  arrange(desc(`Limited English HH`)) %>% 
  filter(`Limited English HH` > 0) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = paste("Limited English","Speaking","Households","with Commuter", "Rail Headways",paste0("Over ",quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"), align = "r", col.names = c(names(.)[1:2],"Number of Limited English Households in Block Groups","Pct of Limited English Households in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

```{r mapHeadwayCRMALEH, fig.align = "center", fig.cap="Limited English speaking households, as defined by state environmental justice policy, within 4800m or 3 miles of transit stops in which the mean headway for these stops is above the 80th percentile for the state.", include=FALSE, eval=FALSE}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(headway80thblkgrps_CR, unit = "mi") +
  tm_fill(col = "NewMA_ENGLISH", style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Number of\nMA Limited English\nHouseholds",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd") +
  tm_shape(ma_towns_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
  tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  # tm_shape(ma_CRRoutesAll_sf_simple) +
  # tm_lines(lwd = 1, col = "darkblue") +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  # tm_add_legend(type = "line", lwd=2, alpha = 0.5, labels = "Transit Route") +
  tm_layout(title = paste("MA Limited English","Speaking","Households","with Commuter", "Rail Headways",paste0("Over ",quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"), 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_headwayMALEHCR.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_headwayMALEHCR.png")
```

```{r tabHeadwayCRMALEH, fig.align = "center", fig.cap="Limited English speaking households, as defined by state environmental justice policy, within 4800m or 3 miles of transit stops in which the mean headway for these stops is above the 80th percentile for the state.", include=FALSE, eval=FALSE}
headway80thblkgrps_CR %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `MA Limited English HH` = sum(NewMA_ENGLISH,na.rm = TRUE),
            `Pct of MA Limited English HH` = round(sum(NewMA_ENGLISH)/max(TotalMA_ENGLISH)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  mutate(`Pct of MA Limited English HH` = if_else(`Pct of MA Limited English HH` > 100, 100, `Pct of MA Limited English HH`)) %>% 
  filter(`Pct of MA Limited English HH` > 0) %>% 
  mutate(`Pct of MA Limited English HH` = paste0(`Pct of MA Limited English HH`,"%")) %>% 
  arrange(desc(`MA Limited English HH`)) %>% 
  filter(`MA Limited English HH` > 0) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = paste("MA Limited English","Speaking","Households","with Commuter", "Rail Headways",paste0("Over ",quantile(ma_routes_sf_Bus$mean_headways,0.8)," Minutes"),sep = "\n"), align = "r", col.names = c(names(.)[1:2],"Number of MA Limited English Households in Block Groups","Pct of MA Limited English Households in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped")) 
```

No populations of limited English speaking Households, as defined by state environmental justice policy, were found in areas with commuter rail headways exceeding the 80th percentile. 


## Low Walkability and Populations of Concern {-}

```{r mapLowWalkDisabled, fig.align = "center", fig.cap="Disabled persons per square kilometer in least walkable Census Block Groups (i.e., Walkability Index Score less than or equal to 5.8)."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(leastWalkableTract, unit = "mi") +
  tm_fill(col = "disabledOver18E", alpha = 0.9, style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Disabled Persons\nPer Square Kilometer",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd", convert2density = TRUE, area = "SqKm") +
  tm_shape(ma_tracts_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
   tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  tm_layout(title = "Disabled Persons\nin Least Walkable\nTracts", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_walkDisabled.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_walkDisabled.png")
```

```{r tabLowWalkDisabled, fig.align = "center", fig.cap="Disabled persons by municipality in least walkable Census Tracts (i.e., Walkability Index Score less than or equal to 5.8)."}
leastWalkableTract %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Tracts` = n(),
            Disabled = sum(disabledOver18E,na.rm = TRUE),
            `Pct of Disabled` = round(sum(disabledOver18E)/max(TotalDisabled)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Disabled` > 0) %>% 
  mutate(`Pct of Disabled` = if_else(`Pct of Disabled` > 100, 100, `Pct of Disabled`)) %>%
  mutate(`Pct of Disabled` = paste0(`Pct of Disabled`,"%")) %>% 
  arrange(desc(`Disabled`)) %>% 
  filter(Disabled > 0) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Disabled Persons in Least Walkable Census Tracts", align = "r", col.names = c(names(.)[1:2],"Number of Disabled in Census Tracts","Pct of Disabled in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped"))
```

```{r mapLowWalkU5, fig.align = "center", fig.cap="Children under 5 per square kilometer in least walkable Census Block Groups (i.e., Walkability Index Score less than or equal to 5.8)."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(leastWalkable, unit = "mi") +
  tm_fill(col = "under5E", alpha = 0.9, style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Children Under 5\nPer Square Kilometer",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd", convert2density = TRUE, area = "SqKm") +
  tm_shape(ma_tracts_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
   tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  tm_layout(title = "Children Under 5\nin Least Walkable\nBlock Groups", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_walkU5.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_walkU5.png")
```

```{r tabLowWalkU5, fig.align = "center", fig.cap="Children under 5 by municipality in least walkable Census Block Groups (i.e., Walkability Index Score less than or equal to 5.8)."}
leastWalkable %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Under 5` = sum(under5E,na.rm = TRUE),
            `Pct of Under 5` = round(sum(under5E)/max(TotalUnder5)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Under 5` > 0) %>% 
  mutate(`Pct of Under 5` = if_else(`Pct of Under 5` > 100, 100, `Pct of Under 5`)) %>%
  mutate(`Pct of Under 5` = paste0(`Pct of Under 5`,"%")) %>% 
  arrange(desc(`Under 5`)) %>% 
  filter(`Under 5` > 0) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Children Under 5 in Least Walkable Block Groups", align = "r", col.names = c(names(.)[1:2],"Number of Under 5 in Block Groups","Pct of Under 5 in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped"))
```

```{r mapLowWalkNoHSDip, fig.align = "center", fig.cap="Adults without a high school diploma per square kilometer in least walkable Census Block Groups (i.e., Walkability Index Score less than or equal to 5.8)."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(leastWalkable, unit = "mi") +
  tm_fill(col = "lthsE", alpha = 0.9, style = "equal",
          colorNA = "white", colorNULL = "gray", title = "No HS Dip\nPer Square Kilometer",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd", convert2density = TRUE, area = "SqKm") +
  tm_shape(ma_tracts_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
   tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  tm_layout(title = "Adults without a\nHigh School Diploma\nin Least Walkable\nBlock Groups", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_walkNoHSDip.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_walkNoHSDip.png")
```

```{r tabLowWalkNoHSDip, fig.align = "center", fig.cap="Adults without a high school diploma by municipality in least walkable Census Block Groups (i.e., Walkability Index Score less than or equal to 5.8)."}
leastWalkable %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `No HS Dip` = sum(lthsE,na.rm = TRUE),
            `Pct of No HS Dip` = round(sum(lthsE)/max(TotalNoHS)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of No HS Dip` > 0) %>% 
  mutate(`Pct of No HS Dip` = if_else(`Pct of No HS Dip` > 100, 100, `Pct of No HS Dip`)) %>%
  mutate(`Pct of No HS Dip` = paste0(`Pct of No HS Dip`,"%")) %>% 
  arrange(desc(`No HS Dip`)) %>% 
  filter(`No HS Dip` > 0) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Adults without a High School Diploma in Least Walkable Block Groups", align = "r", col.names = c(names(.)[1:2],"Number of No HS Dip in Block Groups","Pct of No HS Dip in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped"))
```

```{r mapLowWalkLowInc, fig.align = "center", fig.cap="Low income persons per square kilometer in least walkable Census Block Groups (i.e., Walkability Index Score less than or equal to 5.8)."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(leastWalkable, unit = "mi") +
  tm_fill(col = "num2povE", alpha = 0.9, style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Low Income Persons\nPer Square Kilometer",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd", convert2density = TRUE, area = "SqKm") +
  tm_shape(ma_tracts_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
   tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  tm_layout(title = "Low Income Persons\nin Least Walkable\nBlock Groups", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_walkLowInc.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_walkLowInc.png")
```

```{r tabLowWalkLowInc, fig.align = "center", fig.cap="Low income persons by municipality in least walkable Census Block Groups (i.e., Walkability Index Score less than or equal to 5.8)."}
leastWalkable %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Low Income` = sum(num2povE,na.rm = TRUE),
            `Pct of Low Income` = round(sum(num2povE)/max(TotalLowInc)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Low Income` > 0) %>% 
  mutate(`Pct of Low Income` = if_else(`Pct of Low Income` > 100, 100, `Pct of Low Income`)) %>%
  mutate(`Pct of Low Income` = paste0(`Pct of Low Income`,"%")) %>% 
  arrange(desc(`Low Income`)) %>% 
  filter(`Low Income` > 0) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Low Income Persons in Least Walkable Block Groups", align = "r", col.names = c(names(.)[1:2],"Number of Low Income in Block Groups","Pct of Low Income in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped"))
```

```{r mapLowWalkNoCar, fig.align = "center", fig.cap="Households without a car per square kilometer in least walkable Census Tracts (i.e., Walkability Index Score less than or equal to 5.8)."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(leastWalkableTract, unit = "mi") +
  tm_fill(col = "HHnoCarE", alpha = 0.9, style = "equal",
          colorNA = "white", colorNULL = "gray", title = "No Car Households\nPer Square Kilometer",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd", convert2density = TRUE, area = "SqKm") +
  tm_shape(ma_tracts_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
   tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  tm_layout(title = "No Car Households\nin Least Walkable\nTracts", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_walkNoCar.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_walkNoCar.png")
```

```{r tabLowWalkNoCar, fig.align = "center", fig.cap="Households without a car by municipality in least walkable Census Tracts (i.e., Walkability Index Score less than or equal to 5.8)."}
leastWalkableTract %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Tracts` = n(),
            `No Car HH` = sum(HHnoCarE,na.rm = TRUE),
            `Pct of No Car HH` = round(sum(HHnoCarE)/max(TotalNoCar)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of No Car HH` > 0) %>% 
  mutate(`Pct of No Car HH` = if_else(`Pct of No Car HH` > 100, 100, `Pct of No Car HH`)) %>%
  mutate(`Pct of No Car HH` = paste0(`Pct of No Car HH`,"%")) %>% 
  arrange(desc(`No Car HH`)) %>% 
  filter(`No Car HH` > 0) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Households without a Car in Least Walkable Census Tracts", align = "r", col.names = c(names(.)[1:2],"Number of No Car Households in Census Tracts","Pct of No Car Households in City/Town")) %>%
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped"))
```

```{r mapLowWalkMinority, fig.align = "center", fig.cap="Minority persons per square kilometer in least walkable Census Block Groups (i.e., Walkability Index Score less than or equal to 5.8)."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(leastWalkable, unit = "mi") +
  tm_fill(col = "minorityE", alpha = 0.9, style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Minority Persons\nPer Square Kilometer",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd", convert2density = TRUE, area = "SqKm") +
  tm_shape(ma_tracts_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
   tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  tm_layout(title = "Minority Persons\nin Least Walkable\nBlock Groups", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_walkMinority.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_walkMinority.png")
```

```{r tabLowWalkMinority, fig.align = "center", fig.cap="Minority persons by municipality in least walkable Census Block Groups (i.e., Walkability Index Score less than or equal to 5.8)."}
leastWalkable %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            Minority = sum(minorityE,na.rm = TRUE),
            `Pct of Minority` = round(sum(minorityE)/max(TotalMin)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Minority` > 0) %>% 
  mutate(`Pct of Minority` = if_else(`Pct of Minority` > 100, 100, `Pct of Minority`)) %>%
  mutate(`Pct of Minority` = paste0(`Pct of Minority`,"%")) %>% 
  arrange(desc(Minority)) %>% 
  filter(Minority > 0) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Minority Persons in Least Walkable Block Groups", align = "r", col.names = c(names(.)[1:2],"Number of Minorities in Block Groups","Pct of Minorities in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped"))
```

```{r mapLowWalkLEH, fig.align = "center", fig.cap="Limited English speaking households per square kilometer in least walkable Census Block Groups (i.e., Walkability Index Score less than or equal to 5.8)."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(leastWalkable, unit = "mi") +
  tm_fill(col = "eng_limitE", alpha = 0.9, style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Limited English Households\nPer Square Kilometer",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd", convert2density = TRUE, area = "SqKm") +
  tm_shape(ma_tracts_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
   tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  tm_layout(title = "Limited English\nSpeaking Households\nin Least Walkable\nBlock Groups", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_walkLEH.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_walkLEH.png")
```

```{r tabLowWalkLEH, fig.align = "center", fig.cap="Limited English speaking households by municipality in least walkable Census Block Groups (i.e., Walkability Index Score less than or equal to 5.8)."}
leastWalkable %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Limited English HH` = sum(eng_limitE,na.rm = TRUE),
            `Pct of Limited English HH` = round(sum(eng_limitE)/max(TotalLEH)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Limited English HH` > 0) %>% 
  mutate(`Pct of Limited English HH` = if_else(`Pct of Limited English HH` > 100, 100, `Pct of Limited English HH`)) %>%
  mutate(`Pct of Limited English HH` = paste0(`Pct of Limited English HH`,"%")) %>% 
  arrange(desc(`Limited English HH`)) %>% 
  filter(`Limited English HH` > 0) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Limited English Speaking Households in Least Walkable Block Groups", align = "r", col.names = c(names(.)[1:2],"Number of Limited English Households in Block Groups","Pct of Limited English Households in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>% 
  kableExtra::kable_styling(latex_options = c("repeat_header","striped"))
```

```{r mapLowWalkMALEH, fig.align = "center", fig.cap="Limited English speaking households, as defined by state environmental justice policy, per square kilometer in least walkable Census Block Groups (i.e., Walkability Index Score less than or equal to 5.8)."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(leastWalkable, unit = "mi") +
  tm_fill(col = "MA_ENGLISH", alpha = 0.9, style = "equal",
          colorNA = "white", colorNULL = "gray", title = "MA Limited English Households\nPer Square Kilometer",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd", convert2density = TRUE, area = "SqKm") +
  tm_shape(ma_tracts_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
   tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  tm_layout(title = "MA Limited English\nSpeaking Households\nin Least Walkable\nBlock Groups", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_walkMALEH.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_walkMALEH.png")
```

```{r tabLowWalkMALEH, fig.align = "center", fig.cap="Limited English speaking households, as defined by state environmental justice policy, by municipality in least walkable Census Block Groups (i.e., Walkability Index Score less than or equal to 5.8)."}
leastWalkable %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `MA Limited English HH` = sum(MA_ENGLISH,na.rm = TRUE),
            `Pct of MA Limited English HH` = round(sum(MA_ENGLISH)/max(TotalMA_ENGLISH)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of MA Limited English HH` > 0) %>% 
  mutate(`Pct of MA Limited English HH` = if_else(`Pct of MA Limited English HH` > 100, 100, `Pct of MA Limited English HH`)) %>%
  mutate(`Pct of MA Limited English HH` = paste0(`Pct of MA Limited English HH`,"%")) %>% 
  arrange(desc(`MA Limited English HH`)) %>% 
  filter(`MA Limited English HH` > 0) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "MA Limited English Speaking Households in Least Walkable Block Groups", align = "r", col.names = c(names(.)[1:2],"Number of MA Limited English Households in Block Groups","Pct of MA Limited English Households in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>% 
  kableExtra::kable_styling(latex_options = c("repeat_header","striped"))
```

```{r mapLowWalkMAMIN, fig.align = "center", fig.cap="Minority persons, as defined by state environmental justice policy, per square kilometer in least walkable Census Block Groups (i.e., Walkability Index Score less than or equal to 5.8)."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(leastWalkable, unit = "mi") +
  tm_fill(col = "MA_MINORITY", alpha = 0.9, style = "equal",
          colorNA = "white", colorNULL = "gray", title = "MA Minority Persons\nPer Square Kilometer",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd", convert2density = TRUE, area = "SqKm") +
  tm_shape(ma_tracts_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
   tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  tm_layout(title = "MA Minority Persons\nin Least Walkable\nBlock Groups", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_walkMAMIN.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_walkMAMIN.png")
```

```{r tabLowWalkMAMIN, fig.align = "center", fig.cap="Minority persons, as defined by state environmental justice policy, by municipality in least walkable Census Block Groups (i.e., Walkability Index Score less than or equal to 5.8)."}
leastWalkable %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `MA Minority` = sum(MA_MINORITY,na.rm = TRUE),
            `Pct of MA Minority` = round(sum(MA_MINORITY)/max(TotalMA_MINORITY)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of MA Minority` > 0) %>% 
  mutate(`Pct of MA Minority` = if_else(`Pct of MA Minority` > 100, 100, `Pct of MA Minority`)) %>%
  mutate(`Pct of MA Minority` = paste0(`Pct of MA Minority`,"%")) %>% 
  arrange(desc(`MA Minority`)) %>% 
  filter(`MA Minority` > 0) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "MA Minority Persons in Least Walkable Block Groups", align = "r", col.names = c(names(.)[1:2],"Number of MA Minority Persons in Block Groups","Pct of MA Minority Persons in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>% 
  kableExtra::kable_styling(latex_options = c("repeat_header","striped"))
```

```{r mapLowWalkMAINC, fig.align = "center", fig.cap="Low income persons, as defined by state environmental justice policy, per square kilometer in least walkable Census Block Groups (i.e., Walkability Index Score less than or equal to 5.8)."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(leastWalkable, unit = "mi") +
  tm_fill(col = "MA_LOWINC", alpha = 0.9, style = "equal",
          colorNA = "white", colorNULL = "gray", title = "MA Low Income Persons\nPer Square Kilometer",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd", convert2density = TRUE, area = "SqKm") +
  tm_shape(ma_tracts_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
   tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  tm_layout(title = "MA Low Income Persons\nin Least Walkable\nBlock Groups", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_walkMAINC.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_walkMAINC.png")
```

```{r tabLowWalkMAINC, fig.align = "center", fig.cap="Low income persons, as defined by state environmental justice policy, by municipality in least walkable Census Block Groups (i.e., Walkability Index Score less than or equal to 5.8)."}
leastWalkable %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `MA Low Income` = sum(MA_LOWINC,na.rm = TRUE),
            `Pct of MA Low Income` = round(sum(MA_LOWINC)/max(TotalMA_LOWINC)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of MA Low Income` > 0) %>% 
  mutate(`Pct of MA Low Income` = if_else(`Pct of MA Low Income` > 100, 100, `Pct of MA Low Income`)) %>%
  mutate(`Pct of MA Low Income` = paste0(`Pct of MA Low Income`,"%")) %>% 
  arrange(desc(`MA Low Income`)) %>% 
  filter(`MA Low Income` > 0) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "MA Low Income Persons in Least Walkable Block Groups", align = "r", col.names = c(names(.)[1:2],"Number of MA Low Income Persons in Block Groups","Pct of MA Low Income Persons in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>% 
  kableExtra::kable_styling(latex_options = c("repeat_header","striped"))
```


## Highest Transportation Cost Burden and Populations of Concern {-}

```{r mapHiBurdenDisabled, fig.align = "center", fig.cap="Disabled Persons per square kilometer in Census Tracts with the highest transportation cost burden (i.e., transportation cost burden in the 80th percentile for the state)."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(HiBurdenTract, unit = "mi") +
  tm_fill(col = "disabledOver18E", alpha = 0.9, style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Disabled Persons\nPer Square Kilometer",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd", convert2density = TRUE, area = "SqKm") +
  tm_shape(ma_tracts_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
   tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  tm_layout(title = "Disabled Persons\nin Highest\nTransportation\nCost Burden\nCensus Tracts", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_HiBurdenDisabled.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_HiBurdenDisabled.png")
```

```{r tabHiBurdenDisabled, fig.align = "center", fig.cap="Disabled persons by municipality in Census Tracts with the highest transportation cost burden (i.e., transportation cost burden in the 80th percentile for the state)."}
HiBurdenTract %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Tracts` = n(),
            Disabled = sum(disabledOver18E,na.rm = TRUE),
            `Pct of Disabled` = round(sum(disabledOver18E)/max(TotalDisabled)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Disabled` > 0) %>% 
  mutate(`Pct of Disabled` = if_else(`Pct of Disabled` > 100, 100, `Pct of Disabled`)) %>%
  mutate(`Pct of Disabled` = paste0(`Pct of Disabled`,"%")) %>% 
  arrange(desc(Disabled)) %>% 
  filter(Disabled > 0) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Disabled Persons in Highest Transportation Cost Burden Census Tracts", align = "r", col.names = c(names(.)[1:2],"Number of Disabled in Census Tracts","Pct of Disabled in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped"))
```

```{r mapHiBurdenU5, fig.align = "center", fig.cap="Children under 5 per square kilometer in Census Block Groups with the highest transportation cost burden (i.e., transportation cost burden in the 80th percentile for the state)."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(HiBurden, unit = "mi") +
  tm_fill(col = "under5E", alpha = 0.9, style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Children Under 5\nPer Square Kilometer",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd", convert2density = TRUE, area = "SqKm") +
  tm_shape(ma_tracts_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
   tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  tm_layout(title = "Children Under 5\nin Highest\nTransportation\nCost Burden\nBlock Groups", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_HiBurdenU5.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_HiBurdenU5.png")
```

```{r tabHiBurdenU5, fig.align = "center", fig.cap="Children under 5 by municipality in Census Block Groups with the highest transportation cost burden (i.e., transportation cost burden in the 80th percentile for the state)."}
HiBurden %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Under 5` = sum(under5E,na.rm = TRUE),
            `Pct of Under 5` = round(sum(under5E)/max(TotalUnder5)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Under 5` > 0) %>% 
  mutate(`Pct of Under 5` = if_else(`Pct of Under 5` > 100, 100, `Pct of Under 5`)) %>%
  mutate(`Pct of Under 5` = paste0(`Pct of Under 5`,"%")) %>% 
  arrange(desc(`Under 5`)) %>% 
  filter(`Under 5` > 0) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Children Under 5 in Highest Transportation Cost Burden Block Groups", align = "r", col.names = c(names(.)[1:2],"Number of Under 5 in Block Groups","Pct of Under 5 in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped"))
```

```{r mapHiBurdenLTHS, fig.align = "center", fig.cap="Adults wihtout a high school diploma per square kilometer in Census Block Groups with the highest transportation cost burden (i.e., transportation cost burden in the 80th percentile for the state)."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(HiBurden, unit = "mi") +
  tm_fill(col = "lthsE", alpha = 0.9, style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Adults without a\nHigh School Diploma\nPer Square Kilometer",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd", convert2density = TRUE, area = "SqKm") +
  tm_shape(ma_tracts_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
   tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  tm_layout(title = "Adults without a\nHigh School\nDiploma\nin Highest\nTransportation\nCost Burden\nBlock Groups", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_HiBurdenLTHS.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_HiBurdenLTHS.png")
```

```{r tabHiBurdenLTHS, fig.align = "center", fig.cap="Adults without a high school diploma by municipality in Census Block Groups with the highest transportation cost burden (i.e., transportation cost burden in the 80th percentile for the state)."}
HiBurden %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `No HS Dip` = sum(lthsE,na.rm = TRUE),
            `Pct of No HS Dip` = round(sum(lthsE)/max(TotalNoHS)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of No HS Dip` > 0) %>% 
  mutate(`Pct of No HS Dip` = if_else(`Pct of No HS Dip` > 100, 100, `Pct of No HS Dip`)) %>%
  mutate(`Pct of No HS Dip` = paste0(`Pct of No HS Dip`,"%")) %>% 
  arrange(desc(`No HS Dip`)) %>% 
  filter(`No HS Dip` > 0) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Adults without a High Schol Diploma in Highest Transportation Cost Burden Block Groups", align = "r", col.names = c(names(.)[1:2],"Number of No HS Dip in Block Groups","Pct of No HS Dip in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped"))
```

```{r mapHiBurdenINC, fig.align = "center", fig.cap="Low income persons per square kilometer in Census Block Groups with the highest transportation cost burden (i.e., transportation cost burden in the 80th percentile for the state)."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(HiBurden, unit = "mi") +
  tm_fill(col = "lthsE", alpha = 0.9, style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Low Income Persons\nPer Square Kilometer",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd", convert2density = TRUE, area = "SqKm") +
  tm_shape(ma_tracts_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
   tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  tm_layout(title = "Low Income\nPersons\nin Highest\nTransportation\nCost Burden\nBlock Groups", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_HiBurdenINC.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_HiBurdenINC.png")
```

```{r tabHiBurdenINC, fig.align = "center", fig.cap="Low income persons by municipality in Census Block Groups with the highest transportation cost burden (i.e., transportation cost burden in the 80th percentile for the state)."}
HiBurden %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Low Income` = sum(num2povE,na.rm = TRUE),
            `Pct of Low Income` = round(sum(num2povE)/max(TotalLowInc)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Low Income` > 0) %>% 
  mutate(`Pct of Low Income` = if_else(`Pct of Low Income` > 100, 100, `Pct of Low Income`)) %>%
  mutate(`Pct of Low Income` = paste0(`Pct of Low Income`,"%")) %>% 
  arrange(desc(`Low Income`)) %>% 
  filter(`Low Income` > 0) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Low Income Persons in Highest Transportation Cost Burden Block Groups", align = "r", col.names = c(names(.)[1:2],"Number of Low Income in Block Groups","Pct of Low Income in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped"))
```

```{r mapHiBurdenNoCarHH, fig.align = "center", fig.cap="Households without a car per square kilometer in Census Tracts with the highest transportation cost burden (i.e., transportation cost burden in the 80th percentile for the state)."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(HiBurdenTract, unit = "mi") +
  tm_fill(col = "HHnoCarE", alpha = 0.9, style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Households\nwithout a Car\nPer Square Kilometer",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd", convert2density = TRUE, area = "SqKm") +
  tm_shape(ma_tracts_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
   tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  tm_layout(title = "Households\nwithout a Car\nin Highest\nTransportation\nCost Burden\nCensus Tracts", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_HiBurdenNoCarHH.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_HiBurdenNoCarHH.png")
```

```{r tabHiBurdenNoCarHH, fig.align = "center", fig.cap="Households without a car by municipality in Census Tracts with the highest transportation cost burden (i.e., transportation cost burden in the 80th percentile for the state)."}
HiBurdenTract %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Tracts` = n(),
            `No Car Households` = sum(HHnoCarE,na.rm = TRUE),
            `Pct of No Car Households` = round(sum(HHnoCarE)/max(TotalNoCar)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of No Car Households` > 0) %>% 
  mutate(`Pct of No Car Households` = if_else(`Pct of No Car Households` > 100, 100, `Pct of No Car Households`)) %>%
  mutate(`Pct of No Car Households` = paste0(`Pct of No Car Households`,"%")) %>% 
  arrange(desc(`No Car Households`)) %>% 
  filter(`No Car Households` > 0) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Households without a Car in Highest Transportation Cost Burden Census Tracts", align = "r", col.names = c(names(.)[1:2],"Number of No Car Households in Census Tracts","Pct of No Car Households in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped"))
```

```{r mapHiBurdenMIN, fig.align = "center", fig.cap="Minority persons per square kilometer in Census Block Groups with the highest transportation cost burden (i.e., transportation cost burden in the 80th percentile for the state)."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(HiBurden, unit = "mi") +
  tm_fill(col = "minorityE", alpha = 0.9, style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Minority Persons\nPer Square Kilometer",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd", convert2density = TRUE, area = "SqKm") +
  tm_shape(ma_tracts_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
   tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  tm_layout(title = "Minority\nPersons\nin Highest\nTransportation\nCost Burden\nBlock Groups", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_HiBurdenMIN.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_HiBurdenMIN.png")
```

```{r tabHiBurdenMIN, fig.align = "center", fig.cap="Minority persons by municipality in Census Block Groups with the highest transportation cost burden (i.e., transportation cost burden in the 80th percentile for the state)."}
HiBurden %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            Minority = sum(minorityE,na.rm = TRUE),
            `Pct of Minority` = round(sum(minorityE)/max(TotalMin)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  filter(`Pct of Minority` > 0) %>% 
  mutate(`Pct of Minority` = if_else(`Pct of Minority` > 100, 100, `Pct of Minority`)) %>%
  mutate(`Pct of Minority` = paste0(`Pct of Minority`,"%")) %>% 
  arrange(desc(Minority)) %>% 
  filter(`Minority` > 0) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Minority Persons in Highest Transportation Cost Burden Block Groups", align = "r", col.names = c(names(.)[1:2],"Number of Minorities in Block Groups","Pct of Minorities in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped"))
```

```{r mapHiBurdenLEH, fig.align = "center", fig.cap="Limited English speaking households per square kilometer in Census Block Groups with the highest transportation cost burden (i.e., transportation cost burden in the 80th percentile for the state)."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(HiBurden, unit = "mi") +
  tm_fill(col = "eng_limitE", alpha = 0.9, style = "equal",
          colorNA = "white", colorNULL = "gray", title = "Limited English\nSpeaking Households\nPer Square Kilometer",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd", convert2density = TRUE, area = "SqKm") +
  tm_shape(ma_tracts_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
   tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  tm_layout(title = "Limited English\nSpeaking\nHouseholds\nin Highest\nTransportation\nCost Burden\nBlock Groups", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_HiBurdenLEH.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_HiBurdenLEH.png")
```

```{r tabHiBurdenLEH, fig.align = "center", fig.cap="Limited English speaking households by municipality in Census Block Groups with the highest transportation cost burden (i.e., transportation cost burden in the 80th percentile for the state)."}
HiBurden %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `Limited English HH` = sum(eng_limitE,na.rm = TRUE),
            `Pct of Limited English HH` = round(sum(eng_limitE)/max(TotalNoHS)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  mutate(`Pct of Limited English HH` = if_else(`Pct of Limited English HH` > 100, 100,`Pct of Limited English HH`)) %>% 
  mutate(`Pct of Limited English HH` = paste0(`Pct of Limited English HH`,"%")) %>% 
  arrange(desc(`Limited English HH`)) %>% 
  filter(`Limited English HH` > 0) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "Limited English Speaking Households in Highest Transportation Cost Burden Block Groups", align = "r", col.names = c(names(.)[1:2],"Number of Limited English HH in Block Groups","Pct of Limited English HH in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped"))
```

```{r mapHiBurdenMAINC, fig.align = "center", fig.cap="Low income persons, as defined by state environmental justice policy, per square kilometer in Census Block Groups with the highest transportation cost burden (i.e., transportation cost burden in the 80th percentile for the state)."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(HiBurden, unit = "mi") +
  tm_fill(col = "MA_LOWINC", alpha = 0.9, style = "equal",
          colorNA = "white", colorNULL = "gray", title = "MA Low Income\nPersons\nPer Square Kilometer",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd", convert2density = TRUE, area = "SqKm") +
  tm_shape(ma_tracts_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
   tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  tm_layout(title = "MA Low Income\nPersons\nin Highest\nTransportation\nCost Burden\nBlock Groups", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_HiBurdenMAINC.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_HiBurdenMAINC.png")
```

```{r tabHiBurdenMAINC, fig.align = "center", fig.cap="Low income persons, as defined by state environmental justice policy, by municipality in Census Block Groups with the highest transportation cost burden (i.e., transportation cost burden in the 80th percentile for the state)."}
HiBurden %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `MA Low Income` = sum(MA_LOWINC,na.rm = TRUE),
            `Pct of MA Low Income` = round(sum(MA_LOWINC)/max(TotalMA_LOWINC)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  mutate(`Pct of MA Low Income` = if_else(`Pct of MA Low Income` > 100, 100,`Pct of MA Low Income`)) %>% 
  mutate(`Pct of MA Low Income` = paste0(`Pct of MA Low Income`,"%")) %>% 
  arrange(desc(`MA Low Income`)) %>% 
  filter(`MA Low Income` > 0) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "MA Low Income in Highest Transportation Cost Burden Block Groups", align = "r", col.names = c(names(.)[1:2],"Number of MA Low Income in Block Groups","Pct of MA Low Income in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped"))
```

```{r mapHiBurdenMAMIN, fig.align = "center", fig.cap="Minority persons, as defined by state environmental justice policy, per square kilometer in Census Block Groups with the highest transportation cost burden (i.e., transportation cost burden in the 80th percentile for the state)."}
m <- tm_shape(ma_state_sf_cb, unit = "mi") + 
  tm_fill(col = "gray",alpha = 0.2) +
  tm_shape(HiBurden, unit = "mi") +
  tm_fill(col = "MA_MINORITY", alpha = 0.9, style = "equal",
          colorNA = "white", colorNULL = "gray", title = "MA Minority\nPersons\nPer Square Kilometer",
          legend.format = list(fun = function(x) formatC(x, digits = 0, format = "f")), palette = "OrRd", convert2density = TRUE, area = "SqKm") +
  tm_shape(ma_tracts_sf) + tm_borders(alpha = 0.5, lwd = 0.2) +
  tm_shape(ne_states_sf_cb) + tm_borders(lwd = 0.2, alpha = 0.8) + 
  tm_text("STUSPS", size = 0.7, remove.overlap = TRUE, col = "gray") +
   tm_shape(ma_highways) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(ma_highways2nd) + tm_lines(col = "seashell4", lwd = 1) +
  tm_shape(I95roadSegment) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I95roadSegment2) +
  tm_symbols(shape = I95, border.lwd = NA, size = .1) +
  tm_shape(I395roadSegment) +
  tm_symbols(shape = I395, border.lwd = NA, size = .1) +
  tm_shape(I91roadSegment) +
  tm_symbols(shape = I91, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment2) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I495roadSegment3) +
  tm_symbols(shape = I495, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(I90roadSegment2) +
  tm_symbols(shape = I90, border.lwd = NA, size = .1) +
  tm_shape(ma_towns_sf_pts) + tm_dots() +
  tm_text("NAME", size = 0.5, col = "black", 
          xmod = 0.7, ymod = 0.2, shadow = TRUE) +
  tm_scale_bar(breaks = c(0, 10, 20), text.size = 0.5, 
               position = c(0.6,0.005)) +
  tm_layout(title = "MA Minority\nPersons\nin Highest\nTransportation\nCost Burden\nBlock Groups", 
            frame = FALSE, main.title.size = 0.8,
            legend.outside = TRUE,
            legend.title.size = 0.8,
            legend.outside.position = c("right", "top"))

tmap_save(m, "DATA/transport/MA/figures/ma_HiBurdenMAMIN.png",
          height = 4, width = 8, units = "in", dpi = 600)

knitr::include_graphics("DATA/transport/MA/figures/ma_HiBurdenMAMIN.png")
```

```{r tabHiBurdenMAMIN, fig.align = "center", fig.cap="Minority persons, as defined by state environmental justice policy, by municipality in Census Block Groups with the highest transportation cost burden (i.e., transportation cost burden in the 80th percentile for the state)."}
HiBurden %>%
  st_centroid(.) %>% 
  st_intersection(ma_towns_sf,.) %>% 
  as.data.frame() %>% 
  left_join(., townpopsdf,by="NAME") %>%
  group_by(NAME) %>%
  summarize(`Block Groups` = n(),
            `MA Minority` = sum(MA_MINORITY,na.rm = TRUE),
            `Pct of MA Minority` = round(sum(MA_MINORITY)/max(TotalMA_MINORITY)*100,1)) %>% 
  rename("City/Town" = NAME) %>% 
  mutate(`Pct of MA Minority` = if_else(`Pct of MA Minority` > 100, 100,`Pct of MA Minority`)) %>% 
  mutate(`Pct of MA Minority` = paste0(`Pct of MA Minority`,"%")) %>% 
  arrange(desc(`MA Minority`)) %>% 
  filter(`MA Minority` > 0) %>% 
  kableExtra::kable(longtable = T, booktabs = T,
                    format.args = list(big.mark = ','), 
                    digits = 1,
                    caption = "MA Minority in Highest Transportation Cost Burden Block Groups", align = "r", col.names = c(names(.)[1:2],"Number of MA Minority in Block Groups","Pct of MA Minority in City/Town")) %>% 
  kableExtra::column_spec(3:4, width = "4cm") %>%
  kableExtra::kable_styling(latex_options = c("repeat_header","striped"))
```


Note that no groups of limited English speaking households, as defined by the state's environmental justice policy, were classified as highest transportation cost burden communities. 







